<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>抓包分析 TLS 1.2 连接过程 | Mind in the Wind</title>
<meta name=keywords content="tls"><meta name=description content="本文是《Traffic Analysis of an SSL/TLS Session》的笔记，原文见此处。
在 TLS 协议格式 中详细分析了协议数据的各个字段，
现在就来实战 ——用 Wireshark 抓包并观察数据。
第一发（Client -> Server）
 Full contents of the packet

 0000   02 00 00 00 45 00 00 98 13 ed 40 00 40 06 00 00  ....E.....@.@...
 0010   7f 00 00 01 7f 00 00 01 ec 26 01 bb 43 7c ee 74  .........&..C|.t
 0020   60 b5 50 0a 80 18 31 d7 fe 8c 00 00 01 01 08 0a  `.P...1.........
 0030   21 62 1e 1e 21 62 1e 1e 16 03 01 00 5f 01 00 00  !b..!b......_...
 0040   5b 03 01 54 9a ab 72 98 65 11 2f da 9e cf c9 db  [..T..r.e./.....
 0050   6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f 38 66 e7  l.KLVK..h+.`.8f.
 0060   87 46 b2 00 00 2e 00 39 00 38 00 35 00 16 00 13  .F.....9.8.5....
 0070   00 0a 00 33 00 32 00 2f 00 9a 00 99 00 96 00 05  ...3.2./........
 0080   00 04 00 15 00 12 00 09 00 14 00 11 00 08 00 06  ................
 0090   00 03 00 ff 01 00 00 04 00 23 00 00              .........#..

 ------------

 Family: IP

 0000   02 00 00 00                                      ....

 IP protocol    <--- IP协议首部 20 个字节，无“选项”字段。

 0000   45 00 00 98 13 ed 40 00 40 06 00 00 7f 00 00 01  E.....@.@.......
 0010   7f 00 00 01                                      ....

 TCP protocol  <-- TCP 协议首部标准的为 20 个字节，这里一共32个字节，说明有“选项”字段。 

 0000   ec 26 01 bb 43 7c ee 74 60 b5 50 0a 80 18 31 d7  .&..C|.t`.P...1.
 0010   fe 8c 00 00 01 01 08 0a 21 62 1e 1e 21 62 1e 1e  ........!b..!b..

 ------------

 TLSv1 protocol

 0000   16 03 01 00 5f 01 00 00 5b 03 01 54 9a ab 72 98  ...._...[..T..r.
 0010   65 11 2f da 9e cf c9 db 6c bd 4b 4c 56 4b 0c a5  e./.....l.KLVK..
 0020   68 2b aa 60 1f 38 66 e7 87 46 b2 00 00 2e 00 39  h+.`.8f..F.....9
 0030   00 38 00 35 00 16 00 13 00 0a 00 33 00 32 00 2f  .8.5.......3.2./
 0040   00 9a 00 99 00 96 00 05 00 04 00 15 00 12 00 09  ................
 0050   00 14 00 11 00 08 00 06 00 03 00 ff 01 00 00 04  ................
 0060   00 23 00 00                                      .#..

 TLSv1 Record protocol

 0000   16 03 01 00 5f                                   ...._

        16             Handshake protocol type
        03 01          SSL version (TLS 1.0)
        00 5f          Record length (95 bytes)

 TLSv1 Handshake protocol

 0000   01 00 00 5b 03 01 54 9a ab 72 98 65 11 2f da 9e  ...[..T..r.e./..
 0010   cf c9 db 6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f  ...l.KLVK..h+.`.
 0020   38 66 e7 87 46 b2 00 00 2e 00 39 00 38 00 35 00  8f..F.....9.8.5.
 0030   16 00 13 00 0a 00 33 00 32 00 2f 00 9a 00 99 00  ......3.2./.....
 0040   96 00 05 00 04 00 15 00 12 00 09 00 14 00 11 00  ................
 0050   08 00 06 00 03 00 ff 01 00 00 04 00 23 00 00     ............#..

        01             ClientHello message type
        00 00 5b       Message length           <---- 这里消息长度为3字节，大于记录协议的2字节，
		                                              也就是说，一个记录块放不下可以放到下一个？
        03 01          SSL version (TLS 1.0)
        54 .. b2       32-bytes random number
        00             Session Id length
        00 2e          Cipher Suites length (46 bytes, 23 suites)
        00 39 .. ff    23 2-byte Cipher Suite Id numbers
        01             Compression methods length (1 byte)
        00             Compression method (null)
        00 04          Extensions length (4 bytes)
        00 23          SessionTicket TLS extension Id
        00 00          Extension data length (0)
第二发（Server -> Client）
这个例子中，服务端发送了三种消息，ServerHello，Certificate，ServerHelloDone。这是一种最简单的方式，服务端没有要求验证客户端证书。"><meta name=author content="Me"><link rel=canonical href=https://runzhen.github.io/posts/tls2-packets/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.103f87022495ee8537d399aa50bf7e2203f4c653b709467478c7fd5a58182364.css integrity="sha256-ED+HAiSV7oU305mqUL9+IgP0xlO3CUZ0eMf9WlgYI2Q=" rel="preload stylesheet" as=style><link rel=icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://runzhen.github.io/posts/tls2-packets/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="抓包分析 TLS 1.2 连接过程"><meta property="og:description" content="本文是《Traffic Analysis of an SSL/TLS Session》的笔记，原文见此处。
在 TLS 协议格式 中详细分析了协议数据的各个字段，
现在就来实战 ——用 Wireshark 抓包并观察数据。
第一发（Client -> Server）
 Full contents of the packet

 0000   02 00 00 00 45 00 00 98 13 ed 40 00 40 06 00 00  ....E.....@.@...
 0010   7f 00 00 01 7f 00 00 01 ec 26 01 bb 43 7c ee 74  .........&..C|.t
 0020   60 b5 50 0a 80 18 31 d7 fe 8c 00 00 01 01 08 0a  `.P...1.........
 0030   21 62 1e 1e 21 62 1e 1e 16 03 01 00 5f 01 00 00  !b..!b......_...
 0040   5b 03 01 54 9a ab 72 98 65 11 2f da 9e cf c9 db  [..T..r.e./.....
 0050   6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f 38 66 e7  l.KLVK..h+.`.8f.
 0060   87 46 b2 00 00 2e 00 39 00 38 00 35 00 16 00 13  .F.....9.8.5....
 0070   00 0a 00 33 00 32 00 2f 00 9a 00 99 00 96 00 05  ...3.2./........
 0080   00 04 00 15 00 12 00 09 00 14 00 11 00 08 00 06  ................
 0090   00 03 00 ff 01 00 00 04 00 23 00 00              .........#..

 ------------

 Family: IP

 0000   02 00 00 00                                      ....

 IP protocol    <--- IP协议首部 20 个字节，无“选项”字段。

 0000   45 00 00 98 13 ed 40 00 40 06 00 00 7f 00 00 01  E.....@.@.......
 0010   7f 00 00 01                                      ....

 TCP protocol  <-- TCP 协议首部标准的为 20 个字节，这里一共32个字节，说明有“选项”字段。 

 0000   ec 26 01 bb 43 7c ee 74 60 b5 50 0a 80 18 31 d7  .&..C|.t`.P...1.
 0010   fe 8c 00 00 01 01 08 0a 21 62 1e 1e 21 62 1e 1e  ........!b..!b..

 ------------

 TLSv1 protocol

 0000   16 03 01 00 5f 01 00 00 5b 03 01 54 9a ab 72 98  ...._...[..T..r.
 0010   65 11 2f da 9e cf c9 db 6c bd 4b 4c 56 4b 0c a5  e./.....l.KLVK..
 0020   68 2b aa 60 1f 38 66 e7 87 46 b2 00 00 2e 00 39  h+.`.8f..F.....9
 0030   00 38 00 35 00 16 00 13 00 0a 00 33 00 32 00 2f  .8.5.......3.2./
 0040   00 9a 00 99 00 96 00 05 00 04 00 15 00 12 00 09  ................
 0050   00 14 00 11 00 08 00 06 00 03 00 ff 01 00 00 04  ................
 0060   00 23 00 00                                      .#..

 TLSv1 Record protocol

 0000   16 03 01 00 5f                                   ...._

        16             Handshake protocol type
        03 01          SSL version (TLS 1.0)
        00 5f          Record length (95 bytes)

 TLSv1 Handshake protocol

 0000   01 00 00 5b 03 01 54 9a ab 72 98 65 11 2f da 9e  ...[..T..r.e./..
 0010   cf c9 db 6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f  ...l.KLVK..h+.`.
 0020   38 66 e7 87 46 b2 00 00 2e 00 39 00 38 00 35 00  8f..F.....9.8.5.
 0030   16 00 13 00 0a 00 33 00 32 00 2f 00 9a 00 99 00  ......3.2./.....
 0040   96 00 05 00 04 00 15 00 12 00 09 00 14 00 11 00  ................
 0050   08 00 06 00 03 00 ff 01 00 00 04 00 23 00 00     ............#..

        01             ClientHello message type
        00 00 5b       Message length           <---- 这里消息长度为3字节，大于记录协议的2字节，
		                                              也就是说，一个记录块放不下可以放到下一个？
        03 01          SSL version (TLS 1.0)
        54 .. b2       32-bytes random number
        00             Session Id length
        00 2e          Cipher Suites length (46 bytes, 23 suites)
        00 39 .. ff    23 2-byte Cipher Suite Id numbers
        01             Compression methods length (1 byte)
        00             Compression method (null)
        00 04          Extensions length (4 bytes)
        00 23          SessionTicket TLS extension Id
        00 00          Extension data length (0)
第二发（Server -> Client）
这个例子中，服务端发送了三种消息，ServerHello，Certificate，ServerHelloDone。这是一种最简单的方式，服务端没有要求验证客户端证书。"><meta property="og:type" content="article"><meta property="og:url" content="https://runzhen.github.io/posts/tls2-packets/"><meta property="og:image" content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-06-19T00:00:00+00:00"><meta property="article:modified_time" content="2016-06-19T00:00:00+00:00"><meta property="og:site_name" content="Mind in the Wind"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="抓包分析 TLS 1.2 连接过程"><meta name=twitter:description content="本文是《Traffic Analysis of an SSL/TLS Session》的笔记，原文见此处。
在 TLS 协议格式 中详细分析了协议数据的各个字段，
现在就来实战 ——用 Wireshark 抓包并观察数据。
第一发（Client -> Server）
 Full contents of the packet

 0000   02 00 00 00 45 00 00 98 13 ed 40 00 40 06 00 00  ....E.....@.@...
 0010   7f 00 00 01 7f 00 00 01 ec 26 01 bb 43 7c ee 74  .........&..C|.t
 0020   60 b5 50 0a 80 18 31 d7 fe 8c 00 00 01 01 08 0a  `.P...1.........
 0030   21 62 1e 1e 21 62 1e 1e 16 03 01 00 5f 01 00 00  !b..!b......_...
 0040   5b 03 01 54 9a ab 72 98 65 11 2f da 9e cf c9 db  [..T..r.e./.....
 0050   6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f 38 66 e7  l.KLVK..h+.`.8f.
 0060   87 46 b2 00 00 2e 00 39 00 38 00 35 00 16 00 13  .F.....9.8.5....
 0070   00 0a 00 33 00 32 00 2f 00 9a 00 99 00 96 00 05  ...3.2./........
 0080   00 04 00 15 00 12 00 09 00 14 00 11 00 08 00 06  ................
 0090   00 03 00 ff 01 00 00 04 00 23 00 00              .........#..

 ------------

 Family: IP

 0000   02 00 00 00                                      ....

 IP protocol    <--- IP协议首部 20 个字节，无“选项”字段。

 0000   45 00 00 98 13 ed 40 00 40 06 00 00 7f 00 00 01  E.....@.@.......
 0010   7f 00 00 01                                      ....

 TCP protocol  <-- TCP 协议首部标准的为 20 个字节，这里一共32个字节，说明有“选项”字段。 

 0000   ec 26 01 bb 43 7c ee 74 60 b5 50 0a 80 18 31 d7  .&..C|.t`.P...1.
 0010   fe 8c 00 00 01 01 08 0a 21 62 1e 1e 21 62 1e 1e  ........!b..!b..

 ------------

 TLSv1 protocol

 0000   16 03 01 00 5f 01 00 00 5b 03 01 54 9a ab 72 98  ...._...[..T..r.
 0010   65 11 2f da 9e cf c9 db 6c bd 4b 4c 56 4b 0c a5  e./.....l.KLVK..
 0020   68 2b aa 60 1f 38 66 e7 87 46 b2 00 00 2e 00 39  h+.`.8f..F.....9
 0030   00 38 00 35 00 16 00 13 00 0a 00 33 00 32 00 2f  .8.5.......3.2./
 0040   00 9a 00 99 00 96 00 05 00 04 00 15 00 12 00 09  ................
 0050   00 14 00 11 00 08 00 06 00 03 00 ff 01 00 00 04  ................
 0060   00 23 00 00                                      .#..

 TLSv1 Record protocol

 0000   16 03 01 00 5f                                   ...._

        16             Handshake protocol type
        03 01          SSL version (TLS 1.0)
        00 5f          Record length (95 bytes)

 TLSv1 Handshake protocol

 0000   01 00 00 5b 03 01 54 9a ab 72 98 65 11 2f da 9e  ...[..T..r.e./..
 0010   cf c9 db 6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f  ...l.KLVK..h+.`.
 0020   38 66 e7 87 46 b2 00 00 2e 00 39 00 38 00 35 00  8f..F.....9.8.5.
 0030   16 00 13 00 0a 00 33 00 32 00 2f 00 9a 00 99 00  ......3.2./.....
 0040   96 00 05 00 04 00 15 00 12 00 09 00 14 00 11 00  ................
 0050   08 00 06 00 03 00 ff 01 00 00 04 00 23 00 00     ............#..

        01             ClientHello message type
        00 00 5b       Message length           <---- 这里消息长度为3字节，大于记录协议的2字节，
		                                              也就是说，一个记录块放不下可以放到下一个？
        03 01          SSL version (TLS 1.0)
        54 .. b2       32-bytes random number
        00             Session Id length
        00 2e          Cipher Suites length (46 bytes, 23 suites)
        00 39 .. ff    23 2-byte Cipher Suite Id numbers
        01             Compression methods length (1 byte)
        00             Compression method (null)
        00 04          Extensions length (4 bytes)
        00 23          SessionTicket TLS extension Id
        00 00          Extension data length (0)
第二发（Server -> Client）
这个例子中，服务端发送了三种消息，ServerHello，Certificate，ServerHelloDone。这是一种最简单的方式，服务端没有要求验证客户端证书。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://runzhen.github.io/posts/"},{"@type":"ListItem","position":2,"name":"抓包分析 TLS 1.2 连接过程","item":"https://runzhen.github.io/posts/tls2-packets/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"抓包分析 TLS 1.2 连接过程","name":"抓包分析 TLS 1.2 连接过程","description":"本文是《Traffic Analysis of an SSL/TLS Session》的笔记，原文见此处。\n在 TLS 协议格式 中详细分析了协议数据的各个字段， 现在就来实战 ——用 Wireshark 抓包并观察数据。\n第一发（Client -\u0026gt; Server） Full contents of the packet\r0000 02 00 00 00 45 00 00 98 13 ed 40 00 40 06 00 00 ....E.....@.@...\r0010 7f 00 00 01 7f 00 00 01 ec 26 01 bb 43 7c ee 74 .........\u0026amp;..C|.t\r0020 60 b5 50 0a 80 18 31 d7 fe 8c 00 00 01 01 08 0a `.P...1.........\r0030 21 62 1e 1e 21 62 1e 1e 16 03 01 00 5f 01 00 00 !b..!b......_...\r0040 5b 03 01 54 9a ab 72 98 65 11 2f da 9e cf c9 db [..T..r.e./.....\r0050 6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f 38 66 e7 l.KLVK..h+.`.8f.\r0060 87 46 b2 00 00 2e 00 39 00 38 00 35 00 16 00 13 .F.....9.8.5....\r0070 00 0a 00 33 00 32 00 2f 00 9a 00 99 00 96 00 05 ...3.2./........\r0080 00 04 00 15 00 12 00 09 00 14 00 11 00 08 00 06 ................\r0090 00 03 00 ff 01 00 00 04 00 23 00 00 .........#..\r------------\rFamily: IP\r0000 02 00 00 00 ....\rIP protocol \u0026lt;--- IP协议首部 20 个字节，无“选项”字段。\r0000 45 00 00 98 13 ed 40 00 40 06 00 00 7f 00 00 01 E.....@.@.......\r0010 7f 00 00 01 ....\rTCP protocol \u0026lt;-- TCP 协议首部标准的为 20 个字节，这里一共32个字节，说明有“选项”字段。 0000 ec 26 01 bb 43 7c ee 74 60 b5 50 0a 80 18 31 d7 .\u0026amp;..C|.t`.P...1.\r0010 fe 8c 00 00 01 01 08 0a 21 62 1e 1e 21 62 1e 1e ........!b..!b..\r------------\rTLSv1 protocol\r0000 16 03 01 00 5f 01 00 00 5b 03 01 54 9a ab 72 98 ...._...[..T..r.\r0010 65 11 2f da 9e cf c9 db 6c bd 4b 4c 56 4b 0c a5 e./.....l.KLVK..\r0020 68 2b aa 60 1f 38 66 e7 87 46 b2 00 00 2e 00 39 h+.`.8f..F.....9\r0030 00 38 00 35 00 16 00 13 00 0a 00 33 00 32 00 2f .8.5.......3.2./\r0040 00 9a 00 99 00 96 00 05 00 04 00 15 00 12 00 09 ................\r0050 00 14 00 11 00 08 00 06 00 03 00 ff 01 00 00 04 ................\r0060 00 23 00 00 .#..\rTLSv1 Record protocol\r0000 16 03 01 00 5f ...._\r16 Handshake protocol type\r03 01 SSL version (TLS 1.0)\r00 5f Record length (95 bytes)\rTLSv1 Handshake protocol\r0000 01 00 00 5b 03 01 54 9a ab 72 98 65 11 2f da 9e ...[..T..r.e./..\r0010 cf c9 db 6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f ...l.KLVK..h+.`.\r0020 38 66 e7 87 46 b2 00 00 2e 00 39 00 38 00 35 00 8f..F.....9.8.5.\r0030 16 00 13 00 0a 00 33 00 32 00 2f 00 9a 00 99 00 ......3.2./.....\r0040 96 00 05 00 04 00 15 00 12 00 09 00 14 00 11 00 ................\r0050 08 00 06 00 03 00 ff 01 00 00 04 00 23 00 00 ............#..\r01 ClientHello message type\r00 00 5b Message length \u0026lt;---- 这里消息长度为3字节，大于记录协议的2字节，\r也就是说，一个记录块放不下可以放到下一个？\r03 01 SSL version (TLS 1.0)\r54 .. b2 32-bytes random number\r00 Session Id length\r00 2e Cipher Suites length (46 bytes, 23 suites)\r00 39 .. ff 23 2-byte Cipher Suite Id numbers\r01 Compression methods length (1 byte)\r00 Compression method (null)\r00 04 Extensions length (4 bytes)\r00 23 SessionTicket TLS extension Id\r00 00 Extension data length (0) 第二发（Server -\u0026gt; Client） 这个例子中，服务端发送了三种消息，ServerHello，Certificate，ServerHelloDone。这是一种最简单的方式，服务端没有要求验证客户端证书。\n","keywords":["tls"],"articleBody":"本文是《Traffic Analysis of an SSL/TLS Session》的笔记，原文见此处。\n在 TLS 协议格式 中详细分析了协议数据的各个字段， 现在就来实战 ——用 Wireshark 抓包并观察数据。\n第一发（Client -\u003e Server） Full contents of the packet\r0000 02 00 00 00 45 00 00 98 13 ed 40 00 40 06 00 00 ....E.....@.@...\r0010 7f 00 00 01 7f 00 00 01 ec 26 01 bb 43 7c ee 74 .........\u0026..C|.t\r0020 60 b5 50 0a 80 18 31 d7 fe 8c 00 00 01 01 08 0a `.P...1.........\r0030 21 62 1e 1e 21 62 1e 1e 16 03 01 00 5f 01 00 00 !b..!b......_...\r0040 5b 03 01 54 9a ab 72 98 65 11 2f da 9e cf c9 db [..T..r.e./.....\r0050 6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f 38 66 e7 l.KLVK..h+.`.8f.\r0060 87 46 b2 00 00 2e 00 39 00 38 00 35 00 16 00 13 .F.....9.8.5....\r0070 00 0a 00 33 00 32 00 2f 00 9a 00 99 00 96 00 05 ...3.2./........\r0080 00 04 00 15 00 12 00 09 00 14 00 11 00 08 00 06 ................\r0090 00 03 00 ff 01 00 00 04 00 23 00 00 .........#..\r------------\rFamily: IP\r0000 02 00 00 00 ....\rIP protocol \u003c--- IP协议首部 20 个字节，无“选项”字段。\r0000 45 00 00 98 13 ed 40 00 40 06 00 00 7f 00 00 01 E.....@.@.......\r0010 7f 00 00 01 ....\rTCP protocol \u003c-- TCP 协议首部标准的为 20 个字节，这里一共32个字节，说明有“选项”字段。 0000 ec 26 01 bb 43 7c ee 74 60 b5 50 0a 80 18 31 d7 .\u0026..C|.t`.P...1.\r0010 fe 8c 00 00 01 01 08 0a 21 62 1e 1e 21 62 1e 1e ........!b..!b..\r------------\rTLSv1 protocol\r0000 16 03 01 00 5f 01 00 00 5b 03 01 54 9a ab 72 98 ...._...[..T..r.\r0010 65 11 2f da 9e cf c9 db 6c bd 4b 4c 56 4b 0c a5 e./.....l.KLVK..\r0020 68 2b aa 60 1f 38 66 e7 87 46 b2 00 00 2e 00 39 h+.`.8f..F.....9\r0030 00 38 00 35 00 16 00 13 00 0a 00 33 00 32 00 2f .8.5.......3.2./\r0040 00 9a 00 99 00 96 00 05 00 04 00 15 00 12 00 09 ................\r0050 00 14 00 11 00 08 00 06 00 03 00 ff 01 00 00 04 ................\r0060 00 23 00 00 .#..\rTLSv1 Record protocol\r0000 16 03 01 00 5f ...._\r16 Handshake protocol type\r03 01 SSL version (TLS 1.0)\r00 5f Record length (95 bytes)\rTLSv1 Handshake protocol\r0000 01 00 00 5b 03 01 54 9a ab 72 98 65 11 2f da 9e ...[..T..r.e./..\r0010 cf c9 db 6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f ...l.KLVK..h+.`.\r0020 38 66 e7 87 46 b2 00 00 2e 00 39 00 38 00 35 00 8f..F.....9.8.5.\r0030 16 00 13 00 0a 00 33 00 32 00 2f 00 9a 00 99 00 ......3.2./.....\r0040 96 00 05 00 04 00 15 00 12 00 09 00 14 00 11 00 ................\r0050 08 00 06 00 03 00 ff 01 00 00 04 00 23 00 00 ............#..\r01 ClientHello message type\r00 00 5b Message length \u003c---- 这里消息长度为3字节，大于记录协议的2字节，\r也就是说，一个记录块放不下可以放到下一个？\r03 01 SSL version (TLS 1.0)\r54 .. b2 32-bytes random number\r00 Session Id length\r00 2e Cipher Suites length (46 bytes, 23 suites)\r00 39 .. ff 23 2-byte Cipher Suite Id numbers\r01 Compression methods length (1 byte)\r00 Compression method (null)\r00 04 Extensions length (4 bytes)\r00 23 SessionTicket TLS extension Id\r00 00 Extension data length (0) 第二发（Server -\u003e Client） 这个例子中，服务端发送了三种消息，ServerHello，Certificate，ServerHelloDone。这是一种最简单的方式，服务端没有要求验证客户端证书。\nServerHello message 0000 16 03 01 00 35 02 00 00 31 03 01 54 9a ab 72 85 ....5...1..T..r.\r0010 91 a4 a7 a9 27 fe 3d e4 da f6 38 a5 aa 6e 5a 2f ....'.=...8..nZ/\r0020 31 90 5b 41 b0 5d de d8 9d ae f6 00 00 35 00 00 1.[A.].......5..\r0030 09 ff 01 00 01 00 00 23 00 00 .......#..\r16 Handshake protocol type\r03 01 SSL version (TLS 1.0)\r35 Record length (53 bytes)\r02 ServerHello message type\r00 00 31 Message length (49 bytes)\r03 01 SSL version (TLS 1.0)\r54 9a ab 72 First 4 bytes of random (Unix time)\r85 .. f6 Last 28 bytes of the random number\r00 Session Id length\r00 35 Selected Cipher Suite (RSA with AES-256-CBC SHA)\r00 Selected compression method (null)\r00 09 Extensions length\rff 01 00 01 00 Extension (Renegotiation Info)\r00 23 00 00 Extension (SessionTicket TLS)\rCertificate message 0000 16 03 01 01 e4 0b 00 01 e0 00 01 dd 00 01 da 30 ...............0\r0010 82 01 d6 30 82 01 3f 02 01 01 30 0d 06 09 2a 86 ...0..?...0...*.\r0020 48 86 f7 0d 01 01 04 05 00 30 45 31 0b 30 09 06 H........0E1.0..\r0030 03 55 04 06 13 02 41 55 31 13 30 11 06 03 55 04 .U....AU1.0...U.\r0040 08 13 0a 53 6f 6d 65 2d 53 74 61 74 65 31 21 30 ...Some-State1!0\r0050 1f 06 03 55 04 0a 13 18 49 6e 74 65 72 6e 65 74 ...U....Internet\r0060 20 57 69 64 67 69 74 73 20 50 74 79 20 4c 74 64 Widgits Pty Ltd\r0070 30 1e 17 0d 39 39 30 35 30 31 30 31 32 36 33 35 0...990501012635\r0080 5a 17 0d 39 39 30 35 33 31 30 31 32 36 33 35 5a Z..990531012635Z\r0090 30 22 31 0b 30 09 06 03 55 04 06 13 02 44 45 31 0\"1.0...U....DE1\r00a0 13 30 11 06 03 55 04 03 13 0a 54 65 73 74 73 65 .0...U....Testse\r00b0 72 76 65 72 30 81 9f 30 0d 06 09 2a 86 48 86 f7 rver0..0...*.H..\r00c0 0d 01 01 01 05 00 03 81 8d 00 30 81 89 02 81 81 ..........0.....\r00d0 00 fa 23 7a 03 2a 27 b1 c3 09 64 ce 36 ab eb d0 ..#z.*'...d.6...\r00e0 08 16 75 54 68 6f 39 2e d0 9e 81 ed 91 f8 2b 48 ..uTho9.......+H\r00f0 0e 59 10 63 0e bc ff c3 1b 4f 7a 2e d2 97 45 01 .Y.c.....Oz...E.\r0100 c2 fd 20 68 98 63 76 34 48 73 3d 3e a1 74 d1 13 .. h.cv4Hs=\u003e.t..\r0110 b5 30 2b 4d a6 a4 e7 17 74 9c 2e 96 e6 82 01 a3 .0+M....t.......\r0120 2a 29 66 59 89 f6 6a 2e de 99 d8 cc 8d 75 4b b7 *)fY..j......uK.\r0130 35 96 db 11 a0 20 60 13 59 03 77 d8 a8 1f 26 78 5.... `.Y.w...\u0026x\r0140 38 8d 78 b5 52 31 22 c8 b8 64 c3 46 5f d4 8f e0 8.x.R1\"..d.F_...\r0150 83 02 03 01 00 01 30 0d 06 09 2a 86 48 86 f7 0d ......0...*.H...\r0160 01 01 04 05 00 03 81 81 00 c8 0c fa c6 c0 93 c0 ................\r0170 df 8d 27 da f9 17 f6 81 c1 97 99 ba ef 64 0c ca ..'..........d..\r0180 cc 2f b9 45 4d e4 6a af cd cb 12 17 00 67 28 f5 ./.EM.j......g(.\r0190 d6 63 a3 3c d6 7c df f1 b8 6b a9 e5 ba 05 93 e2 .c.\u003c.|...k......\r01a0 ab 3f ec 5d 82 c6 aa 18 7b 32 ce 58 04 a2 ac f8 .?.]....{2.X....\r01b0 7a 4a 8b 8d 07 95 6e 7a 23 df 7f 61 54 55 3d 32 zJ....nz#..aTU=2\r01c0 13 e2 e8 95 0b 3f 18 d7 2a e9 a3 7d 7d 8b 2c d9 .....?..*..}}.,.\r01d0 22 91 6e 69 bb 3f 03 7f 75 22 5f 41 22 68 9b dd \".ni.?..u\"_A\"h..\r01e0 ec 4c 0f f0 9e f9 b6 25 13 .L.....%.\r16 Handshake protocol type\r03 01 SSL version (TLS 1.0)\r01 e4 Record length (484 bytes)\r0b Certificate message type\r00 01 e0 Message length\r00 01 dd Certificates length\r00 .. 13 Certificates data\rServerHelloDone message\r0000 16 03 01 00 04 0e 00 00 00 .........\r16 Handshake protocol type\r03 01 SSL version (TLS 1.0)\r00 04 Record length (4 bytes)\r0e ServerHelloDone message\r00 00 00 Message length 第三发 （Client -\u003e Server) 在发送这条消息之前，客户端和服务器已经协商好了各种算法：Key Exchange 用 RSA， 对称加密用 AES-256-CBC ， 消息摘要用 SHA。TLS 的扩展字段有 SessionTicket TLS 和 Renegotiation Info。\n此时，客户端也拥有了服务器的证书链，可以验证是否信任这些证书。验证完毕之后，发送下面三种消息。\nClientKeyExchange message\r0000 16 03 01 00 86 10 00 00 82 00 80 2d 28 e4 30 eb ...........-(.0.\r0010 31 35 b0 4b 5e 4c 4d c6 ee 01 f5 33 e7 f8 3f 9b 15.K^LM....3..?.\r0020 d7 53 fc 5c e0 2d d6 12 ba 55 f8 46 ab 73 d8 3d .S.\\.-...U.F.s.=\r0030 b0 0a f7 03 7f 58 e0 32 8f 91 1f b8 cf 56 aa 89 .....X.2.....V..\r0040 9e 27 84 08 ec 78 f8 74 0c d3 80 f2 ec 04 65 e1 .'...x.t......e.\r0050 3e 92 91 52 b5 5e aa 67 e9 e6 40 e9 10 67 3c 3f \u003e..R.^.g..@..g\u003c?\r0060 73 f7 62 4a 0c 42 30 c1 06 6f 53 2f c2 6b d5 c8 s.bJ.B0..oS/.k..\r0070 67 6f 06 d7 92 86 6e 1d 4d dd 6b 3f b0 26 6c 25 go....n.M.k?.\u0026l%\r0080 2c d8 81 5a 80 e0 e2 cc d1 62 9c ,..Z.....b.\r16 Handshake protocol type\r03 01 SSL version (TLS 1.0)\r00 86 Record length (134 bytes)\r10 ClientKeyExchange message type\r00 00 82 Message length (130 bytes)\r00 .. 9c RSA encrypted key data (premaster secret) \u003c--- 这个用来干嘛？\rChangeCipherSpec message\r0000 14 03 01 00 01 01 ......\r14 ChangeCipherSpec protocol type\r03 01 SSL version (TLS 1.0)\r00 01 Message length (1 byte)\r01 ChangeCipherSpec message\rFinished message (encrypted)\r0000 16 03 01 00 30 0c c1 86 73 a4 a3 26 62 30 21 7f ....0...s..\u0026b0!.\r0010 c3 2f 1a 83 34 2d 57 f0 e2 0d 37 d4 51 66 08 22 ./..4-W...7.Qf.\"\r0020 b0 ea b4 a4 1e 81 2a fd 5f 07 47 9f b7 2c 0a dc ......*._.G..,..\r0030 65 08 77 40 2a e.w@*\r16 Handshake protocol type\r03 01 SSL version (TLS 1.0)\r00 30 Message length (48 bytes)\r0c .. 2a Encrypted Finished message 第四发 （Server -\u003e Client） 服务端在接收到客户端发来的 ChangeCipherSpec 和 Finished 之后，也要发送自己的 ChangeCipherSpec 和 Finished 消息，这样握手过程才算结束。 对于报文中的 NewSessionTicket 消息，这是 TLS 的一个扩展，具体可参见 RFC5077。\nNewSessionTicket message\r0000 16 03 01 00 aa 04 00 00 a6 00 00 00 00 00 a0 f7 ................\r0010 2f 0c fd be ce f7 96 86 ca fd da 58 d6 16 b3 3c /..........X...\u003c\r0020 89 1a a5 a2 af 3c 80 50 7b 99 71 05 3b 0e d3 27 .....\u003c.P{.q.;..'\r0030 75 78 0d 0a 20 6c e7 1c ce 7b 5d 52 ad f1 04 88 ux.. l...{]R....\r0040 ec fa 04 c9 6a 74 fc 7b 3d 99 aa 8a ec 7a a3 18 ....jt.{=....z..\r0050 81 63 2f db b0 16 5b 49 63 f4 53 bc 57 18 27 37 .c/...[Ic.S.W.'7\r0060 f2 7f 66 e6 4d 46 59 2d 17 39 d5 79 a4 49 4d 93 ..f.MFY-.9.y.IM.\r0070 d2 80 34 8b 49 f5 31 72 7f 7b 41 46 37 9b ae a9 ..4.I.1r.{AF7...\r0080 3c f0 6f 2e 7f 75 e3 bf 2f d8 fc a4 be cb 2c 84 \u003c.o..u../.....,.\r0090 01 b2 25 01 23 91 6e c0 c1 09 9d 42 c8 b8 e6 1b ..%.#.n....B....\r00a0 fe 1e ed b3 52 7f 25 90 ae fc 34 f5 96 1b f0 ....R.%...4....\r16 Handshake protocol type\r03 01 SSL version (TLS 1.0)\raa 04 Message length (170 bytes)\r04 New Session Ticket message type (extension)\r00 00 a6 Message length (166 bytes)\r00 .. f0 Session Ticket data\rChangeCipherSpec message\r0000 14 03 01 00 01 01 ......\r14 ChangeCipherSpec protocol type\r03 01 SSL version (TLS 1.0)\r00 01 Message length\r01 ChangeCipherSpec message\rFinished message (encrypted)\r0000 16 03 01 00 30 6d 09 0e 9f dd 09 03 2f 84 65 f8 ....0m....../.e.\r0010 94 0f d6 7b 4b 54 31 a1 25 a4 27 03 ae c3 4e af ...{KT1.%.'...N.\r0020 27 04 32 5a 1f 29 90 fa 0a 4b 89 2f af d8 88 99 '.2Z.)...K./....\r0030 41 de dd 89 3f A...?\r16 Handshake protocol type\r03 01 SSL version (TLS 1.0)\r00 30 Message length (48 bytes)\r6d .. 3f Encrypted Finished message 最后 握手成功之后，客户端和服务端就开始加密传输 TLS 之上的协议发来的数据了。\n","wordCount":"2103","inLanguage":"en","image":"https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2016-06-19T00:00:00Z","dateModified":"2016-06-19T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://runzhen.github.io/posts/tls2-packets/"},"publisher":{"@type":"Organization","name":"Mind in the Wind","logo":{"@type":"ImageObject","url":"https://runzhen.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://runzhen.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://runzhen.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://runzhen.github.io/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://runzhen.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://runzhen.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://runzhen.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">抓包分析 TLS 1.2 连接过程</h1><div class=post-meta><span title='2016-06-19 00:00:00 +0000 UTC'>2016-06-19</span>&nbsp;·&nbsp;Me</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%ac%ac%e4%b8%80%e5%8f%91client---server aria-label="第一发（Client -> Server）">第一发（Client -> Server）</a></li><li><a href=#%e7%ac%ac%e4%ba%8c%e5%8f%91server---client aria-label="第二发（Server -> Client）">第二发（Server -> Client）</a></li><li><a href=#%e7%ac%ac%e4%b8%89%e5%8f%91-client---server aria-label="第三发 （Client -> Server)">第三发 （Client -> Server)</a></li><li><a href=#%e7%ac%ac%e5%9b%9b%e5%8f%91-server---client aria-label="第四发 （Server -> Client）">第四发 （Server -> Client）</a></li><li><a href=#%e6%9c%80%e5%90%8e aria-label=最后>最后</a></li></ul></div></details></div><div class=post-content><p>本文是《Traffic Analysis of an SSL/TLS Session》的笔记，原文见<a href=http://blog.fourthbit.com/2014/12/23/traffic-analysis-of-an-ssl-slash-tls-session>此处</a>。</p><p>在 <a href=/2016/06/tls/>TLS 协议格式</a> 中详细分析了协议数据的各个字段，
现在就来实战 ——用 Wireshark 抓包并观察数据。</p><h1 id=第一发client---server>第一发（Client -> Server）<a hidden class=anchor aria-hidden=true href=#第一发client---server>#</a></h1><pre tabindex=0><code> Full contents of the packet

 0000   02 00 00 00 45 00 00 98 13 ed 40 00 40 06 00 00  ....E.....@.@...
 0010   7f 00 00 01 7f 00 00 01 ec 26 01 bb 43 7c ee 74  .........&amp;..C|.t
 0020   60 b5 50 0a 80 18 31 d7 fe 8c 00 00 01 01 08 0a  `.P...1.........
 0030   21 62 1e 1e 21 62 1e 1e 16 03 01 00 5f 01 00 00  !b..!b......_...
 0040   5b 03 01 54 9a ab 72 98 65 11 2f da 9e cf c9 db  [..T..r.e./.....
 0050   6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f 38 66 e7  l.KLVK..h+.`.8f.
 0060   87 46 b2 00 00 2e 00 39 00 38 00 35 00 16 00 13  .F.....9.8.5....
 0070   00 0a 00 33 00 32 00 2f 00 9a 00 99 00 96 00 05  ...3.2./........
 0080   00 04 00 15 00 12 00 09 00 14 00 11 00 08 00 06  ................
 0090   00 03 00 ff 01 00 00 04 00 23 00 00              .........#..

 ------------

 Family: IP

 0000   02 00 00 00                                      ....

 IP protocol    &lt;--- IP协议首部 20 个字节，无“选项”字段。

 0000   45 00 00 98 13 ed 40 00 40 06 00 00 7f 00 00 01  E.....@.@.......
 0010   7f 00 00 01                                      ....

 TCP protocol  &lt;-- TCP 协议首部标准的为 20 个字节，这里一共32个字节，说明有“选项”字段。 

 0000   ec 26 01 bb 43 7c ee 74 60 b5 50 0a 80 18 31 d7  .&amp;..C|.t`.P...1.
 0010   fe 8c 00 00 01 01 08 0a 21 62 1e 1e 21 62 1e 1e  ........!b..!b..

 ------------

 TLSv1 protocol

 0000   16 03 01 00 5f 01 00 00 5b 03 01 54 9a ab 72 98  ...._...[..T..r.
 0010   65 11 2f da 9e cf c9 db 6c bd 4b 4c 56 4b 0c a5  e./.....l.KLVK..
 0020   68 2b aa 60 1f 38 66 e7 87 46 b2 00 00 2e 00 39  h+.`.8f..F.....9
 0030   00 38 00 35 00 16 00 13 00 0a 00 33 00 32 00 2f  .8.5.......3.2./
 0040   00 9a 00 99 00 96 00 05 00 04 00 15 00 12 00 09  ................
 0050   00 14 00 11 00 08 00 06 00 03 00 ff 01 00 00 04  ................
 0060   00 23 00 00                                      .#..

 TLSv1 Record protocol

 0000   16 03 01 00 5f                                   ...._

        16             Handshake protocol type
        03 01          SSL version (TLS 1.0)
        00 5f          Record length (95 bytes)

 TLSv1 Handshake protocol

 0000   01 00 00 5b 03 01 54 9a ab 72 98 65 11 2f da 9e  ...[..T..r.e./..
 0010   cf c9 db 6c bd 4b 4c 56 4b 0c a5 68 2b aa 60 1f  ...l.KLVK..h+.`.
 0020   38 66 e7 87 46 b2 00 00 2e 00 39 00 38 00 35 00  8f..F.....9.8.5.
 0030   16 00 13 00 0a 00 33 00 32 00 2f 00 9a 00 99 00  ......3.2./.....
 0040   96 00 05 00 04 00 15 00 12 00 09 00 14 00 11 00  ................
 0050   08 00 06 00 03 00 ff 01 00 00 04 00 23 00 00     ............#..

        01             ClientHello message type
        00 00 5b       Message length           &lt;---- 这里消息长度为3字节，大于记录协议的2字节，
		                                              也就是说，一个记录块放不下可以放到下一个？
        03 01          SSL version (TLS 1.0)
        54 .. b2       32-bytes random number
        00             Session Id length
        00 2e          Cipher Suites length (46 bytes, 23 suites)
        00 39 .. ff    23 2-byte Cipher Suite Id numbers
        01             Compression methods length (1 byte)
        00             Compression method (null)
        00 04          Extensions length (4 bytes)
        00 23          SessionTicket TLS extension Id
        00 00          Extension data length (0)
</code></pre><h1 id=第二发server---client>第二发（Server -> Client）<a hidden class=anchor aria-hidden=true href=#第二发server---client>#</a></h1><p>这个例子中，服务端发送了三种消息，ServerHello，Certificate，ServerHelloDone。这是一种最简单的方式，服务端没有要求验证客户端证书。</p><pre tabindex=0><code>ServerHello message    

0000   16 03 01 00 35 02 00 00 31 03 01 54 9a ab 72 85  ....5...1..T..r.
0010   91 a4 a7 a9 27 fe 3d e4 da f6 38 a5 aa 6e 5a 2f  ....&#39;.=...8..nZ/
0020   31 90 5b 41 b0 5d de d8 9d ae f6 00 00 35 00 00  1.[A.].......5..
0030   09 ff 01 00 01 00 00 23 00 00                    .......#..

       16             Handshake protocol type
       03 01          SSL version (TLS 1.0)
       35             Record length (53 bytes)

       02             ServerHello message type
       00 00 31       Message length (49 bytes)
       03 01          SSL version (TLS 1.0)
       54 9a ab 72    First 4 bytes of random (Unix time)
       85 .. f6       Last 28 bytes of the random number
       00             Session Id length
       00 35          Selected Cipher Suite (RSA with AES-256-CBC SHA)
       00             Selected compression method (null)
       00 09          Extensions length
       ff 01 00 01 00 Extension (Renegotiation Info)
       00 23 00 00    Extension (SessionTicket TLS)

Certificate message           

0000   16 03 01 01 e4 0b 00 01 e0 00 01 dd 00 01 da 30  ...............0
0010   82 01 d6 30 82 01 3f 02 01 01 30 0d 06 09 2a 86  ...0..?...0...*.
0020   48 86 f7 0d 01 01 04 05 00 30 45 31 0b 30 09 06  H........0E1.0..
0030   03 55 04 06 13 02 41 55 31 13 30 11 06 03 55 04  .U....AU1.0...U.
0040   08 13 0a 53 6f 6d 65 2d 53 74 61 74 65 31 21 30  ...Some-State1!0
0050   1f 06 03 55 04 0a 13 18 49 6e 74 65 72 6e 65 74  ...U....Internet
0060   20 57 69 64 67 69 74 73 20 50 74 79 20 4c 74 64   Widgits Pty Ltd
0070   30 1e 17 0d 39 39 30 35 30 31 30 31 32 36 33 35  0...990501012635
0080   5a 17 0d 39 39 30 35 33 31 30 31 32 36 33 35 5a  Z..990531012635Z
0090   30 22 31 0b 30 09 06 03 55 04 06 13 02 44 45 31  0&#34;1.0...U....DE1
00a0   13 30 11 06 03 55 04 03 13 0a 54 65 73 74 73 65  .0...U....Testse
00b0   72 76 65 72 30 81 9f 30 0d 06 09 2a 86 48 86 f7  rver0..0...*.H..
00c0   0d 01 01 01 05 00 03 81 8d 00 30 81 89 02 81 81  ..........0.....
00d0   00 fa 23 7a 03 2a 27 b1 c3 09 64 ce 36 ab eb d0  ..#z.*&#39;...d.6...
00e0   08 16 75 54 68 6f 39 2e d0 9e 81 ed 91 f8 2b 48  ..uTho9.......+H
00f0   0e 59 10 63 0e bc ff c3 1b 4f 7a 2e d2 97 45 01  .Y.c.....Oz...E.
0100   c2 fd 20 68 98 63 76 34 48 73 3d 3e a1 74 d1 13  .. h.cv4Hs=&gt;.t..
0110   b5 30 2b 4d a6 a4 e7 17 74 9c 2e 96 e6 82 01 a3  .0+M....t.......
0120   2a 29 66 59 89 f6 6a 2e de 99 d8 cc 8d 75 4b b7  *)fY..j......uK.
0130   35 96 db 11 a0 20 60 13 59 03 77 d8 a8 1f 26 78  5.... `.Y.w...&amp;x
0140   38 8d 78 b5 52 31 22 c8 b8 64 c3 46 5f d4 8f e0  8.x.R1&#34;..d.F_...
0150   83 02 03 01 00 01 30 0d 06 09 2a 86 48 86 f7 0d  ......0...*.H...
0160   01 01 04 05 00 03 81 81 00 c8 0c fa c6 c0 93 c0  ................
0170   df 8d 27 da f9 17 f6 81 c1 97 99 ba ef 64 0c ca  ..&#39;..........d..
0180   cc 2f b9 45 4d e4 6a af cd cb 12 17 00 67 28 f5  ./.EM.j......g(.
0190   d6 63 a3 3c d6 7c df f1 b8 6b a9 e5 ba 05 93 e2  .c.&lt;.|...k......
01a0   ab 3f ec 5d 82 c6 aa 18 7b 32 ce 58 04 a2 ac f8  .?.]....{2.X....
01b0   7a 4a 8b 8d 07 95 6e 7a 23 df 7f 61 54 55 3d 32  zJ....nz#..aTU=2
01c0   13 e2 e8 95 0b 3f 18 d7 2a e9 a3 7d 7d 8b 2c d9  .....?..*..}}.,.
01d0   22 91 6e 69 bb 3f 03 7f 75 22 5f 41 22 68 9b dd  &#34;.ni.?..u&#34;_A&#34;h..
01e0   ec 4c 0f f0 9e f9 b6 25 13                       .L.....%.

       16             Handshake protocol type
       03 01          SSL version (TLS 1.0)
       01 e4          Record length (484 bytes)

       0b             Certificate message type
       00 01 e0       Message length
       00 01 dd       Certificates length
       00 .. 13       Certificates data

ServerHelloDone message

0000   16 03 01 00 04 0e 00 00 00                       .........

       16             Handshake protocol type
       03 01          SSL version (TLS 1.0)
       00 04          Record length (4 bytes)

       0e             ServerHelloDone message
       00 00 00       Message length
</code></pre><h1 id=第三发-client---server>第三发 （Client -> Server)<a hidden class=anchor aria-hidden=true href=#第三发-client---server>#</a></h1><p>在发送这条消息之前，客户端和服务器已经协商好了各种算法：Key Exchange 用 RSA， 对称加密用 AES-256-CBC ，
消息摘要用 SHA。TLS 的扩展字段有 SessionTicket TLS 和 Renegotiation Info。</p><p>此时，客户端也拥有了服务器的证书链，可以验证是否信任这些证书。验证完毕之后，发送下面三种消息。</p><pre tabindex=0><code>ClientKeyExchange message

 0000   16 03 01 00 86 10 00 00 82 00 80 2d 28 e4 30 eb  ...........-(.0.
 0010   31 35 b0 4b 5e 4c 4d c6 ee 01 f5 33 e7 f8 3f 9b  15.K^LM....3..?.
 0020   d7 53 fc 5c e0 2d d6 12 ba 55 f8 46 ab 73 d8 3d  .S.\.-...U.F.s.=
 0030   b0 0a f7 03 7f 58 e0 32 8f 91 1f b8 cf 56 aa 89  .....X.2.....V..
 0040   9e 27 84 08 ec 78 f8 74 0c d3 80 f2 ec 04 65 e1  .&#39;...x.t......e.
 0050   3e 92 91 52 b5 5e aa 67 e9 e6 40 e9 10 67 3c 3f  &gt;..R.^.g..@..g&lt;?
 0060   73 f7 62 4a 0c 42 30 c1 06 6f 53 2f c2 6b d5 c8  s.bJ.B0..oS/.k..
 0070   67 6f 06 d7 92 86 6e 1d 4d dd 6b 3f b0 26 6c 25  go....n.M.k?.&amp;l%
 0080   2c d8 81 5a 80 e0 e2 cc d1 62 9c                 ,..Z.....b.

        16             Handshake protocol type
        03 01          SSL version (TLS 1.0)
        00 86          Record length (134 bytes)

        10             ClientKeyExchange message type
        00 00 82       Message length (130 bytes)
        00 .. 9c       RSA encrypted key data (premaster secret) &lt;--- 这个用来干嘛？

 ChangeCipherSpec message

 0000   14 03 01 00 01 01                                ......

        14             ChangeCipherSpec protocol type
        03 01          SSL version (TLS 1.0)
        00 01          Message length (1 byte)

        01             ChangeCipherSpec message

 Finished message (encrypted)

 0000   16 03 01 00 30 0c c1 86 73 a4 a3 26 62 30 21 7f  ....0...s..&amp;b0!.
 0010   c3 2f 1a 83 34 2d 57 f0 e2 0d 37 d4 51 66 08 22  ./..4-W...7.Qf.&#34;
 0020   b0 ea b4 a4 1e 81 2a fd 5f 07 47 9f b7 2c 0a dc  ......*._.G..,..
 0030   65 08 77 40 2a                                   e.w@*

        16             Handshake protocol type
        03 01          SSL version (TLS 1.0)
        00 30          Message length (48 bytes)

        0c .. 2a       Encrypted Finished message
</code></pre><h1 id=第四发-server---client>第四发 （Server -> Client）<a hidden class=anchor aria-hidden=true href=#第四发-server---client>#</a></h1><p>服务端在接收到客户端发来的 ChangeCipherSpec 和 Finished 之后，也要发送自己的 ChangeCipherSpec 和 Finished 消息，这样握手过程才算结束。
对于报文中的 NewSessionTicket 消息，这是 TLS 的一个扩展，具体可参见 RFC5077。</p><pre tabindex=0><code> NewSessionTicket message

 0000   16 03 01 00 aa 04 00 00 a6 00 00 00 00 00 a0 f7  ................
 0010   2f 0c fd be ce f7 96 86 ca fd da 58 d6 16 b3 3c  /..........X...&lt;
 0020   89 1a a5 a2 af 3c 80 50 7b 99 71 05 3b 0e d3 27  .....&lt;.P{.q.;..&#39;
 0030   75 78 0d 0a 20 6c e7 1c ce 7b 5d 52 ad f1 04 88  ux.. l...{]R....
 0040   ec fa 04 c9 6a 74 fc 7b 3d 99 aa 8a ec 7a a3 18  ....jt.{=....z..
 0050   81 63 2f db b0 16 5b 49 63 f4 53 bc 57 18 27 37  .c/...[Ic.S.W.&#39;7
 0060   f2 7f 66 e6 4d 46 59 2d 17 39 d5 79 a4 49 4d 93  ..f.MFY-.9.y.IM.
 0070   d2 80 34 8b 49 f5 31 72 7f 7b 41 46 37 9b ae a9  ..4.I.1r.{AF7...
 0080   3c f0 6f 2e 7f 75 e3 bf 2f d8 fc a4 be cb 2c 84  &lt;.o..u../.....,.
 0090   01 b2 25 01 23 91 6e c0 c1 09 9d 42 c8 b8 e6 1b  ..%.#.n....B....
 00a0   fe 1e ed b3 52 7f 25 90 ae fc 34 f5 96 1b f0     ....R.%...4....

        16             Handshake protocol type
        03 01          SSL version (TLS 1.0)
        aa 04          Message length (170 bytes)

        04             New Session Ticket message type (extension)
        00 00 a6       Message length (166 bytes)
        00 .. f0       Session Ticket data

 ChangeCipherSpec message

 0000   14 03 01 00 01 01                                ......

        14             ChangeCipherSpec protocol type
        03 01          SSL version (TLS 1.0)
        00 01          Message length

        01             ChangeCipherSpec message

 Finished message (encrypted)

 0000   16 03 01 00 30 6d 09 0e 9f dd 09 03 2f 84 65 f8  ....0m....../.e.
 0010   94 0f d6 7b 4b 54 31 a1 25 a4 27 03 ae c3 4e af  ...{KT1.%.&#39;...N.
 0020   27 04 32 5a 1f 29 90 fa 0a 4b 89 2f af d8 88 99  &#39;.2Z.)...K./....
 0030   41 de dd 89 3f                                   A...?

        16             Handshake protocol type
        03 01          SSL version (TLS 1.0)
        00 30          Message length (48 bytes)

        6d .. 3f       Encrypted Finished message
</code></pre><h1 id=最后>最后<a hidden class=anchor aria-hidden=true href=#最后>#</a></h1><p>握手成功之后，客户端和服务端就开始加密传输 TLS 之上的协议发来的数据了。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://runzhen.github.io/tags/tls/>Tls</a></li></ul><nav class=paginav><a class=prev href=https://runzhen.github.io/posts/ssl-perfect-forward-secrecy/><span class=title>« Prev</span><br><span>TLS Perfect Forward Secrecy 之 RSA 的缺陷</span>
</a><a class=next href=https://runzhen.github.io/posts/tls-basic/><span class=title>Next »</span><br><span>TLS 1.2 协议格式</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 抓包分析 TLS 1.2 连接过程 on x" href="https://x.com/intent/tweet/?text=%e6%8a%93%e5%8c%85%e5%88%86%e6%9e%90%20TLS%201.2%20%e8%bf%9e%e6%8e%a5%e8%bf%87%e7%a8%8b&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2ftls2-packets%2f&amp;hashtags=tls"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 抓包分析 TLS 1.2 连接过程 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2ftls2-packets%2f&amp;title=%e6%8a%93%e5%8c%85%e5%88%86%e6%9e%90%20TLS%201.2%20%e8%bf%9e%e6%8e%a5%e8%bf%87%e7%a8%8b&amp;summary=%e6%8a%93%e5%8c%85%e5%88%86%e6%9e%90%20TLS%201.2%20%e8%bf%9e%e6%8e%a5%e8%bf%87%e7%a8%8b&amp;source=https%3a%2f%2frunzhen.github.io%2fposts%2ftls2-packets%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 抓包分析 TLS 1.2 连接过程 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frunzhen.github.io%2fposts%2ftls2-packets%2f&title=%e6%8a%93%e5%8c%85%e5%88%86%e6%9e%90%20TLS%201.2%20%e8%bf%9e%e6%8e%a5%e8%bf%87%e7%a8%8b"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 抓包分析 TLS 1.2 连接过程 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frunzhen.github.io%2fposts%2ftls2-packets%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 抓包分析 TLS 1.2 连接过程 on whatsapp" href="https://api.whatsapp.com/send?text=%e6%8a%93%e5%8c%85%e5%88%86%e6%9e%90%20TLS%201.2%20%e8%bf%9e%e6%8e%a5%e8%bf%87%e7%a8%8b%20-%20https%3a%2f%2frunzhen.github.io%2fposts%2ftls2-packets%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 抓包分析 TLS 1.2 连接过程 on telegram" href="https://telegram.me/share/url?text=%e6%8a%93%e5%8c%85%e5%88%86%e6%9e%90%20TLS%201.2%20%e8%bf%9e%e6%8e%a5%e8%bf%87%e7%a8%8b&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2ftls2-packets%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 抓包分析 TLS 1.2 连接过程 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e6%8a%93%e5%8c%85%e5%88%86%e6%9e%90%20TLS%201.2%20%e8%bf%9e%e6%8e%a5%e8%bf%87%e7%a8%8b&u=https%3a%2f%2frunzhen.github.io%2fposts%2ftls2-packets%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://runzhen.github.io/>Mind in the Wind</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>