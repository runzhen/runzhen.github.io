<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Bittorrent 协议及工作原理 | Mind in the Wind</title>
<meta name=keywords content="p2p"><meta name=description content="在 2000 年左右开始接触互联网的同学都应该记得用 BT 种子下载电影和小电影那段的时光。之前只是大概知道 BT 的工作原理，但并没有仔细研究过，所以一直很好奇。
随便在网上搜索下，可以知道 BT 大概是这样工作的:

BitTorrent 协议把提供下载的文件虚拟分成大小相等的块，块大小必须为 2k 的整数次方，并把每个块的索引信息和 Hash 验证码
写入 .torrent 文件（即种子文件，也简称为“种子”）中，作为被下载文件的“索引”。 下载者要下载文件内容，需要先得到相应的 .torrent 文件，然后使用 BT 客户端软件进行下载。

下载时，BT 客户端首先解析 .torrent 文件得到 Tracker 地址，然后连接 Tracker 服务器。Tracker 服务器回应下载者的请求，提供下载者其他下载者（包括发布者）的 IP。或者，BT客户端也可解析 .torrent 文件得到 nodes 路由表，然后连接路由表中的有效节点，由网络节点提供下载者其他下载者的 IP。
torrent 文件包含了什么
根据 bittorrent.org官方文档，种子文件也被称为metainfo files, 主要包含以下信息：

announce, The URL of the tracker.
info, This maps to a dictionary.

所以种子文件就是告诉你，去 announce 这个地址找文件，具体文件信息包含在 info 里面。
Info 结构体有以下基本内容：

name key maps to a UTF-8 encoded string.
piece length maps to the number of bytes in each piece the file is split into.
pieces maps to a string whose length is a multiple of 20. 其实就是文件被切成很多片，这个变量保存了所有片的 SHA1 值。
length - The length of the file, in bytes.

以上4个是最基本的结构体信息，只支持下载单个文件，如果是表示多个文件或文件夹，还需要增加一些额外信息，具体见官方文档。"><meta name=author content="Me"><link rel=canonical href=https://runzhen.github.io/posts/how-bt-torrent-works/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.103f87022495ee8537d399aa50bf7e2203f4c653b709467478c7fd5a58182364.css integrity="sha256-ED+HAiSV7oU305mqUL9+IgP0xlO3CUZ0eMf9WlgYI2Q=" rel="preload stylesheet" as=style><link rel=icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://runzhen.github.io/posts/how-bt-torrent-works/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Bittorrent 协议及工作原理"><meta property="og:description" content="在 2000 年左右开始接触互联网的同学都应该记得用 BT 种子下载电影和小电影那段的时光。之前只是大概知道 BT 的工作原理，但并没有仔细研究过，所以一直很好奇。
随便在网上搜索下，可以知道 BT 大概是这样工作的:

BitTorrent 协议把提供下载的文件虚拟分成大小相等的块，块大小必须为 2k 的整数次方，并把每个块的索引信息和 Hash 验证码
写入 .torrent 文件（即种子文件，也简称为“种子”）中，作为被下载文件的“索引”。 下载者要下载文件内容，需要先得到相应的 .torrent 文件，然后使用 BT 客户端软件进行下载。

下载时，BT 客户端首先解析 .torrent 文件得到 Tracker 地址，然后连接 Tracker 服务器。Tracker 服务器回应下载者的请求，提供下载者其他下载者（包括发布者）的 IP。或者，BT客户端也可解析 .torrent 文件得到 nodes 路由表，然后连接路由表中的有效节点，由网络节点提供下载者其他下载者的 IP。
torrent 文件包含了什么
根据 bittorrent.org官方文档，种子文件也被称为metainfo files, 主要包含以下信息：

announce, The URL of the tracker.
info, This maps to a dictionary.

所以种子文件就是告诉你，去 announce 这个地址找文件，具体文件信息包含在 info 里面。
Info 结构体有以下基本内容：

name key maps to a UTF-8 encoded string.
piece length maps to the number of bytes in each piece the file is split into.
pieces maps to a string whose length is a multiple of 20. 其实就是文件被切成很多片，这个变量保存了所有片的 SHA1 值。
length - The length of the file, in bytes.

以上4个是最基本的结构体信息，只支持下载单个文件，如果是表示多个文件或文件夹，还需要增加一些额外信息，具体见官方文档。"><meta property="og:type" content="article"><meta property="og:url" content="https://runzhen.github.io/posts/how-bt-torrent-works/"><meta property="og:image" content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-24T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-24T00:00:00+00:00"><meta property="og:site_name" content="Mind in the Wind"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Bittorrent 协议及工作原理"><meta name=twitter:description content="在 2000 年左右开始接触互联网的同学都应该记得用 BT 种子下载电影和小电影那段的时光。之前只是大概知道 BT 的工作原理，但并没有仔细研究过，所以一直很好奇。
随便在网上搜索下，可以知道 BT 大概是这样工作的:

BitTorrent 协议把提供下载的文件虚拟分成大小相等的块，块大小必须为 2k 的整数次方，并把每个块的索引信息和 Hash 验证码
写入 .torrent 文件（即种子文件，也简称为“种子”）中，作为被下载文件的“索引”。 下载者要下载文件内容，需要先得到相应的 .torrent 文件，然后使用 BT 客户端软件进行下载。

下载时，BT 客户端首先解析 .torrent 文件得到 Tracker 地址，然后连接 Tracker 服务器。Tracker 服务器回应下载者的请求，提供下载者其他下载者（包括发布者）的 IP。或者，BT客户端也可解析 .torrent 文件得到 nodes 路由表，然后连接路由表中的有效节点，由网络节点提供下载者其他下载者的 IP。
torrent 文件包含了什么
根据 bittorrent.org官方文档，种子文件也被称为metainfo files, 主要包含以下信息：

announce, The URL of the tracker.
info, This maps to a dictionary.

所以种子文件就是告诉你，去 announce 这个地址找文件，具体文件信息包含在 info 里面。
Info 结构体有以下基本内容：

name key maps to a UTF-8 encoded string.
piece length maps to the number of bytes in each piece the file is split into.
pieces maps to a string whose length is a multiple of 20. 其实就是文件被切成很多片，这个变量保存了所有片的 SHA1 值。
length - The length of the file, in bytes.

以上4个是最基本的结构体信息，只支持下载单个文件，如果是表示多个文件或文件夹，还需要增加一些额外信息，具体见官方文档。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://runzhen.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Bittorrent 协议及工作原理","item":"https://runzhen.github.io/posts/how-bt-torrent-works/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Bittorrent 协议及工作原理","name":"Bittorrent 协议及工作原理","description":"在 2000 年左右开始接触互联网的同学都应该记得用 BT 种子下载电影和小电影那段的时光。之前只是大概知道 BT 的工作原理，但并没有仔细研究过，所以一直很好奇。\n随便在网上搜索下，可以知道 BT 大概是这样工作的:\nBitTorrent 协议把提供下载的文件虚拟分成大小相等的块，块大小必须为 2k 的整数次方，并把每个块的索引信息和 Hash 验证码 写入 .torrent 文件（即种子文件，也简称为“种子”）中，作为被下载文件的“索引”。 下载者要下载文件内容，需要先得到相应的 .torrent 文件，然后使用 BT 客户端软件进行下载。\n下载时，BT 客户端首先解析 .torrent 文件得到 Tracker 地址，然后连接 Tracker 服务器。Tracker 服务器回应下载者的请求，提供下载者其他下载者（包括发布者）的 IP。或者，BT客户端也可解析 .torrent 文件得到 nodes 路由表，然后连接路由表中的有效节点，由网络节点提供下载者其他下载者的 IP。\ntorrent 文件包含了什么 根据 bittorrent.org官方文档，种子文件也被称为metainfo files, 主要包含以下信息：\nannounce, The URL of the tracker. info, This maps to a dictionary. 所以种子文件就是告诉你，去 announce 这个地址找文件，具体文件信息包含在 info 里面。\nInfo 结构体有以下基本内容：\nname key maps to a UTF-8 encoded string. piece length maps to the number of bytes in each piece the file is split into. pieces maps to a string whose length is a multiple of 20. 其实就是文件被切成很多片，这个变量保存了所有片的 SHA1 值。 length - The length of the file, in bytes. 以上4个是最基本的结构体信息，只支持下载单个文件，如果是表示多个文件或文件夹，还需要增加一些额外信息，具体见官方文档。\n","keywords":["p2p"],"articleBody":"在 2000 年左右开始接触互联网的同学都应该记得用 BT 种子下载电影和小电影那段的时光。之前只是大概知道 BT 的工作原理，但并没有仔细研究过，所以一直很好奇。\n随便在网上搜索下，可以知道 BT 大概是这样工作的:\nBitTorrent 协议把提供下载的文件虚拟分成大小相等的块，块大小必须为 2k 的整数次方，并把每个块的索引信息和 Hash 验证码 写入 .torrent 文件（即种子文件，也简称为“种子”）中，作为被下载文件的“索引”。 下载者要下载文件内容，需要先得到相应的 .torrent 文件，然后使用 BT 客户端软件进行下载。\n下载时，BT 客户端首先解析 .torrent 文件得到 Tracker 地址，然后连接 Tracker 服务器。Tracker 服务器回应下载者的请求，提供下载者其他下载者（包括发布者）的 IP。或者，BT客户端也可解析 .torrent 文件得到 nodes 路由表，然后连接路由表中的有效节点，由网络节点提供下载者其他下载者的 IP。\ntorrent 文件包含了什么 根据 bittorrent.org官方文档，种子文件也被称为metainfo files, 主要包含以下信息：\nannounce, The URL of the tracker. info, This maps to a dictionary. 所以种子文件就是告诉你，去 announce 这个地址找文件，具体文件信息包含在 info 里面。\nInfo 结构体有以下基本内容：\nname key maps to a UTF-8 encoded string. piece length maps to the number of bytes in each piece the file is split into. pieces maps to a string whose length is a multiple of 20. 其实就是文件被切成很多片，这个变量保存了所有片的 SHA1 值。 length - The length of the file, in bytes. 以上4个是最基本的结构体信息，只支持下载单个文件，如果是表示多个文件或文件夹，还需要增加一些额外信息，具体见官方文档。\n根据以上信息就可以写出一个种子文件的 Golang 结构体，\ntype TorrentFile struct { Announce string InfoHash [20]byte PieceHashes [][20]byte PieceLength int Length int Name string } 此外，BT torrent 文件是使用 bencoding 编码方式编码的，所以如果用 text editor 打开种子文件会看到是一堆读不懂的符号。\n好在已经有人帮我们写好了解析 bencoding 的库了，比如 github.com/jackpal/bencode-go，直接拿来使用就可以。\n与 Tracker 的请求和回复 当知道了 tracker 服务器的地址后，client 就可以向服务器发起 GET 请求，那么请求要包含哪些信息呢？\ninfo_hash 对种子文件 info 字段进行 hash 后的一个值，用来唯一定位一个文件。 peer_id client 自己的给自己的 ID ip client 自己的 IP。Generally used for the origin if it’s on the same machine as the tracker. port The port number this peer is listening on. uploaded The total amount uploaded so far, encoded in base ten ascii. downloaded The total amount downloaded so far, encoded in base ten ascii. left 剩余需要下载的字节数。Note that this can’t be computed from downloaded and the file length since it might be a resume. event This is an optional key which maps to started, completed, or stopped (or empty, which is the same as not being present). If not present, this is one of the announcement 之后 Tracker 会回复一个 bencoding 编码的 key value, 包含以下信息：\n如果失败，返回 failure 包含失败的原因。 如果成功，返回两个值，一个是 interval，告诉 client 多久请求一次一遍更新信息，单位是秒s。第二个是 peers, 包含一串 peer id, ip, and port。 与 Peer 的交互 终于，经过上面两步，我们拿到了 Peer 的信息，接下来就可以去 Peer 那里下载文件的分片了。\nPeer Protocol 官方文档上关于 protocol 有一大段的描述，我的理解如下：\n每当 client 下载完一个piece 并且验证完 hash 之后，它需要跟其他 peers announce 这个 piece。\n连接双方都时刻维护着两个状态：choked or not, interested or not, Choking is a notification that no data will be sent until unchoking happens.\n当一方是 interested 并且另一方是 not choked时，才可以传数据。连接初始时是 choked and not interested。\nHandshake 开始握手时，发起方会发一个 handshake message 给 peers，它由以下信息组成：\n用 19 BitTorrent protocol 作为开始，这个是协议的 identifier 和它的长度，之后每条消息也是把长度放在前面，后面接上信息本身，长度被 encode 成 big endian 4 bytes。 接着第二部分是 8 字节全为的 0 ，主要是保留作为扩展，但是现在没有使用，所以全都是 0。 接下来是 20 字节的 BT 种子 metainfo 字段的 SHA1 值。 接下来是 20 字节的我们自己的 peer id。 对方 peer 收到这条握手信息后，会发回一个一样格式的消息，我们需要 parse，然后检查里面的信息与我们期待的一致，比如 metainfo 的 SHA1 值。\n到此，握手结束。在网上找了一张截图放在这里，\n接下来就是真正交互式的传数据，消息都是由长度作为 prefix 加上 msg 本身。 如果长度是0，则是 keepalive 消息。\nPeer Message 正如前面说的，handshake 完成后我们还不能请求数据，必须要等 peer 给我们发 unchoke 消息才行。\n注意：bittorrent 是一个 peer-to-peer 协议，因此不能像 HTTP 协议那样区分 client server，在双方交换信息的过程中，能够发送和接收的消息类型是一致的。\nbittorrent 一共有下面 9 中消息类型\n0 - choke 1 - unchoke 2 - interested 3 - not interested 4 - have 5 - bitfield 6 - request 7 - piece 8 - cancel 如果收到 bitfield 类型的消息，它告诉我们可以从 peer 那儿下载哪些 piece，从它的名字可以看出，是利用每个 byte 中的 8 个 bit 来表示的，充分利用空间。\n如果收到 have 类型的消息，表示 peer 刚刚下载完并验证了哪些 piece。 格式是 have: ","wordCount":"537","inLanguage":"en","image":"https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2020-10-24T00:00:00Z","dateModified":"2020-10-24T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://runzhen.github.io/posts/how-bt-torrent-works/"},"publisher":{"@type":"Organization","name":"Mind in the Wind","logo":{"@type":"ImageObject","url":"https://runzhen.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://runzhen.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://runzhen.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://runzhen.github.io/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://runzhen.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://runzhen.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://runzhen.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Bittorrent 协议及工作原理</h1><div class=post-meta><span title='2020-10-24 00:00:00 +0000 UTC'>2020-10-24</span>&nbsp;·&nbsp;Me</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#torrent-%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e4%ba%86%e4%bb%80%e4%b9%88 aria-label="torrent 文件包含了什么">torrent 文件包含了什么</a></li><li><a href=#%e4%b8%8e-tracker-%e7%9a%84%e8%af%b7%e6%b1%82%e5%92%8c%e5%9b%9e%e5%a4%8d aria-label="与 Tracker 的请求和回复">与 Tracker 的请求和回复</a></li><li><a href=#%e4%b8%8e-peer-%e7%9a%84%e4%ba%a4%e4%ba%92 aria-label="与 Peer 的交互">与 Peer 的交互</a><ul><li><a href=#peer-protocol aria-label="Peer Protocol">Peer Protocol</a><ul><li><a href=#handshake aria-label=Handshake>Handshake</a></li></ul></li><li><a href=#peer-message aria-label="Peer Message">Peer Message</a></li></ul></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=参考资料>参考资料</a></li></ul></div></details></div><div class=post-content><p>在 2000 年左右开始接触互联网的同学都应该记得用 BT 种子下载电影和小电影那段的时光。之前只是大概知道 BT 的工作原理，但并没有仔细研究过，所以一直很好奇。</p><p>随便在网上搜索下，可以知道 BT 大概是这样工作的:</p><blockquote><p>BitTorrent 协议把提供下载的文件虚拟分成大小相等的块，块大小必须为 2k 的整数次方，并把每个块的索引信息和 Hash 验证码
写入 .torrent 文件（即种子文件，也简称为“种子”）中，作为被下载文件的“索引”。 下载者要下载文件内容，需要先得到相应的 .torrent 文件，然后使用 BT 客户端软件进行下载。</p></blockquote><blockquote><p>下载时，BT 客户端首先解析 .torrent 文件得到 Tracker 地址，然后连接 Tracker 服务器。Tracker 服务器回应下载者的请求，提供下载者其他下载者（包括发布者）的 IP。或者，BT客户端也可解析 .torrent 文件得到 nodes 路由表，然后连接路由表中的有效节点，由网络节点提供下载者其他下载者的 IP。</p></blockquote><h2 id=torrent-文件包含了什么>torrent 文件包含了什么<a hidden class=anchor aria-hidden=true href=#torrent-文件包含了什么>#</a></h2><p>根据 <a href=http://bittorrent.org/beps/bep_0003.html>bittorrent.org官方文档</a>，种子文件也被称为<code>metainfo files</code>, 主要包含以下信息：</p><ul><li><code>announce</code>, The URL of the tracker.</li><li><code>info</code>, This maps to a dictionary.</li></ul><p>所以种子文件就是告诉你，去 announce 这个地址找文件，具体文件信息包含在 info 里面。</p><p>Info 结构体有以下基本内容：</p><ul><li><code>name</code> key maps to a UTF-8 encoded string.</li><li><code>piece length</code> maps to the number of bytes in each piece the file is split into.</li><li><code>pieces</code> maps to a string whose length is a multiple of 20. 其实就是文件被切成很多片，这个变量保存了所有片的 SHA1 值。</li><li><code>length</code> - The length of the file, in bytes.</li></ul><p>以上4个是最基本的结构体信息，只支持下载单个文件，如果是表示多个文件或文件夹，还需要增加一些额外信息，具体见官方文档。</p><p>根据以上信息就可以写出一个种子文件的 Golang 结构体，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TorrentFile</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Announce</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>InfoHash</span>    <span class=p>[</span><span class=mi>20</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=nx>PieceHashes</span> <span class=p>[][</span><span class=mi>20</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=nx>PieceLength</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>Length</span>      <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span>        <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>此外，BT torrent 文件是使用 <code>bencoding</code> 编码方式编码的，所以如果用 text editor 打开种子文件会看到是一堆读不懂的符号。</p><p>好在已经有人帮我们写好了解析 bencoding 的库了，比如 <a href=github.com/jackpal/bencode-go>github.com/jackpal/bencode-go</a>，直接拿来使用就可以。</p><h2 id=与-tracker-的请求和回复>与 Tracker 的请求和回复<a hidden class=anchor aria-hidden=true href=#与-tracker-的请求和回复>#</a></h2><p>当知道了 tracker 服务器的地址后，client 就可以向服务器发起 GET 请求，那么请求要包含哪些信息呢？</p><ul><li><code>info_hash</code> 对种子文件 info 字段进行 hash 后的一个值，用来唯一定位一个文件。</li><li><code>peer_id</code> client 自己的给自己的 ID</li><li><code>ip</code> client 自己的 IP。Generally used for the origin if it&rsquo;s on the same machine as the tracker.</li><li><code>port</code> The port number this peer is listening on.</li><li><code>uploaded</code> The total amount uploaded so far, encoded in base ten ascii.</li><li><code>downloaded</code> The total amount downloaded so far, encoded in base ten ascii.</li><li><code>left</code> 剩余需要下载的字节数。Note that this can&rsquo;t be computed from downloaded and the file length since it might be a resume.</li><li><code>event</code> This is an optional key which maps to started, completed, or stopped (or empty, which is the same as not being present). If not present, this is one of the announcement</li></ul><p>之后 Tracker 会回复一个 bencoding 编码的 key value, 包含以下信息：</p><ul><li>如果失败，返回 <code>failure</code> 包含失败的原因。</li><li>如果成功，返回两个值，一个是 <code>interval</code>，告诉 client 多久请求一次一遍更新信息，单位是秒s。第二个是 <code>peers</code>, 包含一串 peer id, ip, and port。</li></ul><h2 id=与-peer-的交互>与 Peer 的交互<a hidden class=anchor aria-hidden=true href=#与-peer-的交互>#</a></h2><p>终于，经过上面两步，我们拿到了 Peer 的信息，接下来就可以去 Peer 那里下载文件的分片了。</p><h3 id=peer-protocol>Peer Protocol<a hidden class=anchor aria-hidden=true href=#peer-protocol>#</a></h3><p>官方文档上关于 protocol 有一大段的描述，我的理解如下：</p><p>每当 client 下载完一个piece 并且验证完 hash 之后，它需要跟其他 peers announce 这个 piece。</p><p>连接双方都时刻维护着两个状态：<code>choked or not</code>, <code>interested or not</code>, Choking is a notification that no data will be sent until unchoking happens.</p><p>当一方是 <code>interested</code> 并且另一方是 <code>not choked</code>时，才可以传数据。连接初始时是 <code>choked and not interested</code>。</p><h4 id=handshake>Handshake<a hidden class=anchor aria-hidden=true href=#handshake>#</a></h4><p>开始握手时，发起方会发一个 handshake message 给 peers，它由以下信息组成：</p><ol><li>用 19 <code>BitTorrent protocol</code> 作为开始，这个是协议的 identifier 和它的长度，之后每条消息也是把长度放在前面，后面接上信息本身，长度被 encode 成 big endian 4 bytes。</li><li>接着第二部分是 8 字节全为的 0 ，主要是保留作为扩展，但是现在没有使用，所以全都是 0。</li><li>接下来是 20 字节的 BT 种子 metainfo 字段的 SHA1 值。</li><li>接下来是 20 字节的我们自己的 peer id。</li></ol><p>对方 peer 收到这条握手信息后，会发回一个一样格式的消息，我们需要 parse，然后检查里面的信息与我们期待的一致，比如 metainfo 的 SHA1 值。</p><p>到此，握手结束。在网上找了一张截图放在这里，</p><p><img loading=lazy src=/image/2020/bt.png alt=bt></p><p>接下来就是真正交互式的传数据，消息都是由长度作为 prefix 加上 msg 本身。 如果长度是0，则是 keepalive 消息。</p><h3 id=peer-message>Peer Message<a hidden class=anchor aria-hidden=true href=#peer-message>#</a></h3><p>正如前面说的，handshake 完成后我们还不能请求数据，必须要等 peer 给我们发 <code>unchoke</code> 消息才行。</p><p>注意：bittorrent 是一个 <code>peer-to-peer</code> 协议，因此不能像 HTTP 协议那样区分 client server，在双方交换信息的过程中，能够发送和接收的消息类型是一致的。</p><p>bittorrent 一共有下面 9 中消息类型</p><ul><li>0 - choke</li><li>1 - unchoke</li><li>2 - interested</li><li>3 - not interested</li><li>4 - have</li><li>5 - bitfield</li><li>6 - request</li><li>7 - piece</li><li>8 - cancel</li></ul><p>如果收到 <code>bitfield</code> 类型的消息，它告诉我们可以从 peer 那儿下载哪些 piece，从它的名字可以看出，是利用每个 byte 中的 8 个 bit 来表示的，充分利用空间。</p><p>如果收到 <code>have</code> 类型的消息，表示 peer 刚刚下载完并验证了哪些 piece。 格式是 <code>have: &lt;len=0005>&lt;id=4>&lt;piece index></code></p><p><code>request</code> 消息的格式是 <code>request: &lt;len=0013>&lt;id=6>&lt;index>&lt;begin>&lt;length></code></p><ul><li>index: integer specifying the zero-based piece index</li><li>begin: integer specifying the zero-based byte offset within the piece</li><li>length: integer specifying the requested length.</li></ul><p><code>piece</code> 的格式是 <code>piece: &lt;len=0009+X>&lt;id=7>&lt;index>&lt;begin>&lt;block></code></p><ul><li>index: integer specifying the zero-based piece index</li><li>begin: integer specifying the zero-based byte offset within the piece</li><li>block: block of data, which is a subset of the piece specified by index.</li></ul><p>协议的分析就写到这里，对于某些具体的细节，如果以后我有新的理解再来更新。</p><p>理解了协议之后，就可以尝试写一个简单的 bittorrent client 了，期待有空能写一个。</p><h2 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h2><p>必须要吐槽一下，官网的资料写的还没有第三方网站清楚易懂。</p><ul><li><a href=http://bittorrent.org/beps/bep_0003.html>http://bittorrent.org/beps/bep_0003.html</a></li><li><a href=https://wiki.theory.org/BitTorrentSpecification#choke:_.3Clen.3D0001.3E.3Cid.3D0.3E>https://wiki.theory.org/BitTorrentSpecification#choke:_.3Clen.3D0001.3E.3Cid.3D0.3E</a></li><li><a href=http://dandylife.net/docs/BitTorrent-Protocol.pdf>http://dandylife.net/docs/BitTorrent-Protocol.pdf</a></li><li><a href=https://blog.jse.li/posts/torrent/>https://blog.jse.li/posts/torrent/</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://runzhen.github.io/tags/p2p/>P2p</a></li></ul><nav class=paginav><a class=prev href=https://runzhen.github.io/posts/grpc-go-server-code/><span class=title>« Prev</span><br><span>gRPC-go Server 端实现</span>
</a><a class=next href=https://runzhen.github.io/posts/docker-privileged/><span class=title>Next »</span><br><span>Docker 的 privileged 模式</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Bittorrent 协议及工作原理 on x" href="https://x.com/intent/tweet/?text=Bittorrent%20%e5%8d%8f%e8%ae%ae%e5%8f%8a%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fhow-bt-torrent-works%2f&amp;hashtags=p2p"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Bittorrent 协议及工作原理 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fhow-bt-torrent-works%2f&amp;title=Bittorrent%20%e5%8d%8f%e8%ae%ae%e5%8f%8a%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86&amp;summary=Bittorrent%20%e5%8d%8f%e8%ae%ae%e5%8f%8a%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86&amp;source=https%3a%2f%2frunzhen.github.io%2fposts%2fhow-bt-torrent-works%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Bittorrent 协议及工作原理 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frunzhen.github.io%2fposts%2fhow-bt-torrent-works%2f&title=Bittorrent%20%e5%8d%8f%e8%ae%ae%e5%8f%8a%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Bittorrent 协议及工作原理 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frunzhen.github.io%2fposts%2fhow-bt-torrent-works%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Bittorrent 协议及工作原理 on whatsapp" href="https://api.whatsapp.com/send?text=Bittorrent%20%e5%8d%8f%e8%ae%ae%e5%8f%8a%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86%20-%20https%3a%2f%2frunzhen.github.io%2fposts%2fhow-bt-torrent-works%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Bittorrent 协议及工作原理 on telegram" href="https://telegram.me/share/url?text=Bittorrent%20%e5%8d%8f%e8%ae%ae%e5%8f%8a%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fhow-bt-torrent-works%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Bittorrent 协议及工作原理 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Bittorrent%20%e5%8d%8f%e8%ae%ae%e5%8f%8a%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86&u=https%3a%2f%2frunzhen.github.io%2fposts%2fhow-bt-torrent-works%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://runzhen.github.io/>Mind in the Wind</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>