<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>记一次 cert chain 乱序导致 OCSP 验证失败 | Mind in the Wind</title>
<meta name=keywords content="ocsp"><meta name=description content="证书的基本信息 通常 cert 里面是包含了 OCSP 信息的，我们用 openssl 命令来看一下证书 server.cert 里面有哪些东西。
$ openssl x509 -noout -text -in server.cert Certificate: Data: Version: 3 (0x2) Serial Number: 6f:66:75:a4:db:bb:e6:5e:73:0a:7a:66:e7:41:a0:e1:18:4f:43:3f Signature Algorithm: sha384WithRSAEncryption Issuer: CN = SJC-Services-Issuing-CA2-BETA2-G3, O = Palo-Alto-Networks-Inc., C = US Validity Not Before: Apr 8 16:42:14 2022 GMT Not After : Mar 1 21:34:11 2024 GMT Subject: CN = *.ace-stg.tpcloud.paloaltonetworks.com, OU = tpi-server, O = Palo Alto Networks Inc., L = Santa Clara, ST = CA, C = US Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:d0:24:7d:e8:62:02:f9:97:a7:79:5e:82:24:56: Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Basic Constraints: critical CA:FALSE X509v3 Authority Key Identifier: keyid:D3:B2:01:8C:86:DA:51:DD:38:BE:54:CF:AC:65:BA:4D:4F:C0:6C:27 Authority Information Access: CA Issuers - URI:https://crl."><meta name=author content="Me"><link rel=canonical href=https://runzhen.github.io/posts/ocsp-verify-certificate/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.a8f620eb24ba9442cd3765590f9208a0752be50e5a7b9dd9e3e555c8cb5e74e6.css integrity="sha256-qPYg6yS6lELNN2VZD5IIoHUr5Q5ae53Z4+VVyMtedOY=" rel="preload stylesheet" as=style><link rel=icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://runzhen.github.io/posts/ocsp-verify-certificate/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="记一次 cert chain 乱序导致 OCSP 验证失败"><meta property="og:description" content="证书的基本信息 通常 cert 里面是包含了 OCSP 信息的，我们用 openssl 命令来看一下证书 server.cert 里面有哪些东西。
$ openssl x509 -noout -text -in server.cert Certificate: Data: Version: 3 (0x2) Serial Number: 6f:66:75:a4:db:bb:e6:5e:73:0a:7a:66:e7:41:a0:e1:18:4f:43:3f Signature Algorithm: sha384WithRSAEncryption Issuer: CN = SJC-Services-Issuing-CA2-BETA2-G3, O = Palo-Alto-Networks-Inc., C = US Validity Not Before: Apr 8 16:42:14 2022 GMT Not After : Mar 1 21:34:11 2024 GMT Subject: CN = *.ace-stg.tpcloud.paloaltonetworks.com, OU = tpi-server, O = Palo Alto Networks Inc., L = Santa Clara, ST = CA, C = US Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:d0:24:7d:e8:62:02:f9:97:a7:79:5e:82:24:56: Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Basic Constraints: critical CA:FALSE X509v3 Authority Key Identifier: keyid:D3:B2:01:8C:86:DA:51:DD:38:BE:54:CF:AC:65:BA:4D:4F:C0:6C:27 Authority Information Access: CA Issuers - URI:https://crl."><meta property="og:type" content="article"><meta property="og:url" content="https://runzhen.github.io/posts/ocsp-verify-certificate/"><meta property="og:image" content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-07T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-07T00:00:00+00:00"><meta property="og:site_name" content="Mind in the Wind"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="记一次 cert chain 乱序导致 OCSP 验证失败"><meta name=twitter:description content="证书的基本信息 通常 cert 里面是包含了 OCSP 信息的，我们用 openssl 命令来看一下证书 server.cert 里面有哪些东西。
$ openssl x509 -noout -text -in server.cert Certificate: Data: Version: 3 (0x2) Serial Number: 6f:66:75:a4:db:bb:e6:5e:73:0a:7a:66:e7:41:a0:e1:18:4f:43:3f Signature Algorithm: sha384WithRSAEncryption Issuer: CN = SJC-Services-Issuing-CA2-BETA2-G3, O = Palo-Alto-Networks-Inc., C = US Validity Not Before: Apr 8 16:42:14 2022 GMT Not After : Mar 1 21:34:11 2024 GMT Subject: CN = *.ace-stg.tpcloud.paloaltonetworks.com, OU = tpi-server, O = Palo Alto Networks Inc., L = Santa Clara, ST = CA, C = US Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:d0:24:7d:e8:62:02:f9:97:a7:79:5e:82:24:56: Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Basic Constraints: critical CA:FALSE X509v3 Authority Key Identifier: keyid:D3:B2:01:8C:86:DA:51:DD:38:BE:54:CF:AC:65:BA:4D:4F:C0:6C:27 Authority Information Access: CA Issuers - URI:https://crl."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://runzhen.github.io/posts/"},{"@type":"ListItem","position":2,"name":"记一次 cert chain 乱序导致 OCSP 验证失败","item":"https://runzhen.github.io/posts/ocsp-verify-certificate/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"记一次 cert chain 乱序导致 OCSP 验证失败","name":"记一次 cert chain 乱序导致 OCSP 验证失败","description":"证书的基本信息 通常 cert 里面是包含了 OCSP 信息的，我们用 openssl 命令来看一下证书 server.cert 里面有哪些东西。\n$ openssl x509 -noout -text -in server.cert Certificate: Data: Version: 3 (0x2) Serial Number: 6f:66:75:a4:db:bb:e6:5e:73:0a:7a:66:e7:41:a0:e1:18:4f:43:3f Signature Algorithm: sha384WithRSAEncryption Issuer: CN = SJC-Services-Issuing-CA2-BETA2-G3, O = Palo-Alto-Networks-Inc., C = US Validity Not Before: Apr 8 16:42:14 2022 GMT Not After : Mar 1 21:34:11 2024 GMT Subject: CN = *.ace-stg.tpcloud.paloaltonetworks.com, OU = tpi-server, O = Palo Alto Networks Inc., L = Santa Clara, ST = CA, C = US Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:d0:24:7d:e8:62:02:f9:97:a7:79:5e:82:24:56: Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Basic Constraints: critical CA:FALSE X509v3 Authority Key Identifier: keyid:D3:B2:01:8C:86:DA:51:DD:38:BE:54:CF:AC:65:BA:4D:4F:C0:6C:27 Authority Information Access: CA Issuers - URI:https://crl.","keywords":["ocsp"],"articleBody":"证书的基本信息 通常 cert 里面是包含了 OCSP 信息的，我们用 openssl 命令来看一下证书 server.cert 里面有哪些东西。\n$ openssl x509 -noout -text -in server.cert Certificate: Data: Version: 3 (0x2) Serial Number: 6f:66:75:a4:db:bb:e6:5e:73:0a:7a:66:e7:41:a0:e1:18:4f:43:3f Signature Algorithm: sha384WithRSAEncryption Issuer: CN = SJC-Services-Issuing-CA2-BETA2-G3, O = Palo-Alto-Networks-Inc., C = US Validity Not Before: Apr 8 16:42:14 2022 GMT Not After : Mar 1 21:34:11 2024 GMT Subject: CN = *.ace-stg.tpcloud.paloaltonetworks.com, OU = tpi-server, O = Palo Alto Networks Inc., L = Santa Clara, ST = CA, C = US Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:d0:24:7d:e8:62:02:f9:97:a7:79:5e:82:24:56: Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Basic Constraints: critical CA:FALSE X509v3 Authority Key Identifier: keyid:D3:B2:01:8C:86:DA:51:DD:38:BE:54:CF:AC:65:BA:4D:4F:C0:6C:27 Authority Information Access: CA Issuers - URI:https://crl.paloaltonetworks.com/beta2/beta2-pan-sjc-services-issuing-ca2-beta2-g3.crt OCSP - URI:http://ocsp-beta2.paloaltonetworks.com/ocsp X509v3 Subject Alternative Name: DNS:*.ace-stg.tpcloud.paloaltonetworks.com X509v3 Extended Key Usage: TLS Web Client Authentication, TLS Web Server Authentication X509v3 CRL Distribution Points: Full Name: URI:http://crl.paloaltonetworks.com/beta2/beta2-pan-sjc-services-issuing-ca2-beta2-g3.crl X509v3 Subject Key Identifier: 58:20:5E:3A:63:59:8C:D8:72:24:EF:CA:DF:00:21:E9:04:20:6D:17 X509v3 Key Usage: critical Digital Signature, Key Encipherment Signature Algorithm: sha384WithRSAEncryption 9c:96:d9:48:e8:ad:75:be:48:59:f4:7c:0f:c6:de:ad:37:aa: 挑几个重要的字段：\nSerial Number, 证书的序列号。 Issuer, 证书是谁签发的。 Subject, 证书拥有者信息 Subject Public Key Info，证书的公钥信息。 Subject Key Identifier, 证书密钥标识符，它与 serial number都是唯一的，但是它用来区分一个证书拥有者的多对密钥。 一个指的是证书，一个指的是秘钥。 Authority Key Identifier, 证书颁发机构密钥标识符， Authority Information Access, 这里就能找到 OCSP server 地址。 OCSP 如何验证一个证书 了解了一个 cert 所包含的基本信息以后，那么 OSCP 是用哪些字段来验证 cert 的呢？\n我们先看看 OCSP request 是什么样的。\n$ openssl ocsp -no_nonce -CAfile ca.pem -issuer issuer.crt -cert server.cert -text -url http://ocsp-beta2.paloaltonetworks.com/ocsp OCSP Request Data: Version: 1 (0x0) Requestor List: Certificate ID: Hash Algorithm: sha1 Issuer Name Hash: FF96A6B9165E10A0205E8861423BCE9AACD1B8BA Issuer Key Hash: D3B2018C86DA51DD38BE54CFAC65BA4D4FC06C27 Serial Number: 6F6675A4DBBBE65E730A7A66E741A0E1184F433F 可见两样东西非常重要：\ncert 的 Serial Number, 可以看到与上面的证书信息一致。 Issuer Key Hash 对应上面证书信息的 Authority Key Identifier 字段。 再回过头来看看这个 openssl 命令，其中 issuer.cert 就是证书信息中 CA Issuers，把它下载到本地； CAfile 指的是 issuer.cert 颁发者的 CA chain，这个需要自己去找到，一般也存在与 server.cert 中。\n遇到的问题 我们有一个 server-all.cert, 其中包含了 cert 本身和所有证书链。 但是 client 却无法连到 server，总是报 OCSP 验证不通过的错误。 但是，我们用上面的 openssl 命令验证这个证书，显示验证通过。\n通过在 client 端用 tcpdump 抓到 OCSP 的 http 请求，我们看到如下信息\n对比我们 openssl 发出的请求，发现 Issuer Key Hash 字段的值不对。\n似乎找到了引起 OCSP 验证失败的原因，但是为什么 client 端发出的 Issuer Key Hash 不对呢？ 一开始我想到了以下可能\nClient 从 cert chain 里提取 issuer 错误。 —— 似乎不可能，因为这部分代码是共享的，其他服务也在用，他们没有问题。 Server cert chain 被篡改了，比如 client 到 server 之间有防火墙开启了 TLS decryption，作为中间人自己签发了证书。 —— 经过 QA 确认，lab 没有做过改动，且其他服务也正常。 那么这个错误的 Issuer Key Hash 是从哪来的呢？\n没办法，只能在 client 端捕获 TLS 连接看看 client 到底收到了什么样的 cert chain。 由于开启了 TLS 1.3，现在连传递证书都是在加密连接里的，所以需要解密。\n最终我们捕获了 certs.pcap 和对应的 secrets。\n用 wireshark 打开后，我们看到第一个 cert 是对的，第二个 cert 的 serial number 正是 Client 发出的 OCSP 的 Issuer Key Hash 。\n看来 client 端代码的行为是默认把 cert chain 的第二个 cert 当成 issuer，而事实上，第四个 cert 才是正确的 issuer。\n为什么 server 发来的 cert chain 顺序是乱的呢？ 这个时候我们回过头去查看我们的 server-all.cert，原来 IT 在生成 cert 的时候，把 issuer 到 Root CA 的顺序弄反了。 对于 openssl 这样的工具，它会自动调整 cert chain，并找到正确的issuer，然后发出 OCSP request。 而对于其他一些实现，特别是自己实现的 OCSP 库，没有找到正确的 issuer，而是默认拿第二个。\n看到这里，基本破案了，我们手动把 server.cert 顺序调整好，client 端能通过 OCSP 验证了。\n总结 如果不是因为抓到了 client 端 TLS 建立的握手信息，我们很难明白这个错误的 Issuer Key Hash 是从哪来的？ 因为大多数时候，我们不会打开 server-all.cert 去一个一个看里面的 cert。 之前把很多精力放在认为 server cert chain 被中间人篡改了。\n因为 TLS 1.3 把握手信息也加密了，所以增加了我们抓包的难度，但直观的看到 client 到底收到了什么 cert 能很快帮助我们发现问题。\n","wordCount":"443","inLanguage":"en","image":"https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2022-05-07T00:00:00Z","dateModified":"2022-05-07T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://runzhen.github.io/posts/ocsp-verify-certificate/"},"publisher":{"@type":"Organization","name":"Mind in the Wind","logo":{"@type":"ImageObject","url":"https://runzhen.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://runzhen.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://runzhen.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://runzhen.github.io/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://runzhen.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://runzhen.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://runzhen.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">记一次 cert chain 乱序导致 OCSP 验证失败</h1><div class=post-meta><span title='2022-05-07 00:00:00 +0000 UTC'>2022-05-07</span>&nbsp;·&nbsp;Me</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e8%af%81%e4%b9%a6%e7%9a%84%e5%9f%ba%e6%9c%ac%e4%bf%a1%e6%81%af aria-label=证书的基本信息>证书的基本信息</a></li><li><a href=#ocsp-%e5%a6%82%e4%bd%95%e9%aa%8c%e8%af%81%e4%b8%80%e4%b8%aa%e8%af%81%e4%b9%a6 aria-label="OCSP 如何验证一个证书">OCSP 如何验证一个证书</a></li><li><a href=#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=遇到的问题>遇到的问题</a></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li></ul></div></details></div><div class=post-content><h2 id=证书的基本信息>证书的基本信息<a hidden class=anchor aria-hidden=true href=#证书的基本信息>#</a></h2><p>通常 cert 里面是包含了 OCSP 信息的，我们用 openssl 命令来看一下证书 <a href=/image/2022/ocsp/server.cert>server.cert</a> 里面有哪些东西。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ openssl x509 -noout -text -in server.cert
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Certificate:
</span></span><span class=line><span class=cl>    Data:
</span></span><span class=line><span class=cl>        Version: <span class=m>3</span> <span class=o>(</span>0x2<span class=o>)</span>
</span></span><span class=line><span class=cl>        Serial Number:
</span></span><span class=line><span class=cl>            6f:66:75:a4:db:bb:e6:5e:73:0a:7a:66:e7:41:a0:e1:18:4f:43:3f
</span></span><span class=line><span class=cl>        Signature Algorithm: sha384WithRSAEncryption
</span></span><span class=line><span class=cl>        Issuer: <span class=nv>CN</span> <span class=o>=</span> SJC-Services-Issuing-CA2-BETA2-G3, <span class=nv>O</span> <span class=o>=</span> Palo-Alto-Networks-Inc., <span class=nv>C</span> <span class=o>=</span> US
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Apr  <span class=m>8</span> 16:42:14 <span class=m>2022</span> GMT
</span></span><span class=line><span class=cl>            Not After : Mar  <span class=m>1</span> 21:34:11 <span class=m>2024</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span> <span class=o>=</span> *.ace-stg.tpcloud.paloaltonetworks.com, <span class=nv>OU</span> <span class=o>=</span> tpi-server, <span class=nv>O</span> <span class=o>=</span> Palo Alto Networks Inc., <span class=nv>L</span> <span class=o>=</span> Santa Clara, <span class=nv>ST</span> <span class=o>=</span> CA, <span class=nv>C</span> <span class=o>=</span> US
</span></span><span class=line><span class=cl>        Subject Public Key Info:
</span></span><span class=line><span class=cl>            Public Key Algorithm: rsaEncryption
</span></span><span class=line><span class=cl>                RSA Public-Key: <span class=o>(</span><span class=m>2048</span> bit<span class=o>)</span>
</span></span><span class=line><span class=cl>                Modulus:
</span></span><span class=line><span class=cl>                    00:d0:24:7d:e8:62:02:f9:97:a7:79:5e:82:24:56:
</span></span><span class=line><span class=cl>                 
</span></span><span class=line><span class=cl>                Exponent: <span class=m>65537</span> <span class=o>(</span>0x10001<span class=o>)</span>
</span></span><span class=line><span class=cl>        X509v3 extensions:
</span></span><span class=line><span class=cl>            X509v3 Basic Constraints: critical
</span></span><span class=line><span class=cl>                CA:FALSE
</span></span><span class=line><span class=cl>            X509v3 Authority Key Identifier:
</span></span><span class=line><span class=cl>                keyid:D3:B2:01:8C:86:DA:51:DD:38:BE:54:CF:AC:65:BA:4D:4F:C0:6C:27
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            Authority Information Access:
</span></span><span class=line><span class=cl>                CA Issuers - URI:https://crl.paloaltonetworks.com/beta2/beta2-pan-sjc-services-issuing-ca2-beta2-g3.crt
</span></span><span class=line><span class=cl>                OCSP - URI:http://ocsp-beta2.paloaltonetworks.com/ocsp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            X509v3 Subject Alternative Name:
</span></span><span class=line><span class=cl>                DNS:*.ace-stg.tpcloud.paloaltonetworks.com
</span></span><span class=line><span class=cl>            X509v3 Extended Key Usage:
</span></span><span class=line><span class=cl>                TLS Web Client Authentication, TLS Web Server Authentication
</span></span><span class=line><span class=cl>            X509v3 CRL Distribution Points:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                Full Name:
</span></span><span class=line><span class=cl>                  URI:http://crl.paloaltonetworks.com/beta2/beta2-pan-sjc-services-issuing-ca2-beta2-g3.crl
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            X509v3 Subject Key Identifier:
</span></span><span class=line><span class=cl>                58:20:5E:3A:63:59:8C:D8:72:24:EF:CA:DF:00:21:E9:04:20:6D:17
</span></span><span class=line><span class=cl>            X509v3 Key Usage: critical
</span></span><span class=line><span class=cl>                Digital Signature, Key Encipherment
</span></span><span class=line><span class=cl>    Signature Algorithm: sha384WithRSAEncryption
</span></span><span class=line><span class=cl>         9c:96:d9:48:e8:ad:75:be:48:59:f4:7c:0f:c6:de:ad:37:aa:
</span></span></code></pre></div><p>挑几个重要的字段：</p><ol><li>Serial Number, 证书的序列号。</li><li>Issuer, 证书是谁签发的。</li><li>Subject, 证书拥有者信息</li><li>Subject Public Key Info，证书的公钥信息。</li><li>Subject Key Identifier, 证书密钥标识符，它与 serial number都是唯一的，但是它用来区分一个证书拥有者的多对密钥。 一个指的是证书，一个指的是秘钥。</li><li>Authority Key Identifier, 证书颁发机构密钥标识符，</li><li>Authority Information Access, 这里就能找到 OCSP server 地址。</li></ol><h2 id=ocsp-如何验证一个证书>OCSP 如何验证一个证书<a hidden class=anchor aria-hidden=true href=#ocsp-如何验证一个证书>#</a></h2><p>了解了一个 cert 所包含的基本信息以后，那么 OSCP 是用哪些字段来验证 cert 的呢？</p><p>我们先看看 OCSP request 是什么样的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ openssl ocsp -no_nonce -CAfile ca.pem -issuer issuer.crt -cert server.cert -text -url http://ocsp-beta2.paloaltonetworks.com/ocsp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>OCSP Request Data:
</span></span><span class=line><span class=cl>    Version: <span class=m>1</span> <span class=o>(</span>0x0<span class=o>)</span>
</span></span><span class=line><span class=cl>    Requestor List:
</span></span><span class=line><span class=cl>        Certificate ID:
</span></span><span class=line><span class=cl>          Hash Algorithm: sha1
</span></span><span class=line><span class=cl>          Issuer Name Hash: FF96A6B9165E10A0205E8861423BCE9AACD1B8BA
</span></span><span class=line><span class=cl>          Issuer Key Hash: D3B2018C86DA51DD38BE54CFAC65BA4D4FC06C27
</span></span><span class=line><span class=cl>          Serial Number: 6F6675A4DBBBE65E730A7A66E741A0E1184F433F
</span></span></code></pre></div><p>可见两样东西非常重要：</p><ol><li>cert 的 <code>Serial Number</code>, 可以看到与上面的证书信息一致。</li><li><code>Issuer Key Hash</code> 对应上面证书信息的 <code>Authority Key Identifier</code> 字段。</li></ol><p>再回过头来看看这个 openssl 命令，其中 issuer.cert 就是证书信息中 <code>CA Issuers</code>，把它下载到本地； CAfile 指的是 issuer.cert 颁发者的 CA chain，这个需要自己去找到，一般也存在与 server.cert 中。</p><h2 id=遇到的问题>遇到的问题<a hidden class=anchor aria-hidden=true href=#遇到的问题>#</a></h2><p>我们有一个 <a href=/image/2022/ocsp/server-all.cert>server-all.cert</a>, 其中包含了 cert 本身和所有证书链。 但是 client 却无法连到 server，总是报 OCSP 验证不通过的错误。 但是，我们用上面的 openssl 命令验证这个证书，显示验证通过。</p><p>通过在 client 端用 tcpdump 抓到 OCSP 的 http 请求，我们看到如下信息</p><p><img loading=lazy src=/image/2022/ocsp/client-ocsp-req.png alt></p><p>对比我们 openssl 发出的请求，发现 <code>Issuer Key Hash</code> 字段的值不对。</p><p>似乎找到了引起 OCSP 验证失败的原因，但是为什么 client 端发出的 Issuer Key Hash 不对呢？ 一开始我想到了以下可能</p><ol><li>Client 从 cert chain 里提取 issuer 错误。 —— 似乎不可能，因为这部分代码是共享的，其他服务也在用，他们没有问题。</li><li>Server cert chain 被篡改了，比如 client 到 server 之间有防火墙开启了 TLS decryption，作为中间人自己签发了证书。 —— 经过 QA 确认，lab 没有做过改动，且其他服务也正常。</li></ol><p>那么这个错误的 Issuer Key Hash 是从哪来的呢？</p><p>没办法，只能在 client 端捕获 TLS 连接看看 client 到底收到了什么样的 cert chain。 由于开启了 TLS 1.3，现在连传递证书都是在加密连接里的，所以需要解密。</p><p>最终我们捕获了 <a href=/image/2022/ocsp/certs.pcap>certs.pcap</a> 和对应的 <a href=/image/2022/ocsp/icd-tls-secrets.txt>secrets</a>。</p><p>用 wireshark 打开后，我们看到第一个 cert 是对的，第二个 cert 的 serial number 正是 Client 发出的 OCSP 的 <code>Issuer Key Hash</code> 。</p><p>看来 client 端代码的行为是<code>默认把 cert chain 的第二个 cert 当成 issuer</code>，而事实上，第四个 cert 才是正确的 issuer。</p><p>为什么 server 发来的 cert chain 顺序是乱的呢？ 这个时候我们回过头去查看我们的 <a href=/image/2022/ocsp/server-all.cert>server-all.cert</a>，原来 IT 在生成 cert 的时候，把 issuer 到 Root CA 的顺序弄反了。 对于 openssl 这样的工具，它会自动调整 cert chain，并找到正确的issuer，然后发出 OCSP request。 而对于其他一些实现，特别是自己实现的 OCSP 库，没有找到正确的 issuer，而是默认拿第二个。</p><p>看到这里，基本破案了，我们手动把 server.cert 顺序调整好，client 端能通过 OCSP 验证了。</p><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>如果不是因为抓到了 client 端 TLS 建立的握手信息，我们很难明白这个错误的 <code>Issuer Key Hash</code> 是从哪来的？ 因为大多数时候，我们不会打开 server-all.cert 去一个一个看里面的 cert。 之前把很多精力放在认为 server cert chain 被中间人篡改了。</p><p>因为 TLS 1.3 把握手信息也加密了，所以增加了我们抓包的难度，但直观的看到 client 到底收到了什么 cert 能很快帮助我们发现问题。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://runzhen.github.io/tags/ocsp/>Ocsp</a></li></ul><nav class=paginav><a class=prev href=https://runzhen.github.io/posts/etcd-raft-leader-election/><span class=title>« Prev</span><br><span>etcd-raft 源码阅读之 Leader 的选举</span>
</a><a class=next href=https://runzhen.github.io/posts/go-redis-latency-debug/><span class=title>Next »</span><br><span>记一次 go-redis 的 debug 过程</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 记一次 cert chain 乱序导致 OCSP 验证失败 on x" href="https://x.com/intent/tweet/?text=%e8%ae%b0%e4%b8%80%e6%ac%a1%20cert%20chain%20%e4%b9%b1%e5%ba%8f%e5%af%bc%e8%87%b4%20OCSP%20%e9%aa%8c%e8%af%81%e5%a4%b1%e8%b4%a5&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2focsp-verify-certificate%2f&amp;hashtags=ocsp"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 记一次 cert chain 乱序导致 OCSP 验证失败 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2focsp-verify-certificate%2f&amp;title=%e8%ae%b0%e4%b8%80%e6%ac%a1%20cert%20chain%20%e4%b9%b1%e5%ba%8f%e5%af%bc%e8%87%b4%20OCSP%20%e9%aa%8c%e8%af%81%e5%a4%b1%e8%b4%a5&amp;summary=%e8%ae%b0%e4%b8%80%e6%ac%a1%20cert%20chain%20%e4%b9%b1%e5%ba%8f%e5%af%bc%e8%87%b4%20OCSP%20%e9%aa%8c%e8%af%81%e5%a4%b1%e8%b4%a5&amp;source=https%3a%2f%2frunzhen.github.io%2fposts%2focsp-verify-certificate%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 记一次 cert chain 乱序导致 OCSP 验证失败 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frunzhen.github.io%2fposts%2focsp-verify-certificate%2f&title=%e8%ae%b0%e4%b8%80%e6%ac%a1%20cert%20chain%20%e4%b9%b1%e5%ba%8f%e5%af%bc%e8%87%b4%20OCSP%20%e9%aa%8c%e8%af%81%e5%a4%b1%e8%b4%a5"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 记一次 cert chain 乱序导致 OCSP 验证失败 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frunzhen.github.io%2fposts%2focsp-verify-certificate%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 记一次 cert chain 乱序导致 OCSP 验证失败 on whatsapp" href="https://api.whatsapp.com/send?text=%e8%ae%b0%e4%b8%80%e6%ac%a1%20cert%20chain%20%e4%b9%b1%e5%ba%8f%e5%af%bc%e8%87%b4%20OCSP%20%e9%aa%8c%e8%af%81%e5%a4%b1%e8%b4%a5%20-%20https%3a%2f%2frunzhen.github.io%2fposts%2focsp-verify-certificate%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 记一次 cert chain 乱序导致 OCSP 验证失败 on telegram" href="https://telegram.me/share/url?text=%e8%ae%b0%e4%b8%80%e6%ac%a1%20cert%20chain%20%e4%b9%b1%e5%ba%8f%e5%af%bc%e8%87%b4%20OCSP%20%e9%aa%8c%e8%af%81%e5%a4%b1%e8%b4%a5&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2focsp-verify-certificate%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 记一次 cert chain 乱序导致 OCSP 验证失败 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e8%ae%b0%e4%b8%80%e6%ac%a1%20cert%20chain%20%e4%b9%b1%e5%ba%8f%e5%af%bc%e8%87%b4%20OCSP%20%e9%aa%8c%e8%af%81%e5%a4%b1%e8%b4%a5&u=https%3a%2f%2frunzhen.github.io%2fposts%2focsp-verify-certificate%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://runzhen.github.io/>Mind in the Wind</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>