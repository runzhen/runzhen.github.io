<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go Assembly - 1 | Mind in the Wind</title>
<meta name=keywords content="golang"><meta name=description content="寄存器 学过 X86 汇编的同学都知道汇编有AX，BX等寄存器，除此之外，Go 还添加了 PC、FP、SP、SB四个伪寄存器。如下图所示，其中第二列为 GO 添加的4 个伪寄存器，第三列为 X86 寄存器。
看到这里，尘封已久的汇编语言知识需要拿出来复习一下。
FLAGS 是状态寄存器。 IP 是指令寄存器。 AX、BX、CX、DX、SI、DI、BP、SP 是通用寄存器。在X86-64中又增加了八个以R8-R15 方式命名的通用寄存器。 另外 GO 的 4 个伪寄存器作用如下：
FP: Frame pointer：伪FP寄存器对应函数的栈帧指针，一般用来访问函数的参数和返回值；golang语言中，函数的参数和返回值，函数中的局部变量，函数中调用子函数的参数和返回值都是存储在栈中的，我们把这一段栈内存称为栈帧（frame），伪FP寄存器对应栈帧的底部，但是伪FP只包括函数的参数和返回值这部分内存，其他部分由伪SP寄存器表示；注意golang中函数的返回值也是通过栈帧返回的，这也是golang函数可以有多个返回值的原因； PC: Program counter：指令计数器，用于分支和跳转，它是汇编的IP寄存器的别名； SB: Static base pointer：一般用于声明函数或者全局变量，对应代码区（text）内存段底部； SP: Stack pointer：指向当前栈帧的局部变量的开始位置，一般用来引用函数的局部变量，这里需要注意汇编中也有一个SP寄存器，它们的区别是：1.伪SP寄存器指向栈帧（不包括函数参数和返回值部分）的底部，真SP寄存器对应栈的顶部；所以伪SP寄存器一般用于寻址函数局部变量，真SP寄存器一般用于调用子函数时，寻址子函数的参数和返回值（后面会有具体示例演示）；2.当需要区分伪寄存器和真寄存器的时候只需要记住一点：伪寄存器一般需要一个标识符和偏移量为前缀，如果没有标识符前缀则是真寄存器。比如(SP)、+8(SP)没有标识符前缀为真SP寄存器，而a(SP)、b+8(SP)有标识符为前缀表示伪寄存器； Symbols 符号 有些符号比如 R1、LR 是不同架构预定义的寄存器。除此之外，还有 GO 定义的 4 个伪寄存器。
FP: Frame pointer: arguments and locals. PC: Program counter: jumps and branches. SB: Static base pointer: global symbols. SP: Stack pointer: the highest address within the local stack frame."><meta name=author content="Me"><link rel=canonical href=https://runzhen.github.io/posts/go-asm1/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.103f87022495ee8537d399aa50bf7e2203f4c653b709467478c7fd5a58182364.css integrity="sha256-ED+HAiSV7oU305mqUL9+IgP0xlO3CUZ0eMf9WlgYI2Q=" rel="preload stylesheet" as=style><link rel=icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://runzhen.github.io/posts/go-asm1/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Go Assembly - 1"><meta property="og:description" content="寄存器 学过 X86 汇编的同学都知道汇编有AX，BX等寄存器，除此之外，Go 还添加了 PC、FP、SP、SB四个伪寄存器。如下图所示，其中第二列为 GO 添加的4 个伪寄存器，第三列为 X86 寄存器。
看到这里，尘封已久的汇编语言知识需要拿出来复习一下。
FLAGS 是状态寄存器。 IP 是指令寄存器。 AX、BX、CX、DX、SI、DI、BP、SP 是通用寄存器。在X86-64中又增加了八个以R8-R15 方式命名的通用寄存器。 另外 GO 的 4 个伪寄存器作用如下：
FP: Frame pointer：伪FP寄存器对应函数的栈帧指针，一般用来访问函数的参数和返回值；golang语言中，函数的参数和返回值，函数中的局部变量，函数中调用子函数的参数和返回值都是存储在栈中的，我们把这一段栈内存称为栈帧（frame），伪FP寄存器对应栈帧的底部，但是伪FP只包括函数的参数和返回值这部分内存，其他部分由伪SP寄存器表示；注意golang中函数的返回值也是通过栈帧返回的，这也是golang函数可以有多个返回值的原因； PC: Program counter：指令计数器，用于分支和跳转，它是汇编的IP寄存器的别名； SB: Static base pointer：一般用于声明函数或者全局变量，对应代码区（text）内存段底部； SP: Stack pointer：指向当前栈帧的局部变量的开始位置，一般用来引用函数的局部变量，这里需要注意汇编中也有一个SP寄存器，它们的区别是：1.伪SP寄存器指向栈帧（不包括函数参数和返回值部分）的底部，真SP寄存器对应栈的顶部；所以伪SP寄存器一般用于寻址函数局部变量，真SP寄存器一般用于调用子函数时，寻址子函数的参数和返回值（后面会有具体示例演示）；2.当需要区分伪寄存器和真寄存器的时候只需要记住一点：伪寄存器一般需要一个标识符和偏移量为前缀，如果没有标识符前缀则是真寄存器。比如(SP)、+8(SP)没有标识符前缀为真SP寄存器，而a(SP)、b+8(SP)有标识符为前缀表示伪寄存器； Symbols 符号 有些符号比如 R1、LR 是不同架构预定义的寄存器。除此之外，还有 GO 定义的 4 个伪寄存器。
FP: Frame pointer: arguments and locals. PC: Program counter: jumps and branches. SB: Static base pointer: global symbols. SP: Stack pointer: the highest address within the local stack frame."><meta property="og:type" content="article"><meta property="og:url" content="https://runzhen.github.io/posts/go-asm1/"><meta property="og:image" content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-23T00:00:00+00:00"><meta property="article:modified_time" content="2022-10-23T00:00:00+00:00"><meta property="og:site_name" content="Mind in the Wind"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Go Assembly - 1"><meta name=twitter:description content="寄存器 学过 X86 汇编的同学都知道汇编有AX，BX等寄存器，除此之外，Go 还添加了 PC、FP、SP、SB四个伪寄存器。如下图所示，其中第二列为 GO 添加的4 个伪寄存器，第三列为 X86 寄存器。
看到这里，尘封已久的汇编语言知识需要拿出来复习一下。
FLAGS 是状态寄存器。 IP 是指令寄存器。 AX、BX、CX、DX、SI、DI、BP、SP 是通用寄存器。在X86-64中又增加了八个以R8-R15 方式命名的通用寄存器。 另外 GO 的 4 个伪寄存器作用如下：
FP: Frame pointer：伪FP寄存器对应函数的栈帧指针，一般用来访问函数的参数和返回值；golang语言中，函数的参数和返回值，函数中的局部变量，函数中调用子函数的参数和返回值都是存储在栈中的，我们把这一段栈内存称为栈帧（frame），伪FP寄存器对应栈帧的底部，但是伪FP只包括函数的参数和返回值这部分内存，其他部分由伪SP寄存器表示；注意golang中函数的返回值也是通过栈帧返回的，这也是golang函数可以有多个返回值的原因； PC: Program counter：指令计数器，用于分支和跳转，它是汇编的IP寄存器的别名； SB: Static base pointer：一般用于声明函数或者全局变量，对应代码区（text）内存段底部； SP: Stack pointer：指向当前栈帧的局部变量的开始位置，一般用来引用函数的局部变量，这里需要注意汇编中也有一个SP寄存器，它们的区别是：1.伪SP寄存器指向栈帧（不包括函数参数和返回值部分）的底部，真SP寄存器对应栈的顶部；所以伪SP寄存器一般用于寻址函数局部变量，真SP寄存器一般用于调用子函数时，寻址子函数的参数和返回值（后面会有具体示例演示）；2.当需要区分伪寄存器和真寄存器的时候只需要记住一点：伪寄存器一般需要一个标识符和偏移量为前缀，如果没有标识符前缀则是真寄存器。比如(SP)、+8(SP)没有标识符前缀为真SP寄存器，而a(SP)、b+8(SP)有标识符为前缀表示伪寄存器； Symbols 符号 有些符号比如 R1、LR 是不同架构预定义的寄存器。除此之外，还有 GO 定义的 4 个伪寄存器。
FP: Frame pointer: arguments and locals. PC: Program counter: jumps and branches. SB: Static base pointer: global symbols. SP: Stack pointer: the highest address within the local stack frame."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://runzhen.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Go Assembly - 1","item":"https://runzhen.github.io/posts/go-asm1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go Assembly - 1","name":"Go Assembly - 1","description":"寄存器 学过 X86 汇编的同学都知道汇编有AX，BX等寄存器，除此之外，Go 还添加了 PC、FP、SP、SB四个伪寄存器。如下图所示，其中第二列为 GO 添加的4 个伪寄存器，第三列为 X86 寄存器。\n看到这里，尘封已久的汇编语言知识需要拿出来复习一下。\nFLAGS 是状态寄存器。 IP 是指令寄存器。 AX、BX、CX、DX、SI、DI、BP、SP 是通用寄存器。在X86-64中又增加了八个以R8-R15 方式命名的通用寄存器。 另外 GO 的 4 个伪寄存器作用如下：\nFP: Frame pointer：伪FP寄存器对应函数的栈帧指针，一般用来访问函数的参数和返回值；golang语言中，函数的参数和返回值，函数中的局部变量，函数中调用子函数的参数和返回值都是存储在栈中的，我们把这一段栈内存称为栈帧（frame），伪FP寄存器对应栈帧的底部，但是伪FP只包括函数的参数和返回值这部分内存，其他部分由伪SP寄存器表示；注意golang中函数的返回值也是通过栈帧返回的，这也是golang函数可以有多个返回值的原因； PC: Program counter：指令计数器，用于分支和跳转，它是汇编的IP寄存器的别名； SB: Static base pointer：一般用于声明函数或者全局变量，对应代码区（text）内存段底部； SP: Stack pointer：指向当前栈帧的局部变量的开始位置，一般用来引用函数的局部变量，这里需要注意汇编中也有一个SP寄存器，它们的区别是：1.伪SP寄存器指向栈帧（不包括函数参数和返回值部分）的底部，真SP寄存器对应栈的顶部；所以伪SP寄存器一般用于寻址函数局部变量，真SP寄存器一般用于调用子函数时，寻址子函数的参数和返回值（后面会有具体示例演示）；2.当需要区分伪寄存器和真寄存器的时候只需要记住一点：伪寄存器一般需要一个标识符和偏移量为前缀，如果没有标识符前缀则是真寄存器。比如(SP)、+8(SP)没有标识符前缀为真SP寄存器，而a(SP)、b+8(SP)有标识符为前缀表示伪寄存器； Symbols 符号 有些符号比如 R1、LR 是不同架构预定义的寄存器。除此之外，还有 GO 定义的 4 个伪寄存器。\nFP: Frame pointer: arguments and locals. PC: Program counter: jumps and branches. SB: Static base pointer: global symbols. SP: Stack pointer: the highest address within the local stack frame.","keywords":["golang"],"articleBody":"寄存器 学过 X86 汇编的同学都知道汇编有AX，BX等寄存器，除此之外，Go 还添加了 PC、FP、SP、SB四个伪寄存器。如下图所示，其中第二列为 GO 添加的4 个伪寄存器，第三列为 X86 寄存器。\n看到这里，尘封已久的汇编语言知识需要拿出来复习一下。\nFLAGS 是状态寄存器。 IP 是指令寄存器。 AX、BX、CX、DX、SI、DI、BP、SP 是通用寄存器。在X86-64中又增加了八个以R8-R15 方式命名的通用寄存器。 另外 GO 的 4 个伪寄存器作用如下：\nFP: Frame pointer：伪FP寄存器对应函数的栈帧指针，一般用来访问函数的参数和返回值；golang语言中，函数的参数和返回值，函数中的局部变量，函数中调用子函数的参数和返回值都是存储在栈中的，我们把这一段栈内存称为栈帧（frame），伪FP寄存器对应栈帧的底部，但是伪FP只包括函数的参数和返回值这部分内存，其他部分由伪SP寄存器表示；注意golang中函数的返回值也是通过栈帧返回的，这也是golang函数可以有多个返回值的原因； PC: Program counter：指令计数器，用于分支和跳转，它是汇编的IP寄存器的别名； SB: Static base pointer：一般用于声明函数或者全局变量，对应代码区（text）内存段底部； SP: Stack pointer：指向当前栈帧的局部变量的开始位置，一般用来引用函数的局部变量，这里需要注意汇编中也有一个SP寄存器，它们的区别是：1.伪SP寄存器指向栈帧（不包括函数参数和返回值部分）的底部，真SP寄存器对应栈的顶部；所以伪SP寄存器一般用于寻址函数局部变量，真SP寄存器一般用于调用子函数时，寻址子函数的参数和返回值（后面会有具体示例演示）；2.当需要区分伪寄存器和真寄存器的时候只需要记住一点：伪寄存器一般需要一个标识符和偏移量为前缀，如果没有标识符前缀则是真寄存器。比如(SP)、+8(SP)没有标识符前缀为真SP寄存器，而a(SP)、b+8(SP)有标识符为前缀表示伪寄存器； Symbols 符号 有些符号比如 R1、LR 是不同架构预定义的寄存器。除此之外，还有 GO 定义的 4 个伪寄存器。\nFP: Frame pointer: arguments and locals. PC: Program counter: jumps and branches. SB: Static base pointer: global symbols. SP: Stack pointer: the highest address within the local stack frame. 所有用户定义的符号都可以写成 FP 或者 SB + offset 的形式。\nSB 可以被认为是内存地址，所以 foo(SB) 是 foo 在内存中的地址。 foo+4(SB) 表示 foo 地址后的 4 个字节。\nFP 是 virtual frame pointer，用来指示函数参数。因此，0(FP) 表示函数的第一个参数,8(FP) 表示函数的第二个参数 (on a 64-bit machine)，通常，还会在前面加上参数的名字 比如 first_arg+0(FP) and second_arg+8(FP) 。与直接用 SB 不同的是，SB 是针对符号的偏移量，FP 是针对 frame 的偏移量。\nSP 是 virtual stack pointer, 指向每个 frame 本地的变量，以及准备向函数传递的参数。他始终指向 local frame 的最高地址，因此都是带 “-” 号的，比如 x-8(SP) y-4(SP) 。\n有些架构上本身就有 SP 和 PC 物理寄存器，Go assembler 仍然按照伪寄存器对待 SP 和 PC ，而把物理寄存器 SP 和 PC 用 R前缀表示，比如 R13, R15 。\n所有的指令，寄存器，汇编指令都用大写表示。\nGo Assembler 不支持点号和 slash，因此用 period 和 division slash 表示，比如 fmt.Printf or math/rand.Int 会写成 fmt·Printfand math∕rand·Int 。\nDirectives 指令 常量 $1 // 十进制 $0xf4f8fcff // 十六进制 $1.5 // 浮点数 $'a' // 字符 $\"abcd\" // 字符串 TEXT 定义函数符号 TEXT symbol(SB), [flags,] $framesize[-argsize] 下面是定义一个函数的例子\nTEXT runtime·profileloop(SB),NOSPLIT,$8 MOVQ\t$runtime·profileloop1(SB), CX MOVQ\tCX, 0(SP) CALL\truntime·externalthreadhandler(SB) RET TEXT 指令后面是函数符号，后面是参数 和一个常量的 frame size 。 通常，frame size 后面还有减号加数字，注意，这里的减号只是个标记不是减的意思，比如 frame size $24-8 表示这个函数有 24 字节的 frame，并且有 8 字节的参数，这些参数在 caller 的 frame 上。\nNOSPLIT 表示可以省略这个减号+参数，如果没有 NOSPLIT 则减号+参数必须写上。\nDATA 初始化包变量 DATA\tsymbol+offset(SB)/width, value 其中symbol为变量在汇编语言中对应的标识符，offset是符号开始地址的偏移量，width是要初始化内存的宽度大小，value是要初始化的值。\nGLOBL 将符号导出 例如将全局变量导出\nGLOBL symbol(SB), width 其中symbol对应汇编中符号的名字，width为符号对应内存的大小.\n例子1：\n结合DATA和GLOBL 指令，我们就可以初始化并导出一个全局变量:\nGLOBL ·Id, $8 DATA ·Id+0(SB)/1,$0x37 DATA ·Id+1(SB)/1,$0x25 DATA ·Id+2(SB)/1,$0x00 DATA ·Id+3(SB)/1,$0x00 DATA ·Id+4(SB)/1,$0x00 DATA ·Id+5(SB)/1,$0x00 DATA ·Id+6(SB)/1,$0x00 DATA ·Id+7(SB)/1,$0x00 例子2：\nDATA divtab\u003c\u003e+0x00(SB)/4, $0xf4f8fcff DATA divtab\u003c\u003e+0x04(SB)/4, $0xe6eaedf0 ... DATA divtab\u003c\u003e+0x3c(SB)/4, $0x81828384 GLOBL divtab\u003c\u003e(SB), RODATA, $64 GLOBL runtime·tlsoffset(SB), NOPTR, $4 声明了一个只读的 64 字节 table，每个元素是 4 字节的整数。 runtime·tlsoffset 是一个3字节的空指针。 NOPTR 这样的符号定义在 textflag.h 文件中。\nNOPROF = 1 (For TEXT items.) Don't profile the marked function. This flag is deprecated. DUPOK = 2 It is legal to have multiple instances of this symbol in a single binary. The linker will choose one of the duplicates to use. NOSPLIT = 4 (For TEXT items.) Don't insert the preamble to check if the stack must be split. The frame for the routine, plus anything it calls, must fit in the spare space remaining in the current stack segment. Used to protect routines such as the stack splitting code itself. RODATA = 8 (For DATA and GLOBL items.) Put this data in a read-only section. NOPTR = 16 (For DATA and GLOBL items.) This data contains no pointers and therefore does not need to be scanned by the garbage collector. WRAPPER = 32 (For TEXT items.) This is a wrapper function and should not count as disabling recover. NEEDCTXT = 64 (For TEXT items.) This function is a closure so it uses its incoming context register. LOCAL = 128 This symbol is local to the dynamic shared object. TLSBSS = 256 (For DATA and GLOBL items.) Put this data in thread local storage. NOFRAME = 512 (For TEXT items.) Do not insert instructions to allocate a stack frame and save/restore the return address, even if this is not a leaf function. Only valid on functions that declare a frame size of 0. TOPFRAME = 2048 (For TEXT items.) Function is the outermost frame of the call stack. Traceback should stop at this function. 其他常用命令 SUBQ $0x18, SP // 分配函数栈，操作数 8 个字节 ADDQ $0x18, SP // 清除函数栈，操作数据 8 个字节 MOVB $1, DI // 拷贝 1个字节 MOVW $0x10, BX // 拷贝 2 个字节 MOVD $1, DX // 拷贝 4 个字节 MOVQ $-10, AX // 拷贝 8 个字节 ADDQ AX, BX // BX = BX + AX 存 BX SUBQ AX, BX // BX = BX - AX 存 BX IMULQ AX, BX // BX = BX * AX 存 BX MOVQ AX, BX // BX = AX 将 AX 中的值赋给 BX MOVQ (AX), BX // BX = *AX 加载 AX 中指向内存地址的值给 BX MOVQ 16(AX), BX // BX = *(AX + 16) 偏移 16 个字节后地址中的值 参考资料 https://go.dev/doc/asm https://segmentfault.com/a/1190000041159550 ","wordCount":"663","inLanguage":"en","image":"https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2022-10-23T00:00:00Z","dateModified":"2022-10-23T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://runzhen.github.io/posts/go-asm1/"},"publisher":{"@type":"Organization","name":"Mind in the Wind","logo":{"@type":"ImageObject","url":"https://runzhen.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://runzhen.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://runzhen.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://runzhen.github.io/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://runzhen.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://runzhen.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://runzhen.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Go Assembly - 1</h1><div class=post-meta><span title='2022-10-23 00:00:00 +0000 UTC'>2022-10-23</span>&nbsp;·&nbsp;Me</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%af%84%e5%ad%98%e5%99%a8 aria-label=寄存器>寄存器</a></li><li><a href=#symbols-%e7%ac%a6%e5%8f%b7 aria-label="Symbols 符号">Symbols 符号</a></li><li><a href=#directives-%e6%8c%87%e4%bb%a4 aria-label="Directives 指令">Directives 指令</a><ul><li><a href=#%e5%b8%b8%e9%87%8f aria-label=常量>常量</a></li><li><a href=#text-%e5%ae%9a%e4%b9%89%e5%87%bd%e6%95%b0%e7%ac%a6%e5%8f%b7 aria-label="TEXT 定义函数符号">TEXT 定义函数符号</a></li><li><a href=#data-%e5%88%9d%e5%a7%8b%e5%8c%96%e5%8c%85%e5%8f%98%e9%87%8f aria-label="DATA 初始化包变量">DATA 初始化包变量</a></li><li><a href=#globl-%e5%b0%86%e7%ac%a6%e5%8f%b7%e5%af%bc%e5%87%ba aria-label="GLOBL 将符号导出">GLOBL 将符号导出</a></li><li><a href=#%e5%85%b6%e4%bb%96%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4 aria-label=其他常用命令>其他常用命令</a></li></ul></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=参考资料>参考资料</a></li></ul></div></details></div><div class=post-content><h2 id=寄存器>寄存器<a hidden class=anchor aria-hidden=true href=#寄存器>#</a></h2><p>学过 X86 汇编的同学都知道汇编有AX，BX等寄存器，除此之外，Go 还添加了 PC、FP、SP、SB四个伪寄存器。如下图所示，其中第二列为 GO 添加的4 个伪寄存器，第三列为 X86 寄存器。</p><p><img loading=lazy src=/image/2022/go-asm1.png alt=Untitled></p><p>看到这里，尘封已久的汇编语言知识需要拿出来复习一下。</p><ul><li>FLAGS 是状态寄存器。</li><li>IP 是指令寄存器。</li><li>AX、BX、CX、DX、SI、DI、BP、SP 是通用寄存器。在X86-64中又增加了八个以<code>R8-R15</code> 方式命名的通用寄存器。</li></ul><p>另外 GO 的 4 个伪寄存器作用如下：</p><ul><li><code>FP: Frame pointer</code>：伪FP寄存器对应函数的栈帧指针，一般用来访问函数的参数和返回值；golang语言中，函数的参数和返回值，函数中的局部变量，函数中调用子函数的参数和返回值都是存储在栈中的，我们把这一段栈内存称为栈帧（frame），伪FP寄存器对应栈帧的底部，但是伪FP只包括函数的参数和返回值这部分内存，其他部分由伪SP寄存器表示；注意golang中函数的返回值也是通过栈帧返回的，这也是golang函数可以有多个返回值的原因；</li><li><code>PC: Program counter</code>：指令计数器，用于分支和跳转，它是汇编的IP寄存器的别名；</li><li><code>SB: Static base pointer</code>：一般用于声明函数或者全局变量，对应代码区（text）内存段底部；</li><li><code>SP: Stack pointer</code>：指向当前栈帧的局部变量的开始位置，一般用来引用函数的局部变量，这里需要注意汇编中也有一个SP寄存器，它们的区别是：1.伪SP寄存器指向栈帧（不包括函数参数和返回值部分）的底部，真SP寄存器对应栈的顶部；所以伪SP寄存器一般用于寻址函数局部变量，真SP寄存器一般用于调用子函数时，寻址子函数的参数和返回值（后面会有具体示例演示）；2.当需要区分伪寄存器和真寄存器的时候只需要记住一点：伪寄存器一般需要一个标识符和偏移量为前缀，如果没有标识符前缀则是真寄存器。比如(SP)、+8(SP)没有标识符前缀为真SP寄存器，而a(SP)、b+8(SP)有标识符为前缀表示伪寄存器；</li></ul><h2 id=symbols-符号>Symbols 符号<a hidden class=anchor aria-hidden=true href=#symbols-符号>#</a></h2><p>有些符号比如 R1、LR 是不同架构预定义的寄存器。除此之外，还有 GO 定义的 4 个伪寄存器。</p><ul><li><code>FP</code>: Frame pointer: arguments and locals.</li><li><code>PC</code>: Program counter: jumps and branches.</li><li><code>SB</code>: Static base pointer: global symbols.</li><li><code>SP</code>: Stack pointer: the highest address within the local stack frame.</li></ul><p>所有用户定义的符号都可以写成 FP 或者 SB + offset 的形式。</p><p><strong>SB</strong> 可以被认为是内存地址，所以 <code>foo(SB)</code> 是 foo 在内存中的地址。 <code>foo+4(SB)</code> 表示 foo 地址后的 4 个字节。</p><p><strong>FP</strong> 是 virtual frame pointer，用来指示函数参数。因此，<code>0(FP)</code> 表示函数的第一个参数,<code>8(FP)</code> 表示函数的第二个参数 (on a 64-bit machine)，通常，还会在前面加上参数的名字 比如 <code>first_arg+0(FP)</code>
and <code>second_arg+8(FP)</code> 。与直接用 SB 不同的是，SB 是针对符号的偏移量，FP 是针对 frame 的偏移量。</p><p><strong>SP</strong> 是 virtual stack pointer, 指向每个 frame 本地的变量，以及准备向函数传递的参数。他始终指向 local frame 的最高地址，因此都是带 “-” 号的，比如 <code>x-8(SP)</code> <code>y-4(SP)</code> 。</p><p>有些架构上本身就有 SP 和 PC 物理寄存器，Go assembler 仍然按照伪寄存器对待 SP 和 PC ，而把物理寄存器 SP 和 PC 用 R前缀表示，比如 R13, R15 。</p><p>所有的指令，寄存器，汇编指令都用大写表示。</p><p>Go Assembler 不支持点号和 slash，因此用 period 和 division slash 表示，比如 <code>fmt.Printf</code> or <code>math/rand.Int</code> 会写成 <code>fmt·Printf</code>and <code>math∕rand·Int</code> 。</p><h2 id=directives-指令>Directives 指令<a hidden class=anchor aria-hidden=true href=#directives-指令>#</a></h2><h3 id=常量>常量<a hidden class=anchor aria-hidden=true href=#常量>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span><span class=mi>1</span>           <span class=c1>// 十进制
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>$</span><span class=mh>0xf4f8fcff</span>  <span class=c1>// 十六进制
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>$</span><span class=mf>1.5</span>         <span class=c1>// 浮点数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>$</span><span class=sc>&#39;a&#39;</span>         <span class=c1>// 字符
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>$</span><span class=s>&#34;abcd&#34;</span>      <span class=c1>// 字符串
</span></span></span></code></pre></div><h3 id=text-定义函数符号><code>TEXT</code> 定义函数符号<a hidden class=anchor aria-hidden=true href=#text-定义函数符号>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>TEXT</span> <span class=nf>symbol</span><span class=p>(</span><span class=nx>SB</span><span class=p>),</span> <span class=p>[</span><span class=nx>flags</span><span class=p>,]</span> <span class=err>$</span><span class=nx>framesize</span><span class=p>[</span><span class=o>-</span><span class=nx>argsize</span><span class=p>]</span>
</span></span></code></pre></div><p>下面是定义一个函数的例子</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>TEXT</span> <span class=nx>runtime</span><span class=err>·</span><span class=nf>profileloop</span><span class=p>(</span><span class=nx>SB</span><span class=p>),</span><span class=nx>NOSPLIT</span><span class=p>,</span><span class=err>$</span><span class=mi>8</span>
</span></span><span class=line><span class=cl>	<span class=nx>MOVQ</span>	<span class=err>$</span><span class=nx>runtime</span><span class=err>·</span><span class=nf>profileloop1</span><span class=p>(</span><span class=nx>SB</span><span class=p>),</span> <span class=nx>CX</span>
</span></span><span class=line><span class=cl>	<span class=nx>MOVQ</span>	<span class=nx>CX</span><span class=p>,</span> <span class=mi>0</span><span class=p>(</span><span class=nx>SP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>CALL</span>	<span class=nx>runtime</span><span class=err>·</span><span class=nf>externalthreadhandler</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>RET</span>
</span></span></code></pre></div><p>TEXT 指令后面是函数符号，后面是参数 和一个常量的 frame size 。 通常，frame size 后面还有减号加数字，注意，这里的减号只是个标记不是减的意思，比如 frame size <code>$24-8</code> 表示这个函数有 24 字节的 frame，并且有 8 字节的参数，这些参数在 caller 的 frame 上。</p><p><code>NOSPLIT</code> 表示可以省略这个减号+参数，如果没有 <code>NOSPLIT</code> 则减号+参数必须写上。</p><h3 id=data-初始化包变量><code>DATA</code> 初始化包变量<a hidden class=anchor aria-hidden=true href=#data-初始化包变量>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>DATA</span>	<span class=nx>symbol</span><span class=o>+</span><span class=nf>offset</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=nx>width</span><span class=p>,</span> <span class=nx>value</span>
</span></span></code></pre></div><p>其中<code>symbol</code>为变量在汇编语言中对应的标识符，<code>offset</code>是符号开始地址的偏移量，<code>width</code>是要初始化内存的宽度大小，<code>value</code>是要初始化的值。</p><h3 id=globl-将符号导出><code>GLOBL</code> 将符号导出<a hidden class=anchor aria-hidden=true href=#globl-将符号导出>#</a></h3><p>例如将全局变量导出</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>GLOBL</span> <span class=nf>symbol</span><span class=p>(</span><span class=nx>SB</span><span class=p>),</span> <span class=nx>width</span>
</span></span></code></pre></div><p>其中<code>symbol</code>对应汇编中符号的名字，<code>width</code>为符号对应内存的大小.</p><p>例子1：</p><p>结合<code>DATA</code>和<code>GLOBL</code> 指令，我们就可以初始化并导出一个全局变量:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>GLOBL</span> <span class=err>·</span><span class=nx>Id</span><span class=p>,</span> <span class=err>$</span><span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=nx>DATA</span> <span class=err>·</span><span class=nx>Id</span><span class=o>+</span><span class=mi>0</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>1</span><span class=p>,</span><span class=err>$</span><span class=mh>0x37</span>
</span></span><span class=line><span class=cl><span class=nx>DATA</span> <span class=err>·</span><span class=nx>Id</span><span class=o>+</span><span class=mi>1</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>1</span><span class=p>,</span><span class=err>$</span><span class=mh>0x25</span>
</span></span><span class=line><span class=cl><span class=nx>DATA</span> <span class=err>·</span><span class=nx>Id</span><span class=o>+</span><span class=mi>2</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>1</span><span class=p>,</span><span class=err>$</span><span class=mh>0x00</span>
</span></span><span class=line><span class=cl><span class=nx>DATA</span> <span class=err>·</span><span class=nx>Id</span><span class=o>+</span><span class=mi>3</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>1</span><span class=p>,</span><span class=err>$</span><span class=mh>0x00</span>
</span></span><span class=line><span class=cl><span class=nx>DATA</span> <span class=err>·</span><span class=nx>Id</span><span class=o>+</span><span class=mi>4</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>1</span><span class=p>,</span><span class=err>$</span><span class=mh>0x00</span>
</span></span><span class=line><span class=cl><span class=nx>DATA</span> <span class=err>·</span><span class=nx>Id</span><span class=o>+</span><span class=mi>5</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>1</span><span class=p>,</span><span class=err>$</span><span class=mh>0x00</span>
</span></span><span class=line><span class=cl><span class=nx>DATA</span> <span class=err>·</span><span class=nx>Id</span><span class=o>+</span><span class=mi>6</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>1</span><span class=p>,</span><span class=err>$</span><span class=mh>0x00</span>
</span></span><span class=line><span class=cl><span class=nx>DATA</span> <span class=err>·</span><span class=nx>Id</span><span class=o>+</span><span class=mi>7</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>1</span><span class=p>,</span><span class=err>$</span><span class=mh>0x00</span>
</span></span></code></pre></div><p>例子2：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>DATA</span> <span class=nx>divtab</span><span class=p>&lt;&gt;</span><span class=o>+</span><span class=mh>0x00</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>4</span><span class=p>,</span> <span class=err>$</span><span class=mh>0xf4f8fcff</span>
</span></span><span class=line><span class=cl><span class=nx>DATA</span> <span class=nx>divtab</span><span class=p>&lt;&gt;</span><span class=o>+</span><span class=mh>0x04</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>4</span><span class=p>,</span> <span class=err>$</span><span class=mh>0xe6eaedf0</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>DATA</span> <span class=nx>divtab</span><span class=p>&lt;&gt;</span><span class=o>+</span><span class=mh>0x3c</span><span class=p>(</span><span class=nx>SB</span><span class=p>)</span><span class=o>/</span><span class=mi>4</span><span class=p>,</span> <span class=err>$</span><span class=mh>0x81828384</span>
</span></span><span class=line><span class=cl><span class=nx>GLOBL</span> <span class=nx>divtab</span><span class=p>&lt;&gt;(</span><span class=nx>SB</span><span class=p>),</span> <span class=nx>RODATA</span><span class=p>,</span> <span class=err>$</span><span class=mi>64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>GLOBL</span> <span class=nx>runtime</span><span class=err>·</span><span class=nf>tlsoffset</span><span class=p>(</span><span class=nx>SB</span><span class=p>),</span> <span class=nx>NOPTR</span><span class=p>,</span> <span class=err>$</span><span class=mi>4</span>
</span></span></code></pre></div><ol><li>声明了一个只读的 64 字节 table，每个元素是 4 字节的整数。</li><li><code>runtime·tlsoffset</code> 是一个3字节的空指针。</li></ol><p><code>NOPTR</code> 这样的符号定义在 <code>textflag.h</code> 文件中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>    <span class=nx>NOPROF</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>For</span> <span class=nx>TEXT</span> <span class=nx>items</span><span class=p>.)</span> <span class=nx>Don</span><span class=err>&#39;</span><span class=nx>t</span> <span class=nx>profile</span> <span class=nx>the</span> <span class=nx>marked</span> <span class=nx>function</span><span class=p>.</span> <span class=nx>This</span> <span class=nx>flag</span> <span class=nx>is</span> <span class=nx>deprecated</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>DUPOK</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=nx>It</span> <span class=nx>is</span> <span class=nx>legal</span> <span class=nx>to</span> <span class=nx>have</span> <span class=nx>multiple</span> <span class=nx>instances</span> <span class=nx>of</span> <span class=nx>this</span> <span class=nx>symbol</span> <span class=nx>in</span> <span class=nx>a</span> <span class=nx>single</span> <span class=nx>binary</span><span class=p>.</span> <span class=nx>The</span> <span class=nx>linker</span> <span class=nx>will</span> <span class=nx>choose</span> <span class=nx>one</span> <span class=nx>of</span> <span class=nx>the</span> <span class=nx>duplicates</span> <span class=nx>to</span> <span class=nx>use</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>NOSPLIT</span> <span class=p>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>For</span> <span class=nx>TEXT</span> <span class=nx>items</span><span class=p>.)</span> <span class=nx>Don</span><span class=err>&#39;</span><span class=nx>t</span> <span class=nx>insert</span> <span class=nx>the</span> <span class=nx>preamble</span> <span class=nx>to</span> <span class=nx>check</span> <span class=k>if</span> <span class=nx>the</span> <span class=nx>stack</span> <span class=nx>must</span> <span class=nx>be</span> <span class=nx>split</span><span class=p>.</span> <span class=nx>The</span> <span class=nx>frame</span> <span class=k>for</span> <span class=nx>the</span> <span class=nx>routine</span><span class=p>,</span> <span class=nx>plus</span> <span class=nx>anything</span> <span class=nx>it</span> <span class=nx>calls</span><span class=p>,</span> <span class=nx>must</span> <span class=nx>fit</span> <span class=nx>in</span> <span class=nx>the</span> <span class=nx>spare</span> <span class=nx>space</span> <span class=nx>remaining</span> <span class=nx>in</span> <span class=nx>the</span> <span class=nx>current</span> <span class=nx>stack</span> <span class=nx>segment</span><span class=p>.</span> <span class=nx>Used</span> <span class=nx>to</span> <span class=nx>protect</span> <span class=nx>routines</span> <span class=nx>such</span> <span class=nx>as</span> <span class=nx>the</span> <span class=nx>stack</span> <span class=nx>splitting</span> <span class=nx>code</span> <span class=nx>itself</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>RODATA</span> <span class=p>=</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>For</span> <span class=nx>DATA</span> <span class=nx>and</span> <span class=nx>GLOBL</span> <span class=nx>items</span><span class=p>.)</span> <span class=nx>Put</span> <span class=nx>this</span> <span class=nx>data</span> <span class=nx>in</span> <span class=nx>a</span> <span class=nx>read</span><span class=o>-</span><span class=nx>only</span> <span class=nx>section</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>NOPTR</span> <span class=p>=</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>For</span> <span class=nx>DATA</span> <span class=nx>and</span> <span class=nx>GLOBL</span> <span class=nx>items</span><span class=p>.)</span> <span class=nx>This</span> <span class=nx>data</span> <span class=nx>contains</span> <span class=nx>no</span> <span class=nx>pointers</span> <span class=nx>and</span> <span class=nx>therefore</span> <span class=nx>does</span> <span class=nx>not</span> <span class=nx>need</span> <span class=nx>to</span> <span class=nx>be</span> <span class=nx>scanned</span> <span class=nx>by</span> <span class=nx>the</span> <span class=nx>garbage</span> <span class=nx>collector</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>WRAPPER</span> <span class=p>=</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>For</span> <span class=nx>TEXT</span> <span class=nx>items</span><span class=p>.)</span> <span class=nx>This</span> <span class=nx>is</span> <span class=nx>a</span> <span class=nx>wrapper</span> <span class=nx>function</span> <span class=nx>and</span> <span class=nx>should</span> <span class=nx>not</span> <span class=nx>count</span> <span class=nx>as</span> <span class=nx>disabling</span> <span class=nx>recover</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>NEEDCTXT</span> <span class=p>=</span> <span class=mi>64</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>For</span> <span class=nx>TEXT</span> <span class=nx>items</span><span class=p>.)</span> <span class=nx>This</span> <span class=nx>function</span> <span class=nx>is</span> <span class=nx>a</span> <span class=nx>closure</span> <span class=nx>so</span> <span class=nx>it</span> <span class=nx>uses</span> <span class=nx>its</span> <span class=nx>incoming</span> <span class=nx>context</span> <span class=nx>register</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>LOCAL</span> <span class=p>=</span> <span class=mi>128</span>
</span></span><span class=line><span class=cl>    <span class=nx>This</span> <span class=nx>symbol</span> <span class=nx>is</span> <span class=nx>local</span> <span class=nx>to</span> <span class=nx>the</span> <span class=nx>dynamic</span> <span class=nx>shared</span> <span class=nx>object</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>TLSBSS</span> <span class=p>=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>For</span> <span class=nx>DATA</span> <span class=nx>and</span> <span class=nx>GLOBL</span> <span class=nx>items</span><span class=p>.)</span> <span class=nx>Put</span> <span class=nx>this</span> <span class=nx>data</span> <span class=nx>in</span> <span class=nx>thread</span> <span class=nx>local</span> <span class=nx>storage</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>NOFRAME</span> <span class=p>=</span> <span class=mi>512</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>For</span> <span class=nx>TEXT</span> <span class=nx>items</span><span class=p>.)</span> <span class=nx>Do</span> <span class=nx>not</span> <span class=nx>insert</span> <span class=nx>instructions</span> <span class=nx>to</span> <span class=nx>allocate</span> <span class=nx>a</span> <span class=nx>stack</span> <span class=nx>frame</span> <span class=nx>and</span> <span class=nx>save</span><span class=o>/</span><span class=nx>restore</span> <span class=nx>the</span> <span class=k>return</span> <span class=nx>address</span><span class=p>,</span> <span class=nx>even</span> <span class=k>if</span> <span class=nx>this</span> <span class=nx>is</span> <span class=nx>not</span> <span class=nx>a</span> <span class=nx>leaf</span> <span class=nx>function</span><span class=p>.</span> <span class=nx>Only</span> <span class=nx>valid</span> <span class=nx>on</span> <span class=nx>functions</span> <span class=nx>that</span> <span class=nx>declare</span> <span class=nx>a</span> <span class=nx>frame</span> <span class=nx>size</span> <span class=nx>of</span> <span class=mf>0.</span>
</span></span><span class=line><span class=cl>    <span class=nx>TOPFRAME</span> <span class=p>=</span> <span class=mi>2048</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>For</span> <span class=nx>TEXT</span> <span class=nx>items</span><span class=p>.)</span> <span class=nx>Function</span> <span class=nx>is</span> <span class=nx>the</span> <span class=nx>outermost</span> <span class=nx>frame</span> <span class=nx>of</span> <span class=nx>the</span> <span class=nx>call</span> <span class=nx>stack</span><span class=p>.</span> <span class=nx>Traceback</span> <span class=nx>should</span> <span class=nx>stop</span> <span class=nx>at</span> <span class=nx>this</span> <span class=nx>function</span><span class=p>.</span>
</span></span></code></pre></div><h3 id=其他常用命令>其他常用命令<a hidden class=anchor aria-hidden=true href=#其他常用命令>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>SUBQ</span> <span class=err>$</span><span class=mh>0x18</span><span class=p>,</span> <span class=nx>SP</span>   <span class=c1>// 分配函数栈，操作数 8 个字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ADDQ</span> <span class=err>$</span><span class=mh>0x18</span><span class=p>,</span> <span class=nx>SP</span>   <span class=c1>// 清除函数栈，操作数据 8 个字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>MOVB</span> <span class=err>$</span><span class=mi>1</span><span class=p>,</span> <span class=nx>DI</span>      <span class=c1>// 拷贝 1个字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>MOVW</span> <span class=err>$</span><span class=mh>0x10</span><span class=p>,</span> <span class=nx>BX</span>   <span class=c1>// 拷贝 2 个字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>MOVD</span> <span class=err>$</span><span class=mi>1</span><span class=p>,</span> <span class=nx>DX</span>      <span class=c1>// 拷贝 4 个字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>MOVQ</span> <span class=err>$</span><span class=o>-</span><span class=mi>10</span><span class=p>,</span> <span class=nx>AX</span>    <span class=c1>// 拷贝 8 个字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ADDQ</span> <span class=nx>AX</span><span class=p>,</span> <span class=nx>BX</span>      <span class=c1>// BX = BX + AX 存 BX
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>SUBQ</span> <span class=nx>AX</span><span class=p>,</span> <span class=nx>BX</span>      <span class=c1>// BX = BX - AX 存 BX
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>IMULQ</span> <span class=nx>AX</span><span class=p>,</span> <span class=nx>BX</span>     <span class=c1>// BX = BX * AX 存 BX
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>MOVQ</span> <span class=nx>AX</span><span class=p>,</span> <span class=nx>BX</span>      <span class=c1>// BX = AX 将 AX 中的值赋给 BX
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>MOVQ</span> <span class=p>(</span><span class=nx>AX</span><span class=p>),</span> <span class=nx>BX</span>    <span class=c1>// BX = *AX 加载 AX 中指向内存地址的值给 BX
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>MOVQ</span> <span class=mi>16</span><span class=p>(</span><span class=nx>AX</span><span class=p>),</span> <span class=nx>BX</span>  <span class=c1>// BX = *(AX + 16) 偏移 16 个字节后地址中的值
</span></span></span></code></pre></div><h2 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h2><ol><li><a href=https://go.dev/doc/asm>https://go.dev/doc/asm</a></li><li><a href=https://segmentfault.com/a/1190000041159550>https://segmentfault.com/a/1190000041159550</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://runzhen.github.io/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=https://runzhen.github.io/posts/go-asm2/><span class=title>« Prev</span><br><span>Go Assembly - 2</span>
</a><a class=next href=https://runzhen.github.io/posts/bytegraph-and-oceanbase/><span class=title>Next »</span><br><span>ByteGraph and OceanBase</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Go Assembly - 1 on x" href="https://x.com/intent/tweet/?text=Go%20Assembly%20-%201&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fgo-asm1%2f&amp;hashtags=golang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go Assembly - 1 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fgo-asm1%2f&amp;title=Go%20Assembly%20-%201&amp;summary=Go%20Assembly%20-%201&amp;source=https%3a%2f%2frunzhen.github.io%2fposts%2fgo-asm1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go Assembly - 1 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frunzhen.github.io%2fposts%2fgo-asm1%2f&title=Go%20Assembly%20-%201"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go Assembly - 1 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frunzhen.github.io%2fposts%2fgo-asm1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go Assembly - 1 on whatsapp" href="https://api.whatsapp.com/send?text=Go%20Assembly%20-%201%20-%20https%3a%2f%2frunzhen.github.io%2fposts%2fgo-asm1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go Assembly - 1 on telegram" href="https://telegram.me/share/url?text=Go%20Assembly%20-%201&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fgo-asm1%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go Assembly - 1 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Go%20Assembly%20-%201&u=https%3a%2f%2frunzhen.github.io%2fposts%2fgo-asm1%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://runzhen.github.io/>Mind in the Wind</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>