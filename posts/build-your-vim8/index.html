<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Docker 中编译 vim8.0 | Mind in the Wind</title>
<meta name=keywords content="vim"><meta name=description content="vim 的最新版 vim8.0 提供了很多新的特性，而且一些流行的 vim 插件很多功能也依赖于 8.0 版本，如果你要使用 vim8.0，那么最好的办法当然是使用操作系提供的软件包管理器一键安装，省时省力。
但是总有那么一些蛋疼的情况 ——你需要自己编译 vim。
本文就是记录下具体的步骤，并且把编译源码时需要安装的依赖软件全部做成 docker 镜像。
事情起因 某台服务器上我要用 vim8.0 的新特性，但是在服务器上我没有任何超级权限，只能读写我自己的 home 目录。
所以没法直接安装vim，只能从源码编译。
制作编译 vim 的docker image 编译 vim 需要系统中安装很多依赖软件，比如 vim 最基本的要包括 python2.7，luajit 等。
都 2019 年了，最好的方式当然是制作一个 docker 镜像，具体的步骤就不一一解释，贴上 Dockerfile 以示诚意。
FROM ubuntu:18.04 RUN apt-get update && apt-get install -y \ liblua5.1-dev \ luajit \ libluajit-5.1 \ python-dev \ ruby-dev \ libperl-dev \ libncurses5-dev \ libatk1.0-dev \ libx11-dev \ libxpm-dev \ libxt-dev \ gnupg2 \ curl \ && gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB \ && curl -sSL https://get."><meta name=author content="Me"><link rel=canonical href=https://runzhen.github.io/posts/build-your-vim8/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.103f87022495ee8537d399aa50bf7e2203f4c653b709467478c7fd5a58182364.css integrity="sha256-ED+HAiSV7oU305mqUL9+IgP0xlO3CUZ0eMf9WlgYI2Q=" rel="preload stylesheet" as=style><link rel=icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://runzhen.github.io/posts/build-your-vim8/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Docker 中编译 vim8.0"><meta property="og:description" content="vim 的最新版 vim8.0 提供了很多新的特性，而且一些流行的 vim 插件很多功能也依赖于 8.0 版本，如果你要使用 vim8.0，那么最好的办法当然是使用操作系提供的软件包管理器一键安装，省时省力。
但是总有那么一些蛋疼的情况 ——你需要自己编译 vim。
本文就是记录下具体的步骤，并且把编译源码时需要安装的依赖软件全部做成 docker 镜像。
事情起因 某台服务器上我要用 vim8.0 的新特性，但是在服务器上我没有任何超级权限，只能读写我自己的 home 目录。
所以没法直接安装vim，只能从源码编译。
制作编译 vim 的docker image 编译 vim 需要系统中安装很多依赖软件，比如 vim 最基本的要包括 python2.7，luajit 等。
都 2019 年了，最好的方式当然是制作一个 docker 镜像，具体的步骤就不一一解释，贴上 Dockerfile 以示诚意。
FROM ubuntu:18.04 RUN apt-get update && apt-get install -y \ liblua5.1-dev \ luajit \ libluajit-5.1 \ python-dev \ ruby-dev \ libperl-dev \ libncurses5-dev \ libatk1.0-dev \ libx11-dev \ libxpm-dev \ libxt-dev \ gnupg2 \ curl \ && gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB \ && curl -sSL https://get."><meta property="og:type" content="article"><meta property="og:url" content="https://runzhen.github.io/posts/build-your-vim8/"><meta property="og:image" content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-16T00:00:00+00:00"><meta property="article:modified_time" content="2019-08-16T00:00:00+00:00"><meta property="og:site_name" content="Mind in the Wind"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Docker 中编译 vim8.0"><meta name=twitter:description content="vim 的最新版 vim8.0 提供了很多新的特性，而且一些流行的 vim 插件很多功能也依赖于 8.0 版本，如果你要使用 vim8.0，那么最好的办法当然是使用操作系提供的软件包管理器一键安装，省时省力。
但是总有那么一些蛋疼的情况 ——你需要自己编译 vim。
本文就是记录下具体的步骤，并且把编译源码时需要安装的依赖软件全部做成 docker 镜像。
事情起因 某台服务器上我要用 vim8.0 的新特性，但是在服务器上我没有任何超级权限，只能读写我自己的 home 目录。
所以没法直接安装vim，只能从源码编译。
制作编译 vim 的docker image 编译 vim 需要系统中安装很多依赖软件，比如 vim 最基本的要包括 python2.7，luajit 等。
都 2019 年了，最好的方式当然是制作一个 docker 镜像，具体的步骤就不一一解释，贴上 Dockerfile 以示诚意。
FROM ubuntu:18.04 RUN apt-get update && apt-get install -y \ liblua5.1-dev \ luajit \ libluajit-5.1 \ python-dev \ ruby-dev \ libperl-dev \ libncurses5-dev \ libatk1.0-dev \ libx11-dev \ libxpm-dev \ libxt-dev \ gnupg2 \ curl \ && gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB \ && curl -sSL https://get."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://runzhen.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Docker 中编译 vim8.0","item":"https://runzhen.github.io/posts/build-your-vim8/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Docker 中编译 vim8.0","name":"Docker 中编译 vim8.0","description":"vim 的最新版 vim8.0 提供了很多新的特性，而且一些流行的 vim 插件很多功能也依赖于 8.0 版本，如果你要使用 vim8.0，那么最好的办法当然是使用操作系提供的软件包管理器一键安装，省时省力。\n但是总有那么一些蛋疼的情况 ——你需要自己编译 vim。\n本文就是记录下具体的步骤，并且把编译源码时需要安装的依赖软件全部做成 docker 镜像。\n事情起因 某台服务器上我要用 vim8.0 的新特性，但是在服务器上我没有任何超级权限，只能读写我自己的 home 目录。\n所以没法直接安装vim，只能从源码编译。\n制作编译 vim 的docker image 编译 vim 需要系统中安装很多依赖软件，比如 vim 最基本的要包括 python2.7，luajit 等。\n都 2019 年了，最好的方式当然是制作一个 docker 镜像，具体的步骤就不一一解释，贴上 Dockerfile 以示诚意。\nFROM ubuntu:18.04 RUN apt-get update \u0026amp;\u0026amp; apt-get install -y \\ liblua5.1-dev \\ luajit \\ libluajit-5.1 \\ python-dev \\ ruby-dev \\ libperl-dev \\ libncurses5-dev \\ libatk1.0-dev \\ libx11-dev \\ libxpm-dev \\ libxt-dev \\ gnupg2 \\ curl \\ \u0026amp;\u0026amp; gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB \\ \u0026amp;\u0026amp; curl -sSL https://get.","keywords":["vim"],"articleBody":"vim 的最新版 vim8.0 提供了很多新的特性，而且一些流行的 vim 插件很多功能也依赖于 8.0 版本，如果你要使用 vim8.0，那么最好的办法当然是使用操作系提供的软件包管理器一键安装，省时省力。\n但是总有那么一些蛋疼的情况 ——你需要自己编译 vim。\n本文就是记录下具体的步骤，并且把编译源码时需要安装的依赖软件全部做成 docker 镜像。\n事情起因 某台服务器上我要用 vim8.0 的新特性，但是在服务器上我没有任何超级权限，只能读写我自己的 home 目录。\n所以没法直接安装vim，只能从源码编译。\n制作编译 vim 的docker image 编译 vim 需要系统中安装很多依赖软件，比如 vim 最基本的要包括 python2.7，luajit 等。\n都 2019 年了，最好的方式当然是制作一个 docker 镜像，具体的步骤就不一一解释，贴上 Dockerfile 以示诚意。\nFROM ubuntu:18.04 RUN apt-get update \u0026\u0026 apt-get install -y \\ liblua5.1-dev \\ luajit \\ libluajit-5.1 \\ python-dev \\ ruby-dev \\ libperl-dev \\ libncurses5-dev \\ libatk1.0-dev \\ libx11-dev \\ libxpm-dev \\ libxt-dev \\ gnupg2 \\ curl \\ \u0026\u0026 gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB \\ \u0026\u0026 curl -sSL https://get.rvm.io | bash -s stable \\ \u0026\u0026 /bin/bash -l -c \"rvm install 2.6 \u0026\u0026 rvm use 2.6.3 --default\" COPY ./configure.sh /root/ ENTRYPOINT [\"/bin/bash\"] 其中 configure.sh 是编译 vim 时你输入的一些 configure 选项，其实这个文件可有可无，没有的话手动输入就行了\n#!/bin/bash ./configure \\ --enable-multibyte \\ --enable-perlinterp=dynamic \\ --enable-rubyinterp=dynamic \\ --with-ruby-command=/usr/local/bin/ruby \\ --with-ruby-command=/usr/local/rvm/rubies/ruby-2.6.3/bin/ruby \\ --enable-pythoninterp=dynamic \\ --with-python-config-dir=/usr/lib/python2.7/config-x86_64-linux-gnu \\ --enable-luainterp \\ --with-luajit \\ --enable-cscope \\ --enable-gui=auto \\ --with-features=huge \\ --with-x \\ --enable-fontset \\ --enable-largefile \\ --disable-netbeans \\ --with-compiledby=\"Name\" \\ --enable-fail-if-missing #--enable-python3interp \\ #--with-python3-config-dir=/usr/lib/python3.5/config-3.5m-x86_64-linux-gnu \\ 把以上文件放在一个文件夹，制作 docker 镜像\ndocker build -t vim-dev:0.1 . 耐心等待几分钟，因为有很多很多包需要安装。\n编译 vim 有了 docker image 以后开始编译 vim\n首先 git clone https://github.com/vim/vim\n然后运行 docker image，并挂载源码目录，在这里我把源码挂载到了 /tmp 下，\ndocker run -it --rm -v $PWD:/tmp vim-dev:0.1 进入 /tmp 目录并把 /root 下的 configure.sh 拷贝到 /tmp，其实不拷贝也行，只需要把 configure.sh 的内容复制运行就行了。\nroot@ffd7bdd97a86:/# cd /tmp/ root@ffd7bdd97a86:/tmp# cp /root/configure.sh ./ root@ffd7bdd97a86:/tmp# ./configure.sh root@ffd7bdd97a86:/tmp# make VIMRUNTIMEDIR=/usr/local/share/vim/vim81 最后就能得到一个 vim 的二进制文件。\n运行 vim 把编译好的 vim 拷贝到目标机器上，运行一下试试看，幸运的话直接可以运行（取决于目标机器安装了多少依赖库文件），\n解决 libluajit-5.1.so.2 但是如果目标机器没有安装 luajit 的话你会看到如下错误\n$ ./myvim ./myvim: error while loading shared libraries: libluajit-5.1.so.2: cannot open shared object file: No such file or directory 如果解决？ 把 docker image 系统中的 libluajit-5.1.so.2 拷贝出来就好啦。\n重新进入 docker，找到 luagit\nlibluajit-5.1.so.2 =\u003e /usr/lib/x86_64-linux-gnu/libluajit-5.1.so.2\n拷贝到 docker run 时挂载的目录，退出容器后就能看到了，然后拷贝到目标机器。\n运行 vim 时候我们需要 load 我们指定的这个 libluajit-5.1.so.2，方法是 设置 LD_PRELOAD\ncan’t open syntax.vim 警告 运气再不好，还能看到这个警告\nError detected while processing /home/xxx/.vimrc: line 49: E484: Can't open file /usr/local/share/vim/syntax/syntax.vim Error detected while processing function plug#end: line 86: E484: Can't open file /usr/local/share/vim/syntax/syntax.vim 原因是我们在编译 vim 时，没有设置好 VIMRUNTIME 的路径，在 make 的时候指定 VIMRUNTIME\nmake VIMRUNTIMEDIR=/usr/local/share/vim/vim81 或者也可以说，编译好 binary 后我们需要 make install，这样 vim 和它依赖的运行文件就全部拷贝到系统了。\n但是因为现在的场景特殊，我没有任何修改系统目录的权限，因此不可能 make install。\n绕过这个警告的方法是告诉 vim8 去用系统现在已有的 vim版本的 syntax 文件，比如系统默认 vim 是 /usr/share/vim/vim74/\n那么可以在 bash 事先设置这个变量值\nexport VIMRUNTIME=/usr/share/vim/vim74/ myvim 脚本 以上两个错误/警告 每次在运行 vim 的时候都会出现，所以可以把它写成一个 bash script\n#!/bin/bash export LD_LIBRARY_PATH=. export VIMRUNTIME=/usr/share/vim/vim74/ LD_PRELOAD=$HOME/libluajit-5.1.so.2 $HOME/vim $1 把这个 bash script 命名为 myvim, 使用的时候是这样的 myvim test.txt\n(完)\n","wordCount":"357","inLanguage":"en","image":"https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2019-08-16T00:00:00Z","dateModified":"2019-08-16T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://runzhen.github.io/posts/build-your-vim8/"},"publisher":{"@type":"Organization","name":"Mind in the Wind","logo":{"@type":"ImageObject","url":"https://runzhen.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://runzhen.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://runzhen.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://runzhen.github.io/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://runzhen.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://runzhen.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://runzhen.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Docker 中编译 vim8.0</h1><div class=post-meta><span title='2019-08-16 00:00:00 +0000 UTC'>2019-08-16</span>&nbsp;·&nbsp;Me</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%ba%8b%e6%83%85%e8%b5%b7%e5%9b%a0 aria-label=事情起因>事情起因</a></li><li><a href=#%e5%88%b6%e4%bd%9c%e7%bc%96%e8%af%91-vim-%e7%9a%84docker-image aria-label="制作编译 vim 的docker image">制作编译 vim 的docker image</a></li><li><a href=#%e7%bc%96%e8%af%91-vim aria-label="编译 vim">编译 vim</a></li><li><a href=#%e8%bf%90%e8%a1%8c-vim aria-label="运行 vim">运行 vim</a><ul><li><a href=#%e8%a7%a3%e5%86%b3-libluajit-51so2 aria-label="解决 libluajit-5.1.so.2">解决 libluajit-5.1.so.2</a></li><li><a href=#cant-open-syntaxvim-%e8%ad%a6%e5%91%8a aria-label="can&rsquo;t open syntax.vim 警告">can&rsquo;t open syntax.vim 警告</a></li><li><a href=#myvim-%e8%84%9a%e6%9c%ac aria-label="myvim 脚本">myvim 脚本</a></li></ul></li></ul></div></details></div><div class=post-content><p>vim 的最新版 vim8.0 提供了很多新的特性，而且一些流行的 vim 插件很多功能也依赖于 8.0 版本，如果你要使用 vim8.0，那么最好的办法当然是使用操作系提供的软件包管理器一键安装，省时省力。</p><p>但是总有那么一些蛋疼的情况 ——你需要自己编译 vim。</p><p>本文就是记录下具体的步骤，并且把编译源码时需要安装的依赖软件全部做成 docker 镜像。</p><h2 id=事情起因>事情起因<a hidden class=anchor aria-hidden=true href=#事情起因>#</a></h2><p>某台服务器上我要用 vim8.0 的新特性，但是在服务器上我没有任何超级权限，只能读写我自己的 home 目录。</p><p>所以没法直接安装vim，只能从源码编译。</p><h2 id=制作编译-vim-的docker-image>制作编译 vim 的docker image<a hidden class=anchor aria-hidden=true href=#制作编译-vim-的docker-image>#</a></h2><p>编译 vim 需要系统中安装很多依赖软件，比如 vim 最基本的要包括 python2.7，luajit 等。</p><p>都 2019 年了，最好的方式当然是制作一个 docker 镜像，具体的步骤就不一一解释，贴上 Dockerfile 以示诚意。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ubuntu:18.04</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    liblua5.1-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    luajit <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libluajit-5.1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    python-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    ruby-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libperl-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libncurses5-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libatk1.0-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libx11-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libxpm-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    libxt-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    gnupg2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    curl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> curl -sSL https://get.rvm.io <span class=p>|</span> bash -s stable <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> /bin/bash -l -c <span class=s2>&#34;rvm install 2.6 &amp;&amp; rvm use 2.6.3 --default&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./configure.sh  /root/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;/bin/bash&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><p>其中 configure.sh 是编译 vim 时你输入的一些 configure 选项，其实这个文件可有可无，没有的话手动输入就行了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>./configure <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-multibyte <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-perlinterp<span class=o>=</span>dynamic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-rubyinterp<span class=o>=</span>dynamic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-ruby-command<span class=o>=</span>/usr/local/bin/ruby <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-ruby-command<span class=o>=</span>/usr/local/rvm/rubies/ruby-2.6.3/bin/ruby <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-pythoninterp<span class=o>=</span>dynamic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-python-config-dir<span class=o>=</span>/usr/lib/python2.7/config-x86_64-linux-gnu <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-luainterp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-luajit <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-cscope <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-gui<span class=o>=</span>auto <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-features<span class=o>=</span>huge <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-x <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-fontset <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-largefile <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--disable-netbeans <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-compiledby<span class=o>=</span><span class=s2>&#34;Name&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-fail-if-missing
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#--enable-python3interp \</span>
</span></span><span class=line><span class=cl><span class=c1>#--with-python3-config-dir=/usr/lib/python3.5/config-3.5m-x86_64-linux-gnu \</span>
</span></span></code></pre></div><p>把以上文件放在一个文件夹，制作 docker 镜像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t vim-dev:0.1 . 
</span></span></code></pre></div><p>耐心等待几分钟，因为有很多很多包需要安装。</p><h2 id=编译-vim>编译 vim<a hidden class=anchor aria-hidden=true href=#编译-vim>#</a></h2><p>有了 docker image 以后开始编译 vim</p><p>首先 <code>git clone https://github.com/vim/vim</code></p><p>然后运行 docker image，并挂载源码目录，在这里我把源码挂载到了 /tmp 下，</p><p><code>docker run -it --rm -v $PWD:/tmp vim-dev:0.1</code></p><p>进入 /tmp 目录并把 /root 下的 configure.sh 拷贝到 /tmp，其实不拷贝也行，只需要把 configure.sh 的内容复制运行就行了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ffd7bdd97a86:/# <span class=nb>cd</span> /tmp/
</span></span><span class=line><span class=cl>root@ffd7bdd97a86:/tmp# cp /root/configure.sh ./
</span></span><span class=line><span class=cl>root@ffd7bdd97a86:/tmp# ./configure.sh
</span></span><span class=line><span class=cl>root@ffd7bdd97a86:/tmp# make <span class=nv>VIMRUNTIMEDIR</span><span class=o>=</span>/usr/local/share/vim/vim81
</span></span></code></pre></div><p>最后就能得到一个 vim 的二进制文件。</p><h2 id=运行-vim>运行 vim<a hidden class=anchor aria-hidden=true href=#运行-vim>#</a></h2><p>把编译好的 vim 拷贝到目标机器上，运行一下试试看，幸运的话直接可以运行（取决于目标机器安装了多少依赖库文件），</p><h3 id=解决-libluajit-51so2>解决 libluajit-5.1.so.2<a hidden class=anchor aria-hidden=true href=#解决-libluajit-51so2>#</a></h3><p>但是如果目标机器没有安装 luajit 的话你会看到如下错误</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./myvim
</span></span><span class=line><span class=cl>./myvim: error <span class=k>while</span> loading shared libraries: libluajit-5.1.so.2: cannot open shared object file: No such file or directory
</span></span></code></pre></div><p>如果解决？ 把 docker image 系统中的 libluajit-5.1.so.2 拷贝出来就好啦。</p><p>重新进入 docker，找到 luagit</p><p><code>libluajit-5.1.so.2 => /usr/lib/x86_64-linux-gnu/libluajit-5.1.so.2</code></p><p>拷贝到 docker run 时挂载的目录，退出容器后就能看到了，然后拷贝到目标机器。</p><p>运行 vim 时候我们需要 load 我们指定的这个 libluajit-5.1.so.2，方法是 设置 LD_PRELOAD</p><h3 id=cant-open-syntaxvim-警告>can&rsquo;t open syntax.vim 警告<a hidden class=anchor aria-hidden=true href=#cant-open-syntaxvim-警告>#</a></h3><p>运气再不好，还能看到这个警告</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Error detected <span class=k>while</span> processing /home/xxx/.vimrc:
</span></span><span class=line><span class=cl>line   49:
</span></span><span class=line><span class=cl>E484: Can<span class=s1>&#39;t open file /usr/local/share/vim/syntax/syntax.vim
</span></span></span><span class=line><span class=cl><span class=s1>Error detected while processing function plug#end:
</span></span></span><span class=line><span class=cl><span class=s1>line   86:
</span></span></span><span class=line><span class=cl><span class=s1>E484: Can&#39;</span>t open file /usr/local/share/vim/syntax/syntax.vim
</span></span></code></pre></div><p>原因是我们在编译 vim 时，没有设置好 VIMRUNTIME 的路径，在 make 的时候指定 VIMRUNTIME</p><pre tabindex=0><code>make VIMRUNTIMEDIR=/usr/local/share/vim/vim81 
</code></pre><p>或者也可以说，编译好 binary 后我们需要 make install，这样 vim 和它依赖的运行文件就全部拷贝到系统了。</p><p>但是因为现在的场景特殊，我没有任何修改系统目录的权限，因此不可能 make install。</p><p>绕过这个警告的方法是告诉 vim8 去用系统现在已有的 vim版本的 syntax 文件，比如系统默认 vim 是 <code>/usr/share/vim/vim74/</code></p><p>那么可以在 bash 事先设置这个变量值</p><pre tabindex=0><code>export VIMRUNTIME=/usr/share/vim/vim74/
</code></pre><h3 id=myvim-脚本>myvim 脚本<a hidden class=anchor aria-hidden=true href=#myvim-脚本>#</a></h3><p>以上两个错误/警告 每次在运行 vim 的时候都会出现，所以可以把它写成一个 bash script</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LD_LIBRARY_PATH</span><span class=o>=</span>.
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>VIMRUNTIME</span><span class=o>=</span>/usr/share/vim/vim74/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>LD_PRELOAD</span><span class=o>=</span><span class=nv>$HOME</span>/libluajit-5.1.so.2 <span class=nv>$HOME</span>/vim  <span class=nv>$1</span>
</span></span></code></pre></div><p>把这个 bash script 命名为 myvim, 使用的时候是这样的 <code>myvim test.txt</code></p><p>(完)</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://runzhen.github.io/tags/vim/>Vim</a></li></ul><nav class=paginav><a class=prev href=https://runzhen.github.io/posts/gke-access-memorystore/><span class=title>« Prev</span><br><span>从 Kubernetes 中访问 Memorystore</span>
</a><a class=next href=https://runzhen.github.io/posts/tcp-backlog/><span class=title>Next »</span><br><span>How TCP backlog works in Linux</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Docker 中编译 vim8.0 on x" href="https://x.com/intent/tweet/?text=Docker%20%e4%b8%ad%e7%bc%96%e8%af%91%20vim8.0&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fbuild-your-vim8%2f&amp;hashtags=vim"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Docker 中编译 vim8.0 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fbuild-your-vim8%2f&amp;title=Docker%20%e4%b8%ad%e7%bc%96%e8%af%91%20vim8.0&amp;summary=Docker%20%e4%b8%ad%e7%bc%96%e8%af%91%20vim8.0&amp;source=https%3a%2f%2frunzhen.github.io%2fposts%2fbuild-your-vim8%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Docker 中编译 vim8.0 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frunzhen.github.io%2fposts%2fbuild-your-vim8%2f&title=Docker%20%e4%b8%ad%e7%bc%96%e8%af%91%20vim8.0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Docker 中编译 vim8.0 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frunzhen.github.io%2fposts%2fbuild-your-vim8%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Docker 中编译 vim8.0 on whatsapp" href="https://api.whatsapp.com/send?text=Docker%20%e4%b8%ad%e7%bc%96%e8%af%91%20vim8.0%20-%20https%3a%2f%2frunzhen.github.io%2fposts%2fbuild-your-vim8%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Docker 中编译 vim8.0 on telegram" href="https://telegram.me/share/url?text=Docker%20%e4%b8%ad%e7%bc%96%e8%af%91%20vim8.0&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fbuild-your-vim8%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Docker 中编译 vim8.0 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Docker%20%e4%b8%ad%e7%bc%96%e8%af%91%20vim8.0&u=https%3a%2f%2frunzhen.github.io%2fposts%2fbuild-your-vim8%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://runzhen.github.io/>Mind in the Wind</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>