<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>etcd-raft 源码阅读之 Leader 的选举 | Mind in the Wind</title>
<meta name=keywords content="raft"><meta name=description content="首先看一下 raft node 之间传递的基本消息（比如 leader 选举，AppendLog）类型 Message protobuf 定义
message Message { optional MessageType type = 1 ; optional uint64 to = 2 ; optional uint64 from = 3 ; // 整个消息发出去时，所处的任期 optional uint64 term = 4 ; // logTerm is generally used for appending Raft logs to followers. For example, // (type=MsgApp,index=100,logTerm=5) means leader appends entries starting at // index=101, and the term of entry at index 100 is 5."><meta name=author content="Me"><link rel=canonical href=https://runzhen.github.io/posts/etcd-raft-leader-election/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.a8f620eb24ba9442cd3765590f9208a0752be50e5a7b9dd9e3e555c8cb5e74e6.css integrity="sha256-qPYg6yS6lELNN2VZD5IIoHUr5Q5ae53Z4+VVyMtedOY=" rel="preload stylesheet" as=style><link rel=icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://runzhen.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://runzhen.github.io/posts/etcd-raft-leader-election/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="etcd-raft 源码阅读之 Leader 的选举"><meta property="og:description" content="首先看一下 raft node 之间传递的基本消息（比如 leader 选举，AppendLog）类型 Message protobuf 定义
message Message { optional MessageType type = 1 ; optional uint64 to = 2 ; optional uint64 from = 3 ; // 整个消息发出去时，所处的任期 optional uint64 term = 4 ; // logTerm is generally used for appending Raft logs to followers. For example, // (type=MsgApp,index=100,logTerm=5) means leader appends entries starting at // index=101, and the term of entry at index 100 is 5."><meta property="og:type" content="article"><meta property="og:url" content="https://runzhen.github.io/posts/etcd-raft-leader-election/"><meta property="og:image" content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-15T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-15T00:00:00+00:00"><meta property="og:site_name" content="Mind in the Wind"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="etcd-raft 源码阅读之 Leader 的选举"><meta name=twitter:description content="首先看一下 raft node 之间传递的基本消息（比如 leader 选举，AppendLog）类型 Message protobuf 定义
message Message { optional MessageType type = 1 ; optional uint64 to = 2 ; optional uint64 from = 3 ; // 整个消息发出去时，所处的任期 optional uint64 term = 4 ; // logTerm is generally used for appending Raft logs to followers. For example, // (type=MsgApp,index=100,logTerm=5) means leader appends entries starting at // index=101, and the term of entry at index 100 is 5."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://runzhen.github.io/posts/"},{"@type":"ListItem","position":2,"name":"etcd-raft 源码阅读之 Leader 的选举","item":"https://runzhen.github.io/posts/etcd-raft-leader-election/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"etcd-raft 源码阅读之 Leader 的选举","name":"etcd-raft 源码阅读之 Leader 的选举","description":"首先看一下 raft node 之间传递的基本消息（比如 leader 选举，AppendLog）类型 Message protobuf 定义\nmessage Message { optional MessageType type = 1 ; optional uint64 to = 2 ; optional uint64 from = 3 ; // 整个消息发出去时，所处的任期 optional uint64 term = 4 ; // logTerm is generally used for appending Raft logs to followers. For example, // (type=MsgApp,index=100,logTerm=5) means leader appends entries starting at // index=101, and the term of entry at index 100 is 5.","keywords":["raft"],"articleBody":"首先看一下 raft node 之间传递的基本消息（比如 leader 选举，AppendLog）类型 Message protobuf 定义\nmessage Message { optional MessageType type = 1 ; optional uint64 to = 2 ; optional uint64 from = 3 ; // 整个消息发出去时，所处的任期 optional uint64 term = 4 ; // logTerm is generally used for appending Raft logs to followers. For example, // (type=MsgApp,index=100,logTerm=5) means leader appends entries starting at // index=101, and the term of entry at index 100 is 5. // (type=MsgAppResp,reject=true,index=100,logTerm=5) means follower rejects some // entries from its leader as it already has an entry with term 5 at index 100. // 该消息携带的第一条Entry记录的的Term值 optional uint64 logTerm = 5 ; // 索引值，该索引值和消息的类型有关,不同的消息类型代表的含义不同 optional uint64 index = 6 ; repeated Entry entries = 7 ; // 已经提交的日志的索引值，用来向别人同步日志的提交信息。 optional uint64 commit = 8 ; // 在传输快照时，该字段保存了快照数据 optional Snapshot snapshot = 9 ; optional bool reject = 10; optional uint64 rejectHint = 11; optional bytes context = 12; } message Entry { optional uint64 Term = 2; // Index:当前这个entry在整个raft日志中的位置索引, // 有了Term和Index之后，一个`log entry`就能被唯一标识。 optional uint64 Index = 3; optional EntryType Type = 1; optional bytes Data = 4; } raftexample 目录提供了一个如何使用 raft library 的例子， 首先从 main.go 来看如何启动一个 raft node。\nfunc newRaftNode(...) (\u003c-chan *commit, \u003c-chan error, \u003c-chan *snap.Snapshotter) { commitC := make(chan *commit) errorC := make(chan error) rc := \u0026raftNode{ proposeC: proposeC, confChangeC: confChangeC, commitC: commitC, errorC: errorC, id: id, .... } go rc.startRaft() return commitC, errorC, rc.snapshotterReady } 从阅读参考资料的过程中已经得知，etcd raft 的实现是需要调用者配合的，因此newRaftNode的返回的这几个 channel 就是给上层的应用通过 channel 和 raftNode 进行交互。\n其他细节先省略，我们直接看 startRaft()\nfunc (rc *raftNode) startRaft() { // 创建 WAL 实例，然后加载快照并回放 WAL 日志 rc.snapshotter = snap.New(zap.NewExample(), rc.snapdir) oldwal := wal.Exist(rc.waldir) // 首先会读取快照数据， // 在快照数据中记录了该快照包含的最后一条 Entry 记录的 Term 值 和 索引值。 // 然后根据 Term 值 和 索引值确定读取 WAL 日志文件的位置， 并进行日志记录的读取。 rc.wal = rc.replayWAL() // signal replay has finished rc.snapshotterReady \u003c- rc.snapshotter ... // 初始化底层的 etcd-raft 模块，这里会根据 WAL 日志的回放情况， // 判断当前节点是首次启动还是重新启动 if oldwal || rc.join { rc.node = raft.RestartNode(c) } else { // 初次启动 rc.node = raft.StartNode(c, rpeers) } // 创建 Transport 实例并启动，他负责 raft 节点之间的网络通信服务 rc.transport = \u0026rafthttp.Transport{ ... } rc.transport.Start() for i := range rc.peers { if i+1 != rc.id { // 建立与集群中其他各个节点的连接 rc.transport.AddPeer(types.ID(i+1), []string{rc.peers[i]}) } } // 启动一个goroutine，其中会监听当前节点与集群中其他节点之间的网络连接 go rc.serveRaft() // 启动后台 goroutine 处理上层应用与底层 etcd-raft 模块的交互 go rc.serveChannels() } snapshot 以及上层应用交互的部分暂时先略过。\nrc.serveChannels() 的作用是处理上层应用于 raft 库的交互，在这个函数中设置了 ticker := time.NewTicker(100 * time.*Millisecond*) 控制了 raft.node 结构中的 RawNode 的 tick()，进而控制了 raft 中的 tick 函数指针。\n再来理一理这些结构体之间的关系：\nraftexample.raftNode 是上层应用对一个 raft 节点的封装，它除了有上面提到的 propose channel 等channel以外，还有一个 raft.Node 成员。 raft.Node是 raft 库中的一个抽象接口，而 raft.node 结构体实现了这个接口。 raft.node(注意小写) 是一个私有结构体，封装了一堆 channel，以及最重要的 RawNode。 raft.RawNode 包含了最重要的 raft.raft 实现。 所以，在 StartNode() 中我们看到，先 new 一个 RawNode，然后再封装成一个 raft.Node 返回给应用层 raftexample.raftNode 。\n有关 raft node 启动和选举 leader 是在 StartNode()\nfunc StartNode(c *Config, peers []Peer) Node { // 初始化RawNode 和 raft rn, err := NewRawNode(c) if err != nil { panic(err) } // 3 个 node 的 term 都设置为 1， role 都为 follower err = rn.Bootstrap(peers) if err != nil { c.Logger.Warningf(\"error occurred during starting a new node: %v\", err) } n := newNode(rn) // run() 是一个无限循环函数，follower 开始竞选 leader go n.run() return \u0026n } 值得注意的是 n.run() 是 raft.node 结构体的无限循环，用于处理应用层发来的消息，而 raft 状态机是 raft.Step()\n在 raft.go 中有一组函数用来设置 follower, candidate, leader 的 step 函数。\nfunc (r *raft) becomeFollower(term uint64, lead uint64) { r.step = stepFollower r.reset(term) r.tick = r.tickElection r.lead = lead r.state = StateFollower r.logger.Infof(\"%x became follower at term %d\", r.id, r.Term) } func (r *raft) becomeCandidate() { r.step = stepCandidate r.reset(r.Term + 1) r.tick = r.tickElection r.Vote = r.id r.state = StateCandidate r.logger.Infof(\"%x became candidate at term %d\", r.id, r.Term) } func (r *raft) becomeLeader() { r.step = stepLeader r.reset(r.Term) r.tick = r.tickHeartbeat r.lead = r.id r.state = StateLeader } 他们的调用关系是这样的: n.run() 调用 r.Step()，r.Step() 中调用每个 role 各自的 step 函数\n开始选举 raftexample binary 启动之后如何开始选举的呢？\n我们知道一开始大家都是 follower，而且应用层 rc.serveChannels() 有个 100 ms 触发的 timer， 通过控制 raft.node 结构中的 RawNode 的 tick()，进而控制 raft 中的 tick 函数指针。\n而 follower, candidate, leader 的 tick 指针在上面的 3 个函数中都被赋值给了 tickElection() 或者 tickHeartbeat()，所以选举就是从 tickElection() 开始的。\nfunc (r *raft) tickElection() { r.electionElapsed++ if r.promotable() \u0026\u0026 r.pastElectionTimeout() { r.electionElapsed = 0 if err := r.Step(pb.Message{From: r.id, Type: pb.MsgHup}); err != nil { r.logger.Debugf(\"error occurred during election: %v\", err) } } } func (r *raft) Step(m pb.Message) error { switch m.Type { case pb.MsgHup: r.hup(campaignElection) } } func (r *raft) campaign(t CampaignType) { for _, id := range ids { r.send(pb.Message{ Term: term, To: id, Type: voteMsg, Index: r.raftLog.lastIndex(), LogTerm: r.raftLog.lastTerm(), Context: ctx}) } } 可以看到，candidate 发起的 投票请求 所包含的信息与论文 3.4 的 RequestVote RPC 所示一样。\n那么，其他节点处理投票请求的地方在哪呢？ 在 raft.Step()，而不是在具体的 r.step() 函数指针指向的 follower, leader 各自的 step 函数。\n由此可见，raft.Step() 首先对收到的 message 做一些基本的检查，比如比较消息的 Term 和 节点的 term 大小关系，然后做一些基本的操作，最后再调用 各个role 自己的 step 函数。\nfunc (r *raft) Step(m pb.Message) error { case pb.MsgVote, pb.MsgPreVote: if canVote \u0026\u0026 r.raftLog.isUpToDate(m.Index, m.LogTerm) { r.send(pb.Message{To: m.From, Term: m.Term, Type: voteRespMsgType(m.Type)}) if m.Type == pb.MsgVote { // Only record real votes. r.electionElapsed = 0 r.Vote = m.From // r.lead leader 的 id 不是在回复投票的时候设置的 // 而是在收到 append,heartbeat 的时候顺便设置的。 } 最后，candidate 就在 raft.stepCandidate()函数中调用 becomeLeader() 切换成 leader，并且开始发送 append 信息。\n参考资料 https://www.cnblogs.com/ricklz/p/15155095.html ","wordCount":"787","inLanguage":"en","image":"https://runzhen.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2022-05-15T00:00:00Z","dateModified":"2022-05-15T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://runzhen.github.io/posts/etcd-raft-leader-election/"},"publisher":{"@type":"Organization","name":"Mind in the Wind","logo":{"@type":"ImageObject","url":"https://runzhen.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://runzhen.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://runzhen.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://runzhen.github.io/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://runzhen.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://runzhen.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://runzhen.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">etcd-raft 源码阅读之 Leader 的选举</h1><div class=post-meta><span title='2022-05-15 00:00:00 +0000 UTC'>2022-05-15</span>&nbsp;·&nbsp;Me</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%bc%80%e5%a7%8b%e9%80%89%e4%b8%be aria-label=开始选举>开始选举</a></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=参考资料>参考资料</a></li></ul></div></details></div><div class=post-content><p>首先看一下 raft node 之间传递的基本消息（比如 leader 选举，AppendLog）类型 <code>Message</code> protobuf 定义</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>message</span> <span class=nx>Message</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>optional</span> <span class=nx>MessageType</span> <span class=kd>type</span>        <span class=p>=</span> <span class=mi>1</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>optional</span> <span class=kt>uint64</span>      <span class=nx>to</span>          <span class=p>=</span> <span class=mi>2</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>optional</span> <span class=kt>uint64</span>      <span class=nx>from</span>        <span class=p>=</span> <span class=mi>3</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 整个消息发出去时，所处的任期
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>optional</span> <span class=kt>uint64</span>      <span class=nx>term</span>        <span class=p>=</span> <span class=mi>4</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// logTerm is generally used for appending Raft logs to followers. For example,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (type=MsgApp,index=100,logTerm=5) means leader appends entries starting at
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// index=101, and the term of entry at index 100 is 5.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (type=MsgAppResp,reject=true,index=100,logTerm=5) means follower rejects some
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// entries from its leader as it already has an entry with term 5 at index 100.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 该消息携带的第一条Entry记录的的Term值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>optional</span> <span class=kt>uint64</span>      <span class=nx>logTerm</span>     <span class=p>=</span> <span class=mi>5</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 索引值，该索引值和消息的类型有关,不同的消息类型代表的含义不同
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>optional</span> <span class=kt>uint64</span>      <span class=nx>index</span>       <span class=p>=</span> <span class=mi>6</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>repeated</span> <span class=nx>Entry</span>       <span class=nx>entries</span>     <span class=p>=</span> <span class=mi>7</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 已经提交的日志的索引值，用来向别人同步日志的提交信息。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>optional</span> <span class=kt>uint64</span>      <span class=nx>commit</span>      <span class=p>=</span> <span class=mi>8</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 在传输快照时，该字段保存了快照数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>optional</span> <span class=nx>Snapshot</span>    <span class=nx>snapshot</span>    <span class=p>=</span> <span class=mi>9</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>optional</span> <span class=kt>bool</span>        <span class=nx>reject</span>      <span class=p>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>optional</span> <span class=kt>uint64</span>      <span class=nx>rejectHint</span>  <span class=p>=</span> <span class=mi>11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>optional</span> <span class=nx>bytes</span>       <span class=nx>context</span>     <span class=p>=</span> <span class=mi>12</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>message</span> <span class=nx>Entry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>optional</span> <span class=kt>uint64</span>     <span class=nx>Term</span>  <span class=p>=</span> <span class=mi>2</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Index:当前这个entry在整个raft日志中的位置索引,
</span></span></span><span class=line><span class=cl><span class=c1>// 有了Term和Index之后，一个`log entry`就能被唯一标识。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>optional</span> <span class=kt>uint64</span>     <span class=nx>Index</span> <span class=p>=</span> <span class=mi>3</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>	<span class=nx>optional</span> <span class=nx>EntryType</span>  <span class=nx>Type</span>  <span class=p>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>optional</span> <span class=nx>bytes</span>      <span class=nx>Data</span>  <span class=p>=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>raftexample 目录提供了一个如何使用 raft library 的例子， 首先从 main.go 来看如何启动一个 raft node。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newRaftNode</span><span class=p>(</span><span class=o>...</span><span class=p>)</span> <span class=p>(</span><span class=o>&lt;-</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>commit</span><span class=p>,</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kt>error</span><span class=p>,</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>snap</span><span class=p>.</span><span class=nx>Snapshotter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>commitC</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>commit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>errorC</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>rc</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>raftNode</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>proposeC</span><span class=p>:</span>    <span class=nx>proposeC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>confChangeC</span><span class=p>:</span> <span class=nx>confChangeC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>commitC</span><span class=p>:</span>     <span class=nx>commitC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>errorC</span><span class=p>:</span>      <span class=nx>errorC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>id</span><span class=p>:</span>          <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span><span class=p>.</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>rc</span><span class=p>.</span><span class=nf>startRaft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>commitC</span><span class=p>,</span> <span class=nx>errorC</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>snapshotterReady</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>从阅读参考资料的过程中已经得知，etcd raft 的实现是需要调用者配合的，因此<code>newRaftNode</code>的返回的这几个 channel 就是给上层的应用通过 channel 和 raftNode 进行交互。</p><p>其他细节先省略，我们直接看 <code>startRaft()</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>raftNode</span><span class=p>)</span> <span class=nf>startRaft</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建 WAL 实例，然后加载快照并回放 WAL 日志
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rc</span><span class=p>.</span><span class=nx>snapshotter</span> <span class=p>=</span> <span class=nx>snap</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>zap</span><span class=p>.</span><span class=nf>NewExample</span><span class=p>(),</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>snapdir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>oldwal</span> <span class=o>:=</span> <span class=nx>wal</span><span class=p>.</span><span class=nf>Exist</span><span class=p>(</span><span class=nx>rc</span><span class=p>.</span><span class=nx>waldir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 首先会读取快照数据，
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 在快照数据中记录了该快照包含的最后一条 Entry 记录的 Term 值 和 索引值。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 然后根据 Term 值 和 索引值确定读取 WAL 日志文件的位置， 并进行日志记录的读取。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rc</span><span class=p>.</span><span class=nx>wal</span> <span class=p>=</span> <span class=nx>rc</span><span class=p>.</span><span class=nf>replayWAL</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// signal replay has finished
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rc</span><span class=p>.</span><span class=nx>snapshotterReady</span> <span class=o>&lt;-</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>snapshotter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 初始化底层的 etcd-raft 模块，这里会根据 WAL 日志的回放情况，
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 判断当前节点是首次启动还是重新启动
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>oldwal</span> <span class=o>||</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>join</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rc</span><span class=p>.</span><span class=nx>node</span> <span class=p>=</span> <span class=nx>raft</span><span class=p>.</span><span class=nf>RestartNode</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 初次启动
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>rc</span><span class=p>.</span><span class=nx>node</span> <span class=p>=</span> <span class=nx>raft</span><span class=p>.</span><span class=nf>StartNode</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>rpeers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建 Transport 实例并启动，他负责 raft 节点之间的网络通信服务
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rc</span><span class=p>.</span><span class=nx>transport</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>rafthttp</span><span class=p>.</span><span class=nx>Transport</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>rc</span><span class=p>.</span><span class=nx>transport</span><span class=p>.</span><span class=nf>Start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>peers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>i</span><span class=o>+</span><span class=mi>1</span> <span class=o>!=</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>id</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 建立与集群中其他各个节点的连接
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>rc</span><span class=p>.</span><span class=nx>transport</span><span class=p>.</span><span class=nf>AddPeer</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nf>ID</span><span class=p>(</span><span class=nx>i</span><span class=o>+</span><span class=mi>1</span><span class=p>),</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nx>rc</span><span class=p>.</span><span class=nx>peers</span><span class=p>[</span><span class=nx>i</span><span class=p>]})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 启动一个goroutine，其中会监听当前节点与集群中其他节点之间的网络连接
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=nx>rc</span><span class=p>.</span><span class=nf>serveRaft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 启动后台 goroutine 处理上层应用与底层 etcd-raft 模块的交互
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=nx>rc</span><span class=p>.</span><span class=nf>serveChannels</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>snapshot 以及上层应用交互的部分暂时先略过。</p><p>rc.serveChannels() 的作用是处理上层应用于 raft 库的交互，在这个函数中设置了 <code>ticker := time.NewTicker(100 * time.*Millisecond*)</code> 控制了 raft.node 结构中的 RawNode 的 tick()，进而控制了 raft 中的 tick 函数指针。</p><p>再来理一理这些结构体之间的关系：</p><ol><li><code>raftexample.raftNode</code> 是上层应用对一个 raft 节点的封装，它除了有上面提到的 propose channel 等channel以外，还有一个 raft.Node 成员。</li><li><code>raft.Node</code>是 raft 库中的一个抽象接口，而 raft.node 结构体实现了这个接口。</li><li><code>raft.node</code>(注意小写) 是一个私有结构体，封装了一堆 channel，以及最重要的 RawNode。</li><li><code>raft.RawNode</code> 包含了最重要的 raft.raft 实现。</li></ol><p>所以，在 StartNode() 中我们看到，先 new 一个 RawNode，然后再封装成一个 raft.Node 返回给应用层 raftexample.raftNode 。</p><p>有关 raft node 启动和选举 leader 是在 <code>StartNode()</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>func</span> <span class=nx>StartNode</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Config</span><span class=p>,</span> <span class=nx>peers</span> <span class=p>[]</span><span class=nx>Peer</span><span class=p>)</span> <span class=nx>Node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 初始化RawNode 和 raft
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>NewRawNode</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=nx>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 3 个 node 的 term 都设置为 1， role 都为 follower
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=o>=</span> <span class=nx>rn</span><span class=p>.</span><span class=nx>Bootstrap</span><span class=p>(</span><span class=nx>peers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=nx>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>Logger</span><span class=p>.</span><span class=nx>Warningf</span><span class=p>(</span><span class=s2>&#34;error occurred during starting a new node: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>n</span> <span class=o>:=</span> <span class=nx>newNode</span><span class=p>(</span><span class=nx>rn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// run() 是一个无限循环函数，follower 开始竞选 leader
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>go</span> <span class=nx>n</span><span class=p>.</span><span class=nx>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>n</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>值得注意的是 <code>n.run()</code> 是 raft.node 结构体的无限循环，用于处理应用层发来的消息，而 raft 状态机是 <code>raft.Step()</code></p><p>在 raft.go 中有一组函数用来设置 follower, candidate, leader 的 step 函数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>raft</span><span class=p>)</span> <span class=nf>becomeFollower</span><span class=p>(</span><span class=nx>term</span> <span class=kt>uint64</span><span class=p>,</span> <span class=nx>lead</span> <span class=kt>uint64</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>step</span> <span class=p>=</span> <span class=nx>stepFollower</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>reset</span><span class=p>(</span><span class=nx>term</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>tick</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>tickElection</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>lead</span> <span class=p>=</span> <span class=nx>lead</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>StateFollower</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%x became follower at term %d&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Term</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>raft</span><span class=p>)</span> <span class=nf>becomeCandidate</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>step</span> <span class=p>=</span> <span class=nx>stepCandidate</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>reset</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Term</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>tick</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>tickElection</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>Vote</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>StateCandidate</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%x became candidate at term %d&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Term</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>raft</span><span class=p>)</span> <span class=nf>becomeLeader</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>step</span> <span class=p>=</span> <span class=nx>stepLeader</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>reset</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Term</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>tick</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>tickHeartbeat</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>lead</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>StateLeader</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>他们的调用关系是这样的: <code>n.run() 调用 r.Step()，r.Step() 中调用每个 role 各自的 step 函数</code></p><h3 id=开始选举>开始选举<a hidden class=anchor aria-hidden=true href=#开始选举>#</a></h3><p>raftexample binary 启动之后如何开始选举的呢？</p><p>我们知道一开始大家都是 follower，而且应用层 rc.serveChannels() 有个 100 ms 触发的 timer， 通过控制 raft.node 结构中的 RawNode 的 tick()，进而控制 raft 中的 tick 函数指针。</p><p>而 follower, candidate, leader 的 tick 指针在上面的 3 个函数中都被赋值给了 tickElection() 或者 tickHeartbeat()，所以选举就是从 tickElection() 开始的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>raft</span><span class=p>)</span> <span class=nf>tickElection</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>electionElapsed</span><span class=o>++</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nf>promotable</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nf>pastElectionTimeout</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>r</span><span class=p>.</span><span class=nx>electionElapsed</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Message</span><span class=p>{</span><span class=nx>From</span><span class=p>:</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>Type</span><span class=p>:</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>MsgHup</span><span class=p>});</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>r</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Debugf</span><span class=p>(</span><span class=s>&#34;error occurred during election: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>raft</span><span class=p>)</span> <span class=nf>Step</span><span class=p>(</span><span class=nx>m</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Message</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>MsgHup</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>r</span><span class=p>.</span><span class=nf>hup</span><span class=p>(</span><span class=nx>campaignElection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>raft</span><span class=p>)</span> <span class=nf>campaign</span><span class=p>(</span><span class=nx>t</span> <span class=nx>CampaignType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>id</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ids</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>r</span><span class=p>.</span><span class=nf>send</span><span class=p>(</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Message</span><span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nx>Term</span><span class=p>:</span> <span class=nx>term</span><span class=p>,</span> <span class=nx>To</span><span class=p>:</span> <span class=nx>id</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>             <span class=nx>Type</span><span class=p>:</span> <span class=nx>voteMsg</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>             <span class=nx>Index</span><span class=p>:</span> <span class=nx>r</span><span class=p>.</span><span class=nx>raftLog</span><span class=p>.</span><span class=nf>lastIndex</span><span class=p>(),</span> 
</span></span><span class=line><span class=cl>             <span class=nx>LogTerm</span><span class=p>:</span> <span class=nx>r</span><span class=p>.</span><span class=nx>raftLog</span><span class=p>.</span><span class=nf>lastTerm</span><span class=p>(),</span> <span class=nx>Context</span><span class=p>:</span> <span class=nx>ctx</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以看到，candidate 发起的 <code>投票请求</code> 所包含的信息与论文 3.4 的 <code>RequestVote RPC</code> 所示一样。</p><p><img loading=lazy src=/image/2022/raft-request-vote.png alt=raft-request-vote></p><p>那么，其他节点处理投票请求的地方在哪呢？ 在 <code>raft.Step()</code>，而不是在具体的 r.step() 函数指针指向的 follower, leader 各自的 step 函数。</p><p>由此可见，raft.Step() 首先对收到的 message 做一些基本的检查，比如比较消息的 Term 和 节点的 term 大小关系，然后做一些基本的操作，最后再调用 各个role 自己的 step 函数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>raft</span><span class=p>)</span> <span class=nf>Step</span><span class=p>(</span><span class=nx>m</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Message</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>MsgVote</span><span class=p>,</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>MsgPreVote</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>canVote</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>raftLog</span><span class=p>.</span><span class=nf>isUpToDate</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Index</span><span class=p>,</span> <span class=nx>m</span><span class=p>.</span><span class=nx>LogTerm</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>r</span><span class=p>.</span><span class=nf>send</span><span class=p>(</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Message</span><span class=p>{</span><span class=nx>To</span><span class=p>:</span> <span class=nx>m</span><span class=p>.</span><span class=nx>From</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>             <span class=nx>Term</span><span class=p>:</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>             <span class=nx>Type</span><span class=p>:</span> <span class=nf>voteRespMsgType</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Type</span><span class=p>)})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Type</span> <span class=o>==</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>MsgVote</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Only record real votes.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>r</span><span class=p>.</span><span class=nx>electionElapsed</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>				<span class=nx>r</span><span class=p>.</span><span class=nx>Vote</span> <span class=p>=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>From</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			  <span class=c1>// r.lead leader 的 id 不是在回复投票的时候设置的
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 而是在收到 append,heartbeat 的时候顺便设置的。
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=p>}</span>
</span></span></code></pre></div><p>最后，candidate 就在 <code>raft.stepCandidate()</code>函数中调用 becomeLeader() 切换成 leader，并且开始发送 append 信息。</p><h3 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h3><ol><li><a href=https://www.cnblogs.com/ricklz/p/15155095.html>https://www.cnblogs.com/ricklz/p/15155095.html</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://runzhen.github.io/tags/raft/>Raft</a></li></ul><nav class=paginav><a class=prev href=https://runzhen.github.io/posts/etcd-raft-raftlog/><span class=title>« Prev</span><br><span>etcd-raft 源码阅读之 raftLog</span>
</a><a class=next href=https://runzhen.github.io/posts/ocsp-verify-certificate/><span class=title>Next »</span><br><span>记一次 cert chain 乱序导致 OCSP 验证失败</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share etcd-raft 源码阅读之 Leader 的选举 on x" href="https://x.com/intent/tweet/?text=etcd-raft%20%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e4%b9%8b%20Leader%20%e7%9a%84%e9%80%89%e4%b8%be&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fetcd-raft-leader-election%2f&amp;hashtags=raft"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share etcd-raft 源码阅读之 Leader 的选举 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fetcd-raft-leader-election%2f&amp;title=etcd-raft%20%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e4%b9%8b%20Leader%20%e7%9a%84%e9%80%89%e4%b8%be&amp;summary=etcd-raft%20%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e4%b9%8b%20Leader%20%e7%9a%84%e9%80%89%e4%b8%be&amp;source=https%3a%2f%2frunzhen.github.io%2fposts%2fetcd-raft-leader-election%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share etcd-raft 源码阅读之 Leader 的选举 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frunzhen.github.io%2fposts%2fetcd-raft-leader-election%2f&title=etcd-raft%20%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e4%b9%8b%20Leader%20%e7%9a%84%e9%80%89%e4%b8%be"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share etcd-raft 源码阅读之 Leader 的选举 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frunzhen.github.io%2fposts%2fetcd-raft-leader-election%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share etcd-raft 源码阅读之 Leader 的选举 on whatsapp" href="https://api.whatsapp.com/send?text=etcd-raft%20%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e4%b9%8b%20Leader%20%e7%9a%84%e9%80%89%e4%b8%be%20-%20https%3a%2f%2frunzhen.github.io%2fposts%2fetcd-raft-leader-election%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share etcd-raft 源码阅读之 Leader 的选举 on telegram" href="https://telegram.me/share/url?text=etcd-raft%20%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e4%b9%8b%20Leader%20%e7%9a%84%e9%80%89%e4%b8%be&amp;url=https%3a%2f%2frunzhen.github.io%2fposts%2fetcd-raft-leader-election%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share etcd-raft 源码阅读之 Leader 的选举 on ycombinator" href="https://news.ycombinator.com/submitlink?t=etcd-raft%20%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e4%b9%8b%20Leader%20%e7%9a%84%e9%80%89%e4%b8%be&u=https%3a%2f%2frunzhen.github.io%2fposts%2fetcd-raft-leader-election%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://runzhen.github.io/>Mind in the Wind</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>